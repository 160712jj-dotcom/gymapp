<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>GymApp - Tu Entrenador Personal</title>
    <!-- METADATOS PWA REQUERIDOS -->
    <meta name="theme-color" content="#1a202c">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GymApp">
    <!-- ICONOS PARA PWA -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icon-512x512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192x192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #f7fafc;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: #1f2937;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
        }
        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #f9fafb;
            font-size: 1.5rem;
            font-weight: bold;
        }
        /* Estilos para el modal en dispositivos móviles */
        .modal-overlay {
            display: none;
            background-color: rgba(0, 0, 0, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            inset: 0;
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .advanced-menu:not(.show) {
            display: none !important;
        }
        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-container {
            width: 100%;
            max-width: 100%;
            max-height: 90vh;
            overflow: auto;
            background: #1f2937;
            border-radius: 12px;
            padding: 1rem;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-overlay.active .modal-container {
            transform: translateY(0);
            opacity: 1;
        }
        .max-h-90vh {
            max-height: 90vh;
        }
        .bg-gray-750 {
            background-color: #374151;
        }
        .level-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }
        .level-card.selected {
            border-color: #48bb78;
        }
        .muscle-card {
            transition: all 0.2s ease;
        }
        .muscle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .muscle-card.selected {
            box-shadow: 0 0 0 3px #4299e1;
            border: 2px solid #48bb78;
            background-color: #374151;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .exercise-item {
            transition: all 0.2s ease;
        }
        .exercise-item:hover {
            transform: translateX(5px);
        }
        .set-input {
            width: 60px;
            text-align: center;
        }
        .exercise-list::-webkit-scrollbar {
            width: 6px;
        }
        .exercise-list::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        .exercise-list::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        .exercise-list::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        .muscle-fatigue-bar {
            height: 8px;
            border-radius: 4px;
        }
        .scientific-note {
            background: rgba(66, 153, 225, 0.1);
            border-left: 4px solid #4299e1;
            padding: 12px;
            border-radius: 4px;
            margin-top: 12px;
            font-size: 0.875rem;
        }
        .series-badge {
            display: inline-block;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #4a5568;
            color: white;
            text-align: center;
            line-height: 28px;
            font-size: 0.75rem;
            margin: 0 2px;
            cursor: pointer;
        }
        .series-badge.selected {
            background: #4299e1;
        }
        .exercise-description {
            font-size: 0.75rem;
            color: #d1d5db;
            margin-top: 4px;
            padding-left: 28px;
            word-break: break-word;
        }
        .history-item {
            transition: all 0.2s ease;
            border-left: 4px solid #4299e1;
        }
        .history-item:hover {
            transform: translateX(5px);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .evolution-card {
            transition: all 0.3s ease;
        }
        .evolution-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .metric-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .metric-btn {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .metric-btn.active {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.05);
        }
        .metric-btn:not(.active) {
            background-color: #4b5563;
            color: #d1d5db;
        }
        .progress-indicator {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
        }
        .progress-text {
            margin-left: 0.5rem;
            font-size: 0.875rem;
        }
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            margin-left: 0.5rem;
            font-size: 0.875rem;
        }
        .trend-up {
            color: #10b981;
        }
        .trend-down {
            color: #ef4444;
        }
        .trend-neutral {
            color: #6b7280;
        }
        .previous-results {
            background: rgba(101, 163, 13, 0.1);
            border-left: 4px solid #65a30d;
            padding: 10px;
            border-radius: 4px;
            margin-top: 8px;
        }
        .chart-tab {
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            text-align: center;
        }
        .chart-tab.active {
            background-color: #4299e1;
            color: white;
        }
        .chart-tab:not(.active) {
            background-color: #4b5563;
            color: #d1d5db;
        }
        .workout-exercise {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .workout-exercise.active {
            border-left-color: #4299e1;
            background-color: rgba(66, 153, 225, 0.1);
        }
        .workout-exercise.completed {
            border-left-color: #48bb78;
            opacity: 0.8;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .truncate-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .wrap-text {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .previous-data {
            background: rgba(101, 163, 13, 0.1);
            border-left: 4px solid #65a30d;
            padding: 8px;
            border-radius: 4px;
            margin-top: 4px;
            font-size: 0.75rem;
        }
        .delete-btn {
            transition: all 0.2s ease;
        }
        .delete-btn:hover {
            color: #f56565;
            transform: scale(1.1);
        }
        .summary-card {
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px -5px rgba(0, 0, 0, 0.2);
        }

        .fixed-bottom-button {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .fixed-bottom-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .progress-bar-stats {
            height: 8px;
            border-radius: 4px;
            background: #4a5568;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        /* Mejoras para móviles */
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .modal-container {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }
        @media (max-width: 640px) {
            .button-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            .button-group button {
                width: 100%;
                justify-content: center;
            }
        }

        .routine-card {
            transition: all 0.3s ease;
        }
        .routine-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Efecto de elevación en tarjetas */
            .card-hover {
                transition: all 0.3s ease;
        }
            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }
        /* Mejora para los botones de días */
            .day-button {
                transition: all 0.2s ease;
        }
            .day-button:hover {
                transform: scale(1.05);
        }
        .flex.space-x-4 > * {
            margin-right: 1rem;
        }
        .flex.space-x-4 > *:last-child {
            margin-right: 0;
        }
        /* Loading spinner */
            .spinner {
                border: 2px solid #f3f3f3;
                border-top: 2px solid #4299e1;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay.active,
        .modal-overlay[x-cloak="false"] { /* .active para compatibilidad con el código CSS existente */
        display: flex;
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Estilos para el botón flotante */
        .floating-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border: none;
        }
        .floating-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            background: linear-gradient(135deg, #2563eb, #1e40af);
        }
        /* Mejoras para móviles */
        @media (max-width: 640px) {
            .modal-container {
                margin: 1rem;
                width: calc(100% - 2rem);
            }
        }
        /* Estilos para el menú avanzado */
        .advanced-menu {
            position: fixed;
            bottom: 90px;
            right: 24px;
            background: #2d3748;
            border-radius: 12px;
            padding: 12px;
            width: 220px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 999;
            border: 1px solid #4a5568;
            display: none;
        }
        .advanced-menu.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }
        .advanced-menu-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            color: #e2e8f0;
            font-size: 0.9rem;
        }
        .advanced-menu-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1rem;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .advanced-menu-item:hover {
            background: #4a5568;
        }
        
        [x-cloak] {
            display: none !important;
        }
        .evolution-metric-btn {
            transition: all 0.2s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            text-align: center;
        }
        .evolution-metric-btn.active {
            background-color: #3b82f6;
            color: white;
            transform: scale(1.05);
        }
        .evolution-metric-btn:not(.active) {
            background-color: #4b5563;
            color: #d1d5db;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .small-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }
        /* AÑADIR estos estilos al section <style> */
        .workout-muscle-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .muscle-exercise-container {
            display: flex;
            flex-direction: column;
        }

        /* Scroll suave para mejor experiencia */
        .container {
            scroll-behavior: smooth;
        }
        .workout-exercise[data-muscle-index="0"] {
            border-left: 4px solid #48bb78 !important;
        }

        .workout-exercise[data-muscle-index="1"] {
            border-left: 4px solid #3b82f6 !important;
        }

        .workout-exercise[data-muscle-index="2"] {
            border-left: 4px solid #8b5cf6 !important;
        }

        /* Efecto de pulso para ejercicio activo */
        .workout-exercise.active-exercise {
            animation: pulseActive 2s infinite;
        }

        .workout-exercise:first-of-type {
            border-left: 4px solid #48bb78 !important;
            background: rgba(72, 187, 120, 0.05);
        }
        /* Estilos adicionales para mejorar la visualización en móviles */
        @media (max-width: 640px) {
            .routine-card {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            .routine-card .flex-1 {
                width: 100% !important;
                margin-top: 0.5rem !important;
            }

            /* Mejorar visualización de checkboxes */
            .routine-card input[type="checkbox"] {
                margin-right: 0 !important;
                margin-bottom: 0.5rem !important;
            }
                .muscle-card {
                padding: 0.75rem;
                min-height: 60px;
            }

            /* Mejorar el grid para móviles muy pequeños */
            @media (max-width: 380px) {
                .grid.grid-cols-2 {
                    grid-template-columns: 1fr;
                    gap: 0.5rem;
                }
                .muscle-card {
                    min-height: 50px;
                }
            }
        /* Mejoras generales para el modal */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #374151;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #f9fafb;
        }
        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 1.5rem;
        }
        .modal-close:hover {
            color: #f3f4f6;
        }
        .modal-section {
            margin-bottom: 1.5rem;
        }
        .modal-section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #e5e7eb;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #374151;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .routine-item:last-child {
            margin-bottom: 0;
        }

        .routine-content {
            flex-grow: 1;
        }
        .routine-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        .routine-details {
            display: flex;
            justify-content: space-between;
            color: #9ca3af;
            font-size: 0.875rem;
        }
        .routine-meta {
            text-align: right;
        }
        /* Mejoras para los botones */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #374151;
        }

        .mode-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .mode-btn:not(.active) {
            background-color: #4b5563;
            color: #d1d5db;
        }

        .instructions ul {
            padding-left: 1.5rem;
            margin-top: 0.5rem;
        }
        .instructions li {
            margin-bottom: 0.25rem;
        }

        @keyframes pulseActive {
            0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(72, 187, 120, 0); }
            100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
        }
        /* Estilos para el botón Completar modificado */
        .complete-btn.completed {
            background-color: #1e40af !important;
            border-color: #1e3a8a !important;
            color: white !important;
            cursor: default !important;
        }

        .complete-btn.completed .btn-text {
            content: "Completado" !important;
        }

        .complete-btn.completed:hover {
            background-color: #1e40af !important;
            transform: none !important;
        }
        /* ESTILOS PARA BOTÓN COMPLETAR MODIFICADO */
        .complete-btn.completed,
        .complete-btn[data-set-completed="true"] {
            background-color: #1e40af !important;
            border: 2px solid #1e3a8a !important;
            color: white !important;
            cursor: default !important;
            transform: none !important;
            box-shadow: 0 2px 4px rgba(30, 64, 175, 0.3) !important;
        }

        .complete-btn.completed:hover,
        .complete-btn[data-set-completed="true"]:hover {
            background-color: #1e40af !important;
            transform: none !important;
            box-shadow: 0 2px 6px rgba(30, 64, 175, 0.4) !important;
        }

        /* Asegurar que el texto sea visible */
        .complete-btn .btn-text {
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Estado inicial del botón */
        .complete-btn:not(.completed):not([data-set-completed="true"]) {
            background-color: #059669 !important;
            border: 2px solid #047857 !important;
        }

        .complete-btn:not(.completed):not([data-set-completed="true"]):hover {
            background-color: #10b981 !important;
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="text-gray-100">
    <main x-data="gymApp()" x-init="init()">
        <!-- Pantalla de selección de modo -->
        <div x-show="currentScreen === 'mode-selection'" x-transition:enter.duration.300 class="container mx-auto px-4 py-8 max-w-6xl">
            <div class="flex justify-start mb-6">
            </div>
            <!-- Botón flotante de menú avanzado -->
            <div class="fixed bottom-6 right-6 z-50">
                <div class="relative">
                    <button @click="toggleAdvancedMenu()" class="floating-button" :class="{ 'bg-blue-700': showAdvancedMenu }">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="advanced-menu" :class="{ 'show': showAdvancedMenu }">
                        <div class="advanced-menu-item" @click="exportData()">
                            <i class="fas fa-file-export text-green-400"></i>
                            <span>Exportar Datos</span>
                        </div>
                        <div class="advanced-menu-item" @click="importData()">
                            <i class="fas fa-file-import text-blue-400"></i>
                            <span>Importar Datos</span>
                        </div>
                        <div class="advanced-menu-item" @click="regenerateDefaultData()">
                            <i class="fas fa-redo text-purple-400"></i>
                            <span>Regenerar Ejercicios</span>
                        </div>
                        <div class="advanced-menu-item" @click="resetApp()">
                            <i class="fas fa-trash text-red-400"></i>
                            <span>Restablecer App</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold mb-3 bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">GymApp</h1>
            </header>
            
            <!-- SECCIÓN ESTADO ACTUAL SIMPLIFICADA - SOLO EL CUADRO -->
            <div class="bg-gray-750 p-4 rounded-lg max-w-md mx-auto mb-8">
                <div class="text-blue-400 text-xl mb-2">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h5 class="font-medium text-white mb-2">Estado Actual</h5>
                <div class="text-sm text-gray-300 space-y-1">
                    <div class="flex justify-between">
                        <span>Total entrenamientos:</span>
                        <span class="font-semibold" x-text="getHistoryStats().total"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>En rutinas:</span>
                        <span class="font-semibold text-green-400" 
                            x-text="getHistoryStats().inRoutines"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Sueltos disponibles:</span>
                        <span class="font-semibold text-blue-400" 
                            x-text="getHistoryStats().solo"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Rutinas creadas:</span>
                        <span class="font-semibold text-purple-400" 
                            x-text="getHistoryStats().routineGroups"></span>
                    </div>
                </div>
            </div>
            
            <!-- CONTENEDOR DE LOS DOS BOTONES PRINCIPALES -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-8">
                <!-- Botón CREAR ENTRENAMIENTO MANUAL -->
                <div class="level-card bg-gray-700 p-6 md:p-8 rounded-xl cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2 border-blue-500"
                    @click="currentScreen = 'level'">
                    <div class="text-5xl mb-5 text-blue-400"><i class="fas fa-dumbbell"></i></div>
                    <h3 class="text-xl font-semibold mb-3 text-white">Crear Entrenamiento Manual</h3>
                    <p class="text-gray-400 mb-4">Configura tu entrenamiento personalizado seleccionando ejercicios y grupos musculares.</p>
                    <div class="text-sm text-blue-300 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> Total control sobre tu rutina
                    </div>
                </div>
                
                <!-- Botón RECUPERAR HISTORIAL -->
                <div class="level-card bg-gray-700 p-6 md:p-8 rounded-xl cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2 border-green-500"
                    @click="currentScreen = 'history-selection'">
                    <div class="text-5xl mb-5 text-green-400"><i class="fas fa-history"></i></div>
                    <h3 class="text-xl font-semibold mb-3 text-white">Recuperar Historial</h3>
                    <p class="text-gray-400 mb-4">Usa entrenamientos anteriores como plantilla para nuevos entrenamientos.</p>
                    <div class="text-sm text-green-300 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> Reutiliza rutinas anteriores
                    </div>
                </div>
            </div>
            <!-- BOTÓN VOLVER AL INICIO PRINCIPAL EN LA PARTE INFERIOR - NUEVO -->
            <div class="flex justify-center mt-10 pt-6 border-t border-gray-700">
                <button onclick="window.location.href = '../index.html'" 
                        class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition flex items-center text-lg font-medium">
                    <i class="fas fa-home mr-3"></i> Volver al Inicio Principal
                </button>
            </div>
        </div>

        <!-- ================================================== -->
        <!-- PANTALLA DE SELECCIÓN DE TIPO DE HISTORIAL - COMPLETA -->
        <!-- ================================================== -->
        <div x-show="currentScreen === 'history-selection'" x-transition:enter.duration.300 x-transition:leave.duration.300>
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-2 text-white">Recuperar de Historial</h2>
                <p class="text-gray-400">¿Qué tipo de historial quieres ver?</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-10">
                <!-- Ejercicios Sueltos -->
                <div class="level-card bg-gray-700 p-6 md:p-8 rounded-xl cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2 border-blue-500"
                    @click="viewAllHistory()">
                    <div class="text-5xl mb-5 text-blue-400"><i class="fas fa-dumbbell"></i></div>
                    <h3 class="text-xl font-semibold mb-3 text-white">Ejercicios en Ejecución</h3>
                    <div class="text-sm text-blue-300 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> Ver historial completo de ejercicios en ejecución
                    </div>
                </div>
                
                <!-- Grupos de Trabajo -->
                <div class="level-card bg-gray-700 p-6 md:p-8 rounded-xl cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2 border-green-500"
                    @click="currentScreen = 'workout-groups'">
                    <div class="text-5xl mb-5 text-green-400"><i class="fas fa-layer-group"></i></div>
                    <h3 class="text-xl font-semibold mb-3 text-white">Rutinas Guardadas</h3>
                    <div class="text-sm text-green-300 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> Rutinas guardadas
                    </div>
                </div>
            </div>

            <!-- BOTÓN VOLVER EN LA PARTE INFERIOR CENTRADO - NUEVA POSICIÓN -->
            <div class="flex justify-center mt-8 pt-6 border-t border-gray-700">
                <button @click="currentScreen = 'mode-selection'" 
                        class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition flex items-center text-lg font-medium">
                    <i class="fas fa-arrow-left mr-3"></i> Volver
                </button>
            </div>
        </div>

        <!-- Pantalla de grupos de trabajo -->
        <div x-show="currentScreen === 'workout-groups'" x-transition:enter.duration.300 x-transition:leave.duration.300>
            <!-- Encabezado simplificado -->
            <div class="mb-6">
                <div>
                    <h2 class="text-2xl font-bold mb-2 text-white">Grupos de Trabajo</h2>
                    <p class="text-gray-400" x-text="editingWorkoutGroup ? 'Modo edición - ' + editingWorkoutGroup.name : 'Rutinas semanales agrupadas'"></p>
                </div>
            </div>

            <div class="bg-gray-800 rounded-2xl shadow-xl p-6">
                <div class="text-center py-10" x-show="workoutGroups.length === 0">
                    <div class="text-5xl mb-4 text-gray-500"><i class="fas fa-layer-group"></i></div>
                    <h3 class="text-xl font-semibold mb-2 text-white">No hay rutinas guardadas</h3>
                    <p class="text-gray-400 mb-4">Crea tu primera rutina desde el historial de ejercicios.</p>
                </div>

                <!-- LISTA DE RUTINAS AGRUPADAS POR TIPO DE ENTRENAMIENTO -->
                <div class="space-y-4" x-show="workoutGroups.length > 0">
                    <template x-for="(group, index) in workoutGroups" :key="group.id">
                        <div class="bg-gray-700 rounded-xl p-5 transition-all duration-300 hover:transform hover:scale-105">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg text-white mb-1" x-text="group.name"></h4>
                                    <div class="text-sm text-gray-400">
                                        <span x-text="'Creada: ' + formatDateShort(group.creationDate)"></span>
                                        <span class="ml-3 text-blue-400" x-text="getUniqueRoutinesCount(group) + ' tipos de entrenamiento'"></span>
                                        <span class="ml-3 text-green-400" x-text="group.workouts.length + ' sesiones totales'"></span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click="loadWorkoutGroup(group)" 
                                            class="p-2 bg-blue-600 rounded-lg hover:bg-blue-500 transition"
                                            title="Ver detalles de la rutina">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button @click="editWorkoutGroup(group.id)" 
                                            class="p-2 bg-yellow-600 rounded-lg hover:bg-yellow-500 transition"
                                            title="Editar rutina">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click="deleteWorkoutGroup(group.id)" 
                                            class="p-2 bg-red-600 rounded-lg hover:bg-red-500 transition"
                                            title="Eliminar rutina">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- GRUPOS DE EJERCICIOS (POR RUTINA) -->
                            <div class="space-y-3 mt-4">
                                <template x-for="routineGroup in getRoutineGroupsForWorkoutGroup(group)" :key="routineGroup.routineKey">
                                    <div class="bg-gray-800 rounded-lg p-3 border-l-4 border-blue-500">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <h5 class="font-medium text-white text-sm mb-1" 
                                                    x-text="getWorkoutTitleFromWorkout(routineGroup.representative)"></h5>
                                                <div class="text-xs text-gray-400">
                                                    <span x-text="routineGroup.count + ' veces realizado'"></span>
                                                    <span class="ml-2 text-blue-400" x-text="routineGroup.representative.exercises + ' ejercicios'"></span>
                                                    <span class="ml-2 text-green-400" x-text="routineGroup.representative.sets + ' series'"></span>
                                                </div>
                                                <!-- Músculos trabajados -->
                                                <div class="mt-2 flex flex-wrap gap-1">
                                                    <template x-for="muscle in getWorkoutMusclesFromWorkout(routineGroup.representative)" :key="muscle.key">
                                                        <span class="text-xs px-2 py-1 rounded-full flex items-center"
                                                            :class="muscle.color + ' bg-opacity-20 text-white'">
                                                            <div class="w-2 h-2 rounded-full mr-1" :class="muscle.color"></div>
                                                            <span x-text="muscle.label"></span>
                                                        </span>
                                                    </template>
                                                </div>
                                            </div>
                                            <div class="text-right text-xs">
                                                <div class="text-white" x-text="formatTime(routineGroup.representative.time)"></div>
                                                <div class="text-blue-400 mt-1" x-text="routineGroup.representative.totalVolume + ' kg'"></div>
                                                <div class="text-green-400 mt-1" 
                                                    x-text="routineGroup.representative.completedSets + '/' + routineGroup.representative.sets + ' series'"></div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- BOTONES VOLVER Y NUEVA RUTINA EN LA PARTE INFERIOR CENTRADOS - NUEVA POSICIÓN -->
            <div class="flex justify-center gap-4 mt-10 pt-6 border-t border-gray-700">
                <button @click="currentScreen = 'history-selection'" 
                        class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition flex items-center text-lg font-medium">
                    <i class="fas fa-arrow-left mr-3"></i> Volver
                </button>
                
                <button @click="openCreateWorkoutGroupModal()" 
                        class="px-6 py-3 bg-green-600 rounded-lg hover:bg-green-500 transition flex items-center text-lg font-medium"
                        :disabled="editingWorkoutGroup">
                    <i class="fas fa-plus mr-3"></i> Nueva Rutina
                </button>
            </div>
        </div> 
        <!-- Pantalla de detalles de rutina de trabajo -->
        <div x-show="currentScreen === 'workout-group-details'" x-transition:enter.duration.300 x-transition:leave.duration.300>
            <!-- Encabezado simplificado -->
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-2 text-white" x-text="currentWorkoutGroup?.name"></h2>
                <p class="text-gray-400" x-text="'Creada: ' + formatDateShort(currentWorkoutGroup?.creationDate)"></p>
            </div>

            <div class="space-y-4">
                <template x-for="(group, index) in getGroupedWorkoutsForGroup()" :key="group.routineKey">
                    <div class="bg-gray-700 rounded-xl p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h4 class="font-semibold text-lg text-white" x-text="getWorkoutTitleFromWorkout(group.representative)"></h4>
                                <div class="text-sm text-gray-400 mt-1">
                                    <span x-text="'Última ejecución: ' + formatDate(group.latestDate)"></span>
                                    <span class="ml-3 text-green-400" x-text="group.representative.exercises + ' ejercicios'"></span>
                                </div>
                                <!-- Músculos trabajados -->
                                <div class="mt-2 flex flex-wrap gap-1">
                                    <template x-for="muscle in getWorkoutMusclesFromWorkout(group.representative)" :key="muscle.key">
                                        <span class="text-xs px-2 py-1 rounded-full flex items-center"
                                            :class="muscle.color + ' bg-opacity-20 text-white'">
                                            <div class="w-2 h-2 rounded-full mr-1" :class="muscle.color"></div>
                                            <span x-text="muscle.label"></span>
                                        </span>
                                    </template>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-white" x-text="formatTime(group.representative.time)"></div>
                                <div class="text-xs text-blue-400 mt-1" x-text="group.representative.totalVolume + ' kg'"></div>
                                <div class="text-xs text-green-400 mt-1" 
                                    x-text="group.representative.completedSets + '/' + group.representative.sets + ' series'"></div>
                            </div>
                        </div>
                        
                        <!-- Estadísticas del grupo -->
                        <div class="bg-gray-800 rounded-lg p-3 mb-4">
                            <div class="grid grid-cols-3 gap-2 text-center">
                                <div>
                                    <div class="text-lg font-bold text-white" x-text="group.count"></div>
                                    <div class="text-xs text-gray-400">Veces realizado</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-blue-400" 
                                        x-text="calculateGroupVolume(group.workoutIndices) + ' kg'"></div>
                                    <div class="text-xs text-gray-400">Volumen promedio</div>
                                </div>
                                <div>
                                    <div class="text-lg font-bold text-green-400" 
                                        x-text="calculateGroupCompletion(group.workoutIndices) + '%'"></div>
                                    <div class="text-xs text-gray-400">Tasa de completado</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- BOTONES DE ACCIÓN - MOVIDOS AQUÍ -->
                        <div class="grid grid-cols-2 gap-2 pt-4 border-t border-gray-600">
                            <button @click="viewWorkoutInGroup(group.workoutIndices[0])" 
                                    class="px-2 py-2 bg-blue-600 rounded text-sm hover:bg-blue-500 transition text-white flex items-center justify-center">
                                <i class="fas fa-eye mr-1"></i> Ver
                            </button>
                            <button @click="removeWorkoutGroupFromRoutine(currentWorkoutGroup.id, group.workoutIndices)" 
                                    class="px-2 py-2 bg-red-600 rounded text-sm hover:bg-red-500 transition text-white flex items-center justify-center">
                                <i class="fas fa-times mr-1"></i> Quitar
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- BOTONES PRINCIPALES - SOLO BOTÓN VOLVER MÁS OSCURO -->
            <div class="mt-8 pt-6 border-t border-gray-700 bg-gray-750 rounded-xl p-6">
                <div class="flex flex-col md:flex-row justify-between gap-4">
                    <button @click="currentScreen = 'workout-groups'" 
                            class="px-6 py-3 bg-gray-800 rounded-lg hover:bg-gray-700 transition flex items-center justify-center font-medium text-white">
                        <i class="fas fa-arrow-left mr-2"></i> Volver
                    </button>
                    
                    <div class="flex flex-col md:flex-row gap-4">
                        <button @click="editWorkoutGroup(currentWorkoutGroup.id)" 
                                class="px-6 py-3 bg-yellow-600 rounded-lg hover:bg-yellow-500 transition flex items-center justify-center font-medium text-white">
                            <i class="fas fa-edit mr-2"></i> Editar
                        </button>
                        <button @click="deleteWorkoutGroup(currentWorkoutGroup.id)" 
                                class="px-6 py-3 bg-red-600 rounded-lg hover:bg-red-500 transition flex items-center justify-center font-medium text-white">
                            <i class="fas fa-trash mr-2"></i> Eliminar 
                        </button>
                    </div>
                </div>
            </div>
        </div>     
        <!-- Pantalla de Evolución -->
        <div x-show="currentScreen === 'evolution'" x-transition:enter.duration.300 x-transition:leave.duration.300>
            <h2 class="text-2xl font-bold mb-2">Evolución y Progreso</h2>
            <p class="text-gray-400 mb-6">Analiza tu progreso a lo largo del tiempo</p>
            <!-- Selector de métricas -->
            <div class="bg-gray-700 rounded-xl p-5 mb-6">
                <h3 class="text-lg font-semibold mb-4">Selecciona Métrica a Visualizar</h3>
                <div class="metric-selector">
                    <div class="chart-tab" 
                        :class="{'active': selectedMetric === 'volume'}"
                        @click="changeMetric('volume')">
                        <i class="fas fa-weight-hanging mr-1"></i> Volumen Total
                    </div>
                    <div class="chart-tab" 
                        :class="{'active': selectedMetric === 'weight'}"
                        @click="changeMetric('weight')">
                        <i class="fas fa-dumbbell mr-1"></i> Peso Máximo
                    </div>
                    <div class="chart-tab" 
                        :class="{'active': selectedMetric === 'reps'}"
                        @click="changeMetric('reps')">
                        <i class="fas fa-redo mr-1"></i> Repeticiones
                    </div>
                    <div class="chart-tab" 
                        :class="{'active': selectedMetric === 'consistency'}"
                        @click="changeMetric('consistency')">
                        <i class="fas fa-calendar-check mr-1"></i> Consistencia
                    </div>
                </div>
            </div>
            <!-- Filtros -->
            <div class="bg-gray-700 rounded-xl p-5 mb-6">
                <h3 class="text-lg font-semibold mb-4">Filtrar Datos</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Filtrar por:</label>
                        <select class="w-full bg-gray-600 rounded-lg px-4 py-2 border border-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                x-model="evolutionFilter"
                                @change="changeEvolutionFilter($event.target.value)">
                            <option value="all">Todos los entrenamientos</option>
                            <template x-for="muscle in muscleGroups" :key="muscle.key">
                                <option :value="'muscle_' + muscle.key" x-text="'Solo ' + muscle.label"></option>
                            </template>
                            <option value="specific">Ejercicio específico</option>
                        </select>
                    </div>
                    <div x-show="evolutionFilter === 'specific'">
                        <label class="block text-sm font-medium mb-2">Seleccionar ejercicio:</label>
                        <select class="w-full bg-gray-600 rounded-lg px-4 py-2 border border-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                x-model="selectedExercise"
                                @change="updateChart()">
                            <option value="">Seleccionar ejercicio</option>
                            <template x-for="exercise in getAllUniqueExercises()" :key="exercise">
                                <option :value="exercise" x-text="exercise"></option>
                            </template>
                        </select>
                        <div class="text-xs text-gray-400 mt-1" x-text="'Total ejercicios: ' + getAllUniqueExercises().length"></div>
                    </div>
                </div>
            </div>
            <!-- Gráfico de evolución -->
            <div class="bg-gray-700 rounded-xl p-5 mb-6">
                <h3 class="text-lg font-semibold mb-4">Progreso en el Tiempo</h3>
                <div class="chart-container">
                    <canvas id="evolutionChart"></canvas>
                </div>
                <!-- Resumen de progreso -->
                <div class="mt-6 stats-grid" x-show="workoutHistory.length > 0">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm">Valor actual:</span>
                            <span class="font-semibold" x-text="calculateProgress().current + (selectedMetric === 'consistency' ? '%' : '')"></span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm">Mejor valor:</span>
                            <span class="font-semibold" x-text="calculateProgress().best + (selectedMetric === 'consistency' ? '%' : '')"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Progreso:</span>
                            <span class="font-semibold" 
                                :class="{
                                    'trend-up': calculateProgress().progress > 0,
                                    'trend-down': calculateProgress().progress < 0,
                                    'trend-neutral': calculateProgress().progress === 0
                                }"
                                x-text="(calculateProgress().progress > 0 ? '+' : '') + calculateProgress().progress + '%'"></span>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm">Entrenamientos:</span>
                            <span class="font-semibold" x-text="workoutHistory.length"></span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm">Período:</span>
                            <span class="font-semibold" x-text="getTrainingPeriod()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">Consistencia:</span>
                            <span class="font-semibold" x-text="calculateProgress().consistency + '%'"></span>
                        </div>
                    </div>
                </div>
                <div x-show="workoutHistory.length === 0" class="text-center py-8">
                    <div class="text-5xl mb-4 text-gray-500"><i class="fas fa-chart-line"></i></div>
                    <h3 class="text-xl font-semibold mb-2">No hay datos de evolución</h3>
                    <p class="text-gray-400">Completa algunos entrenamientos para ver tu progreso aquí.</p>
                </div>
            </div>
            <!-- Botones de acción -->
            <div class="flex flex-col md:flex-row justify-between gap-3">
                <button @click="goBack()" class="btn-mobile px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                    <i class="fas fa-arrow-left mr-2"></i> Volver
                </button>
                <div class="flex flex-col md:flex-row gap-3">
                    <button @click="exportProgressReport()" 
                            class="btn-mobile px-4 py-2 bg-green-600 rounded-lg hover:bg-green-500 transition"
                            :disabled="workoutHistory.length === 0">
                        <i class="fas fa-file-export mr-2"></i> Exportar Reporte
                    </button>
                    <button @click="updateChart()" 
                            class="btn-mobile px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 transition">
                        <i class="fas fa-sync-alt mr-2"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
        <!-- Contenedor para todas las demás pantallas -->
        <div x-show="currentScreen !== 'mode-selection'" class="container mx-auto px-4 py-8 max-w-6xl">

            <!-- Pantalla de selección de nivel (MODO MANUAL) -->
            <div x-show="currentScreen === 'level'" x-transition:enter.duration.300 x-transition:leave.duration.300 class="text-center">
                <!-- ELIMINADO el botón Volver de la parte superior -->
                
                <h2 class="text-2xl font-bold mb-2">Selecciona tu nivel de experiencia</h2>
                <p class="text-gray-400 mb-8">Basado en el volumen de entrenamiento recomendado por la ciencia</p>
                
                <!-- Grid de niveles -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-10">
                    <!-- Principiante -->
                    <div class="level-card bg-gray-700 p-4 md:p-6 rounded-xl cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2"
                        :class="userLevel === 'beginner' ? 'border-green-500 scale-105 shadow-lg' : 'border-blue-500'"
                        @click="selectLevel('beginner')">
                        <div class="text-5xl mb-4 text-green-400"><i class="fas fa-seedling"></i></div>
                        <h3 class="text-xl font-semibold mb-2 text-white">Principiante</h3>
                        <p class="text-gray-400 text-sm">10-15 series por grupo muscular/semana</p>
                        <p class="text-xs text-green-300 mt-2">Series por ejercicio: 3-4</p>
                        <div class="mt-4 text-xs text-green-400 flex items-center" x-show="userLevel === 'beginner'">
                            <i class="fas fa-check-circle mr-1"></i> Seleccionado
                        </div>
                    </div>
                    
                    <!-- Intermedio -->
                    <div class="level-card bg-gray-700 p-4 md:p-6 rounded-xl cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2"
                        :class="userLevel === 'intermediate' ? 'border-yellow-500 scale-105 shadow-lg' : 'border-blue-500'"
                        @click="selectLevel('intermediate')">
                        <div class="text-5xl mb-4 text-yellow-400"><i class="fas fa-leaf"></i></div>
                        <h3 class="text-xl font-semibold mb-2 text-white">Intermedio</h3>
                        <p class="text-gray-400 text-sm">15-20 series por grupo muscular/semana</p>
                        <p class="text-xs text-yellow-300 mt-2">Series por ejercicio: 3-4</p>
                        <div class="mt-4 text-xs text-yellow-400 flex items-center" x-show="userLevel === 'intermediate'">
                            <i class="fas fa-check-circle mr-1"></i> Seleccionado
                        </div>
                    </div>
                    
                    <!-- Avanzado -->
                    <div class="level-card bg-gray-700 p-4 md:p-6 rounded-xl cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2"
                        :class="userLevel === 'advanced' ? 'border-red-500 scale-105 shadow-lg' : 'border-blue-500'"
                        @click="selectLevel('advanced')">
                        <div class="text-5xl mb-4 text-red-400"><i class="fas fa-fire"></i></div>
                        <h3 class="text-xl font-semibold mb-2 text-white">Avanzado</h3>
                        <p class="text-gray-400 text-sm">20-25 series por grupo muscular/semana</p>
                        <p class="text-xs text-red-300 mt-2">Series por ejercicio: 3-5</p>
                        <div class="mt-4 text-xs text-red-400 flex items-center" x-show="userLevel === 'advanced'">
                            <i class="fas fa-check-circle mr-1"></i> Seleccionado
                        </div>
                    </div>
                </div>
                
                <!-- Mensaje de selección automática -->
                <div x-show="userLevel" class="fade-in mb-4">
                    <p class="text-blue-400"><i class="fas fa-info-circle mr-2"></i> Nivel seleccionado: <span x-text="levelLabels[userLevel]"></span></p>
                    <p class="text-gray-400 text-sm mt-1">Redirigiendo a selección de músculos...</p>
                </div>
                
                <!-- Botón de continuar (solo como respaldo) -->
                <button @click="currentScreen = 'muscles'" 
                        class="px-6 md:px-8 py-3 bg-blue-600 rounded-lg text-lg font-semibold hover:bg-blue-500 transition mb-6"
                        x-show="userLevel">
                    Continuar ahora <i class="fas fa-arrow-right ml-2"></i>
                </button>
                
                <!-- BOTÓN VOLVER EN LA PARTE INFERIOR CENTRADO - NUEVA POSICIÓN -->
                <div class="flex justify-center mt-8 pt-6 border-t border-gray-700">
                    <button @click="currentScreen = 'mode-selection'" 
                            class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition flex items-center text-lg font-medium">
                        <i class="fas fa-arrow-left mr-3"></i> Volver
                    </button>
                </div>
            </div>

            <!-- Pantalla de selección de músculos -->
            <div x-show="currentScreen === 'muscles'" x-transition:enter.duration.300 x-transition:leave.duration.300>
                <h2 class="text-2xl font-bold mb-2">Selecciona los grupos musculares a trabajar</h2>
                <p class="text-gray-400 mb-6" x-text="'Nivel: ' + levelLabels[userLevel]"></p>
                <!-- Grid responsivo para músculos -->
                <div class="grid grid-cols-2 gap-3 mb-6 md:grid-cols-4 md:gap-4">
                    <template x-for="muscle in muscleGroups" :key="muscle.key">
                        <div class="muscle-card bg-gray-700 p-3 md:p-4 rounded-xl cursor-pointer transition-all duration-300 flex items-center"
                            :class="{
                                'selected': selectedMuscles.includes(muscle.key), 
                                'opacity-70': !selectedMuscles.includes(muscle.key)
                            }"
                            @click="toggleMuscleSelection(muscle.key)">
                            <div class="w-4 h-4 rounded-full mr-3" :class="muscle.color"></div>
                            <span class="wrap-text text-sm md:text-base" x-text="muscle.label"></span>
                        </div>
                    </template>
                </div>
                    <!-- Sección de ejercicios personalizados - Ahora debajo del grid -->
                <div class="bg-gray-700 rounded-xl p-4 md:p-5 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-green-400"></i> Ejercicios Personalizados
                    </h3>
                    <div class="space-y-3">
                        <!-- Selección de músculo -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Grupo muscular:</label>
                            <select x-model="newCustomExerciseMuscle" 
                                    class="w-full bg-gray-600 rounded-lg px-4 py-2 border border-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                <option value="">Seleccionar músculo</option>
                                <template x-for="muscle in muscleGroups" :key="muscle.key">
                                    <option :value="muscle.key" x-text="muscle.label"></option>
                                </template>
                                <option value="custom">Crear nuevo grupo muscular</option>
                            </select>
                        </div>
                        <!-- Nombre del ejercicio -->
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre del ejercicio:</label>
                            <input type="text" x-model="newCustomExerciseName" 
                                placeholder="Ej: Press de banca con mancuernas"
                                class="w-full bg-gray-600 rounded-lg px-4 py-2 border border-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        </div>
                        <!-- Campo para nuevo grupo muscular (solo visible cuando se selecciona "Crear nuevo grupo muscular") -->
                        <div x-show="newCustomExerciseMuscle === 'custom'">
                            <label class="block text-sm font-medium mb-2">Nombre del nuevo grupo muscular:</label>
                            <input type="text" x-model="customMuscleName" 
                                placeholder="Ej: Antebrazos, Glúteos, etc."
                                class="w-full bg-gray-600 rounded-lg px-4 py-2 border border-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                        </div>
                        <!-- Botón para añadir -->
                        <button @click="addCustomExercise()" 
                                class="w-full md:w-auto px-4 py-2 bg-green-600 rounded-lg hover:bg-green-500 transition disabled:opacity-50"
                                :disabled="!newCustomExerciseName || !newCustomExerciseMuscle || (newCustomExerciseMuscle === 'custom' && !customMuscleName)">
                            <i class="fas fa-plus mr-1"></i> Añadir Ejercicio Personalizado
                        </button>
                    </div>
                </div>
                <!-- MEJORAR esta sección en la pantalla de músculos -->
                <div class="bg-gray-700 rounded-xl p-4 md:p-5 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-clock mr-2 text-yellow-400"></i> Configuración del Temporizador de Descanso
                    </h3>
                    
                    <!-- ELIMINADO el div duplicado que causaba el problema -->
                    <!-- Configuración del Temporizador - Con Colores de la App -->
                    
                    <!-- Opciones en línea -->
                    <div class="space-y-4">
                        <!-- Temporizador activo -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input type="checkbox" id="restTimerEnabled" class="mr-3 h-5 w-5 text-blue-500 rounded focus:ring-blue-500 focus:ring-2" 
                                    x-model="restTimerConfig.enabled">
                                <label for="restTimerEnabled" class="text-white font-medium flex items-center">
                                    <i class="fas fa-clock text-blue-400 mr-2"></i>
                                    Temporizador
                                </label>
                            </div>
                            <span class="text-sm font-medium px-2 py-1 rounded" 
                                :class="restTimerConfig.enabled ? 'bg-green-500 text-white' : 'bg-gray-600 text-gray-300'"
                                x-text="restTimerConfig.enabled ? 'ON' : 'OFF'"></span>
                        </div>

                        <!-- Sonidos -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input type="checkbox" id="restTimerSound" class="mr-3 h-5 w-5 text-green-500 rounded focus:ring-green-500 focus:ring-2" 
                                    x-model="restTimerConfig.soundEnabled">
                                <label for="restTimerSound" class="text-white font-medium flex items-center">
                                    <i class="fas fa-volume-up text-green-400 mr-2"></i>
                                    Sonidos
                                </label>
                            </div>
                            <span class="text-sm font-medium px-2 py-1 rounded" 
                                :class="restTimerConfig.soundEnabled ? 'bg-green-500 text-white' : 'bg-gray-600 text-gray-300'"
                                x-text="restTimerConfig.soundEnabled ? 'ON' : 'OFF'"></span>
                        </div>
                    </div>

                    <!-- Descanso entre series -->
                    <div x-show="restTimerConfig.enabled" class="mt-4 pt-4 border-t border-gray-600">
                        <label class="block text-sm font-medium mb-3 text-white flex items-center">
                            <i class="fas fa-hourglass-half text-blue-400 mr-2"></i>
                            Descansos
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="range" min="30" max="180" step="15" 
                                class="flex-1 bg-gray-600 rounded-lg accent-blue-500"
                                x-model="restTimerConfig.duration">
                            <input type="number" min="30" max="300" step="15"
                                class="w-20 bg-gray-600 rounded-lg px-2 py-1 text-center border border-gray-500 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                x-model="restTimerConfig.duration">
                            <span class="text-blue-400 font-semibold w-8 text-center">s</span>
                        </div>
                    </div>
                </div>
                <!-- === BOTONES DE NAVEGACIÓN - ESTO ES LO QUE FALTABA === -->
                    <div class="flex justify-between">
                        <button @click="currentScreen = 'level'" class="px-4 md:px-6 py-2 md:py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Volver
                        </button>
                        <button @click="currentScreen = 'exercises'" 
                                class="px-4 md:px-6 py-2 md:py-3 bg-green-600 rounded-lg hover:bg-green-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
                                :disabled="selectedMuscles.length === 0">
                            Seleccionar Ejercicios <i class="fas fa-dumbbell ml-2"></i>
                        </button>
                    </div>
                </div>
            <!-- Pantalla de selección de ejercicios -->
            <div x-show="currentScreen === 'exercises'" x-transition:enter.duration.300 x-transition:leave.duration.300>
            <h2 class="text-2xl font-bold mb-2">Configura tu entrenamiento</h2>
            <p class="text-gray-400 mb-6" x-text="'Nivel: ' + levelLabels[userLevel] + ' - Series por ejercicio: ' + seriesLimits[userLevel].min + '-' + seriesLimits[userLevel].max"></p>
            <!-- Indicador de fatiga general -->
            <div class="bg-gray-700 rounded-xl p-4 md:p-5 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-tachometer-alt mr-2 text-blue-400"></i> Fatiga Muscular General
                </h3>
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Baja</span>
                        <span>Moderada</span>
                        <span>Alta</span>
                        <span>Extrema</span>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-4">
                        <div class="h-4 rounded-full progress-bar" 
                             :class="{
                                'bg-green-500': totalFatigue <= 40,
                                'bg-yellow-500': totalFatigue > 40 && totalFatigue <= 70,
                                'bg-orange-500': totalFatigue > 70 && totalFatigue <= 85,
                                'bg-red-500': totalFatigue > 85
                             }" 
                             :style="'width: ' + totalFatigue + '%'"></div>
                    </div>
                </div>
                <p class="text-sm wrap-text" x-text="totalFatigueMessage"></p>
                <div class="scientific-note">
                    <i class="fas fa-flask mr-1"></i> Basado en el volumen semanal recomendado por la literatura científica para hipertrofia muscular.
                </div>
            </div>
            <template x-for="muscle in selectedMuscles" :key="muscle">
                <div class="mb-6 md:mb-8 bg-gray-700 rounded-xl p-4 md:p-5">
                    <h4 class="font-medium mb-4 text-xl flex items-center">
                        <div class="w-4 h-4 rounded-full mr-3" :class="muscleGroups.find(m => m.key === muscle).color"></div>
                        <span class="wrap-text" x-text="muscleGroups.find(m => m.key === muscle).label"></span>
                        <span class="text-sm text-gray-400 ml-2" x-text="'(' + (selectedExercises[muscle]?.length || 0) + ' ejercicios)'"></span>
                    </h4>
                    <div class="exercise-list max-h-60 overflow-y-auto pr-2 mb-4">
                        <template x-for="exercise in exercisesByMuscle[muscle]" :key="exercise">
                            <!-- En la lista de ejercicios, modifica para añadir botón de eliminar -->
                        <div class="exercise-item bg-gray-800 p-3 rounded-lg mb-2 flex items-center justify-between transition-all duration-200"
                            :class="{'bg-blue-900 bg-opacity-30': isExerciseSelected(muscle, exercise)}">
                            <div class="flex items-center w-full">
                                <div class="relative mr-3">
                                    <input type="checkbox" class="h-5 w-5 text-blue-500 rounded" 
                                        :checked="isExerciseSelected(muscle, exercise)"
                                        @change="toggleExercise(muscle, exercise)">
                                    <div class="check-icon absolute inset-0 flex items-center justify-center pointer-events-none"
                                        x-show="isExerciseSelected(muscle, exercise)">
                                        <i class="fas fa-check text-xs text-white"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <span class="exercise-name wrap-text font-medium" x-text="exercise"></span>
                                        <span x-show="isCustomExercise(muscle, exercise)" class="ml-2 text-xs text-green-400 bg-green-900 bg-opacity-30 px-2 py-1 rounded">
                                            <i class="fas fa-user-edit mr-1"></i>Personalizado
                                        </span>
                                    </div>
                                    <!-- Mostrar datos anteriores si existen -->
                                    <div class="previous-data" x-show="isExerciseSelected(muscle, exercise) && getPreviousExerciseData(muscle, exercise)">
                                        <i class="fas fa-history mr-1 text-yellow-400"></i>
                                        <span x-text="'Anterior: ' + getPreviousExerciseData(muscle, exercise)"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div x-show="isExerciseSelected(muscle, exercise)" class="flex items-center series-controls ml-2">
                                        <span class="text-sm mr-2 hidden md:block">Series:</span>
                                        <div class="flex items-center">
                                            <template x-for="n in Array.from({length: seriesLimits[userLevel].max - seriesLimits[userLevel].min + 1}, (_, i) => i + seriesLimits[userLevel].min)">
                                                <div class="series-badge" 
                                                    :class="{'selected': getExerciseSets(muscle, exercise) === n}"
                                                    @click="updateExerciseSets(muscle, exercise, n)"
                                                    x-text="n"></div>
                                            </template>
                                        </div>
                                    </div>
                                    <!-- Botón para eliminar cualquier ejercicio -->
                                    <button @click="removeExercise(muscle, exercise)"
                                            class="ml-2 text-red-400 hover:text-red-300 transition"
                                            title="Eliminar ejercicio">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                    <!-- Indicador de fatiga por grupo muscular -->
                    <div class="bg-gray-800 rounded-lg p-4 mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-medium wrap-text">Fatiga <span x-text="muscleGroups.find(m => m.key === muscle).label"></span>:</span>
                            <span class="text-sm font-semibold" 
                                  :class="{
                                    'text-green-400': muscleFatigue[muscle] <= 40,
                                    'text-yellow-400': muscleFatigue[muscle] > 40 && muscleFatigue[muscle] <= 70,
                                    'text-orange-400': muscleFatigue[muscle] > 70 && muscleFatigue[muscle] <= 85,
                                    'text-red-400': muscleFatigue[muscle] > 85
                                  }"
                                  x-text="muscleFatigue[muscle] + '%'"></span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                            <div class="h-2 rounded-full muscle-fatigue-bar" 
                                 :class="{
                                    'bg-green-500': muscleFatigue[muscle] <= 40,
                                    'bg-yellow-500': muscleFatigue[muscle] > 40 && muscleFatigue[muscle] <= 70,
                                    'bg-orange-500': muscleFatigue[muscle] > 70 && muscleFatigue[muscle] <= 85,
                                    'bg-red-500': muscleFatigue[muscle] > 85
                                 }" 
                                 :style="'width: ' + muscleFatigue[muscle] + '%'"></div>
                        </div>
                        <p class="text-xs text-gray-400 wrap-text" x-text="getMuscleFatigueMessage(muscle)"></p>
                    </div>
                </div>
            </template>
            <div class="flex justify-between mt-6">
                <button @click="currentScreen = 'muscles'" class="px-4 md:px-6 py-2 md:py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                    <i class="fas fa-arrow-left mr-2"></i> Volver
                </button>
                <button @click="startWorkout()" 
                        class="px-4 md:px-6 py-2 md:py-3 bg-green-600 rounded-lg hover:bg-green-500 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        :disabled="selectedExercisesCount === 0">
                    Iniciar Entrenamiento <i class="fas fa-play ml-2"></i>
                </button>
            </div>
        </div>
            <!-- PANTALLA DE ENTRENAMIENTO - LÓGICA CORREGIDA -->
            <div x-show="currentScreen === 'workout'" x-transition:enter.duration.300 x-transition:leave.duration.300>
                <!-- Encabezado mejorado con mejor espaciado -->
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-white">Entrenamiento en Progreso</h2>
                    <div class="text-lg font-semibold bg-blue-600 px-4 py-2 rounded-lg">
                        <i class="fas fa-clock mr-2"></i>
                        <span x-text="formatTime(workoutTime)"></span>
                    </div>
                </div>
          
                <!-- === AÑADIR AQUÍ EL INDICADOR VISUAL === -->
                <div x-show="currentTemplateOrigin.type === 'routine'" 
                    class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-xl p-3 mb-6">
                    <div class="flex items-center">
                        <i class="fas fa-layer-group text-blue-400 mr-2"></i>
                        <span class="text-blue-300">Este entrenamiento se guardará en: </span>
                        <span class="font-semibold text-white ml-1" x-text="currentTemplateOrigin.routineName"></span>
                    </div>
                </div>

                <!-- Indicador de ejercicio activo -->
                <div x-show="currentExercise.muscle && currentExercise.name" 
                    class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-play-circle text-blue-400 text-xl mr-3"></i>
                            <div>
                                <div class="font-semibold text-white">Ejercicio Activo</div>
                                <div class="text-sm text-blue-300" x-text="currentExercise.name"></div>
                            </div>
                        </div>
                        <button @click="currentExercise = { muscle: '', name: '' }" 
                                class="px-3 py-1 bg-red-600 rounded text-sm hover:bg-red-500 transition">
                            <i class="fas fa-times mr-1"></i> Desactivar
                        </button>
                    </div>
                </div>

                <!-- Barra de progreso general - simplificada -->
                <div class="bg-gray-700 rounded-xl p-5 mb-8">
                    <div class="flex justify-between mb-3">
                        <span class="font-medium text-white">Progreso General</span>
                        <span class="font-semibold text-blue-400" x-text="workoutProgress + '%'"></span>
                    </div>
                    <div class="w-full bg-gray-600 rounded-full h-3 mb-4">
                        <div class="h-3 rounded-full progress-bar bg-blue-500" :style="'width: ' + workoutProgress + '%'"></div>
                    </div>
                    
                    <!-- Estadísticas en grid simple -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-xl font-bold text-white" x-text="totalExercises"></div>
                            <div class="text-sm text-gray-400">Ejercicios</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-white" x-text="totalSets"></div>
                            <div class="text-sm text-gray-400">Series</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-green-400" x-text="completedExercises"></div>
                            <div class="text-sm text-gray-400">Completados</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xl font-bold text-green-400" x-text="completedSets"></div>
                            <div class="text-sm text-gray-400">Series Hechas</div>
                        </div>
                    </div>
                </div>

                <!-- Lista de ejercicios del entrenamiento -->
                <div class="space-y-6 workout-muscle-group" id="workout-container">
                    <template x-for="(muscle, muscleIndex) in selectedMuscles" :key="muscle">
                        <template x-for="(exercise, exerciseIndex) in selectedExercises[muscle]" :key="exercise.name">
                            <div class="workout-exercise bg-gray-700 rounded-xl p-5 border-l-4 transition-all duration-300 muscle-exercise-container"
                                :data-muscle-index="muscleIndex"
                                :data-exercise-index="exerciseIndex"
                                :class="{
                                    'border-green-500 bg-blue-900 bg-opacity-30': currentExercise.muscle === muscle && currentExercise.name === exercise.name,
                                    'border-green-500 opacity-80': exercise.completed === exercise.sets && exercise.completed > 0,
                                    'border-gray-600 opacity-70': currentExercise.muscle !== muscle && currentExercise.name !== exercise.name
                                }">
                                
                                <!-- INDICADOR DE ORDEN Y POSICIÓN (SIMPLIFICADO) -->
                                <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-600">
                                    <div class="flex items-center">
                                        <!-- QUITADO: Número de orden del músculo -->
                                        <span class="text-sm font-semibold text-white" 
                                            x-text="muscleGroups.find(m => m.key === muscle).label"></span>
                                    </div>
                                    <div class="text-xs text-gray-400" 
                                        x-text="'Ejercicio ' + (exerciseIndex + 1) + ' de ' + selectedExercises[muscle].length">
                                    </div>
                                </div>

                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-lg text-white wrap-text mb-1" x-text="exercise.name"></h4>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 rounded-full mr-2" :class="muscleGroups.find(m => m.key === muscle).color"></div>
                                            <span class="text-sm text-gray-400" x-text="muscleGroups.find(m => m.key === muscle).label"></span>
                                            <span class="text-sm text-blue-400 ml-3">
                                                <i class="fas fa-check-circle mr-1"></i>
                                                <span x-text="exercise.completed + '/' + exercise.sets + ' series'"></span>
                                            </span>
                                            <!-- Indicador de estado -->
                                            <span x-show="!currentExercise.muscle" 
                                                class="ml-3 text-xs text-yellow-400 bg-yellow-900 bg-opacity-30 px-2 py-1 rounded">
                                                <i class="fas fa-lock mr-1"></i> Bloqueado
                                            </span>
                                            <span x-show="currentExercise.muscle && (currentExercise.muscle !== muscle || currentExercise.name !== exercise.name)" 
                                                class="ml-3 text-xs text-yellow-400 bg-yellow-900 bg-opacity-30 px-2 py-1 rounded">
                                                <i class="fas fa-lock mr-1"></i> Bloqueado
                                            </span>
                                            <span x-show="currentExercise.muscle === muscle && currentExercise.name === exercise.name" 
                                                class="ml-3 text-xs text-green-400 bg-green-900 bg-opacity-30 px-2 py-1 rounded">
                                                <i class="fas fa-play mr-1"></i> Activo
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-semibold text-blue-400" x-show="exercise.completed > 0">
                                            <span x-text="calculateExerciseVolume(muscle, exercise.name) + ' kg'"></span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Series del ejercicio -->
                                <div class="space-y-3">
                                    <template x-for="(set, setIndex) in Array.from({length: exercise.sets})" :key="setIndex">
                                        <div class="workout-set bg-gray-800 rounded-lg border border-gray-700"
                                            :class="{'opacity-60': currentExercise.muscle !== muscle || currentExercise.name !== exercise.name}">
                                            <!-- Encabezado de la serie -->
                                            <div class="flex items-center justify-between p-3 border-b border-gray-700">
                                                <span class="font-medium text-white">Serie <span x-text="setIndex + 1"></span></span>
                                                    <!-- BOTÓN COMPLETAR - VERSIÓN FUNCIONAL -->
                                                <button class="px-3 py-1 rounded text-sm transition font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
                                                        @click="completeSetWithVisual(muscle, exercise.name, setIndex)"
                                                        :disabled="exerciseReps[muscle][exercise.name][setIndex] <= 0 || currentExercise.muscle !== muscle || currentExercise.name !== exercise.name"
                                                        :class="getCompleteButtonClass(muscle, exercise.name, setIndex)">
                                                    <i class="fas fa-check mr-1"></i> 
                                                    <span x-text="isSetCompletedVisually(muscle, exercise.name, setIndex) ? 'Completado' : 'Completar'"></span>
                                                </button>
                                            </div>
                                            
                                            <!-- Controles de peso y reps - MEJORADO PARA MÓVIL -->
                                            <div class="p-3">
                                                <div class="grid grid-cols-2 gap-3">
                                                    <!-- Peso -->
                                                    <div class="text-center">
                                                        <label class="text-xs text-gray-400 block mb-2">Peso (kg)</label>
                                                        <input type="number" min="0" 
                                                            class="w-full bg-gray-700 rounded px-2 py-2 text-center border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                                                            x-model="exerciseWeights[muscle][exercise.name][setIndex]"
                                                            @change="updateSetData(muscle, exercise.name, setIndex)"
                                                            placeholder="0"
                                                            :disabled="currentExercise.muscle !== muscle || currentExercise.name !== exercise.name">
                                                    </div>
                                                    
                                                    <!-- Reps -->
                                                    <div class="text-center">
                                                        <label class="text-xs text-gray-400 block mb-2">Repeticiones</label>
                                                        <input type="number" min="0" 
                                                            class="w-full bg-gray-700 rounded px-2 py-2 text-center border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                                                            x-model="exerciseReps[muscle][exercise.name][setIndex]"
                                                            @change="updateSetData(muscle, exercise.name, setIndex)"
                                                            placeholder="0"
                                                            :disabled="currentExercise.muscle !== muscle || currentExercise.name !== exercise.name">
                                                    </div>
                                                </div>
                                            </div>
                                    </template>
                                </div>

                                <!-- Botones de control del ejercicio -->
                                <div class="flex justify-between mt-4 pt-4 border-t border-gray-600">
                                    <!-- Botón Activar/Desactivar - SIEMPRE FUNCIONAL -->
                                    <button class="px-4 py-2 rounded-lg text-sm hover:opacity-90 transition-all duration-300 font-medium border"
                                            @click="toggleExerciseActivation(muscle, exercise.name)"
                                            :class="{
                                                'bg-green-600 text-white border-green-500 shadow-lg': currentExercise.muscle === muscle && currentExercise.name === exercise.name,
                                                'bg-blue-600 text-white border-blue-500 hover:bg-blue-500': currentExercise.muscle !== muscle || currentExercise.name !== exercise.name
                                            }">
                                        <i class="fas mr-1" :class="currentExercise.muscle === muscle && currentExercise.name === exercise.name ? 'fa-pause' : 'fa-play'"></i> 
                                        <span x-text="currentExercise.muscle === muscle && currentExercise.name === exercise.name ? 'Ejercicio Activo' : 'Activar Ejercicio'"></span>
                                    </button>
                                    
                                    <button class="px-4 py-2 bg-gray-600 rounded text-sm hover:bg-gray-500 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed text-white"
                                            @click="markExerciseAsCompleted(muscle, exercise.name)"
                                            :disabled="currentExercise.muscle !== muscle || currentExercise.name !== exercise.name">
                                        <i class="fas fa-check-circle mr-1"></i> Completar Todo
                                    </button>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>

                <!-- NUEVO Modal de Temporizador - Círculo mejor enmarcado -->
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" 
                    :class="{ 'active': isRestTimerActive }"
                    x-show="isRestTimerActive" x-cloak>
                    
                    <div class="flex flex-col items-center justify-center space-y-8 p-8 bg-gray-800 text-white rounded-2xl shadow-2xl w-80 h-80 mx-4 transition-all duration-500 border border-gray-700">
                        
                        <!-- Círculo animado - MÁS PEQUEÑO PARA MEJOR ENMARCADO -->
                        <div class="relative">
                            <svg class="w-40 h-40 transform -rotate-90" viewBox="0 0 100 100">
                                <!-- Fondo del círculo - GRIS -->
                                <circle class="text-gray-600" stroke-width="8" stroke="currentColor" fill="transparent" r="40" cx="50" cy="50" />
                                <!-- Progreso animado - AZUL OSCURO que se vuelve VERDE al final -->
                                <circle 
                                    class="transition-all duration-1000 ease-linear" 
                                    :class="restTimeRemaining <= 5 ? 'text-green-500' : 'text-blue-700'"
                                    stroke-width="8" 
                                    stroke-linecap="round"
                                    :stroke-dasharray="`${(restTimeRemaining / (currentSetInfo.timerType === 'muscle' ? restTimerConfig.muscleRestDuration : restTimerConfig.duration)) * 251} 251`"
                                    stroke="currentColor" 
                                    fill="transparent" 
                                    r="40" 
                                    cx="50" 
                                    cy="50" 
                                />
                            </svg>
                            <!-- Tiempo restante - BLANCO Y GRANDE -->
                            <span class="absolute inset-0 flex items-center justify-center text-5xl font-bold text-white">
                                <span x-text="formatRestTime(restTimeRemaining)"></span>
                            </span>
                        </div>

                        <!-- Botón cancelar -->
                        <button 
                            @click="stopRestTimer()"
                            class="px-6 py-3 rounded-full bg-gray-700 text-white font-semibold shadow-lg hover:bg-gray-600 transition-all duration-300 transform hover:scale-105 border border-gray-600"
                        >
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>

                        <!-- Indicador de sonidos -->
                        <div class="text-xs text-gray-400 flex items-center" x-show="restTimerConfig.soundEnabled">
                            <i class="fas fa-volume-up mr-1"></i> Sonidos activados
                        </div>
                    </div>
                </div>

                <!-- Botones de control del entrenamiento -->
                <div class="mt-8 flex justify-between">
                    <button @click="cancelWorkout()" 
                            class="px-6 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition flex items-center font-medium text-white">
                        <i class="fas fa-arrow-left mr-2"></i> Volver
                    </button>
                    
                    <div class="flex space-x-4">
                        <button @click="pauseWorkout()" 
                                class="px-6 py-3 bg-yellow-600 rounded-lg hover:bg-yellow-500 transition flex items-center font-medium text-white">
                            <i class="fas fa-pause mr-2"></i> 
                            <span x-text="workoutTimer ? 'Pausar' : 'Reanudar'"></span>
                        </button>
                        <button @click="finishWorkout()" 
                                class="px-6 py-3 bg-green-600 rounded-lg hover:bg-green-500 transition flex items-center font-medium text-white">
                            <i class="fas fa-flag-checkered mr-2"></i> Finalizar
                        </button>
                    </div>    
                </div>
            </div>
            <!-- PANTALLA DE RESUMEN CORREGIDA -->
            <div x-show="currentScreen === 'summary'" x-transition:enter.duration.300 x-transition:leave.duration.300>
                <h2 class="text-2xl font-bold mb-2 text-white">Resumen del Entrenamiento</h2>
                <p class="text-gray-400 mb-6">¡Excelente trabajo! Aquí tienes un resumen de tu entrenamiento.</p>
                
                <!-- Estadísticas principales -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6 mb-6 md:mb-8">
                    <div class="summary-card bg-gray-700 p-4 md:p-5 rounded-xl text-center">
                        <div class="text-4xl mb-2 text-blue-400"><i class="fas fa-clock"></i></div>
                        <div class="text-2xl font-bold mb-1 text-white" x-text="formatTime(workoutTime)"></div>
                        <div class="text-gray-400">Tiempo total</div>
                    </div>
                    <div class="summary-card bg-gray-700 p-4 md:p-5 rounded-xl text-center">
                        <div class="text-4xl mb-2 text-green-400"><i class="fas fa-dumbbell"></i></div>
                        <div class="text-2xl font-bold mb-1 text-white" x-text="completedSets + '/' + totalSets"></div>
                        <div class="text-gray-400">Series completadas</div>
                    </div>
                    <div class="summary-card bg-gray-700 p-4 md:p-5 rounded-xl text-center">
                        <div class="text-4xl mb-2 text-yellow-400"><i class="fas fa-weight-hanging"></i></div>
                        <div class="text-2xl font-bold mb-1 text-white" x-text="totalVolume + ' kg'"></div>
                        <div class="text-gray-400">Volumen total</div>
                    </div>
                    <div class="summary-card bg-gray-700 p-4 md:p-5 rounded-xl text-center">
                        <div class="text-4xl mb-2 text-purple-400"><i class="fas fa-check-circle"></i></div>
                        <div class="text-2xl font-bold mb-1 text-white" x-text="completedExercises + '/' + totalExercises"></div>
                        <div class="text-gray-400">Ejercicios completados</div>
                    </div>
                </div>

                <!-- Detalles por grupo muscular -->
                <div class="bg-gray-700 rounded-xl p-4 md:p-5 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center text-white">
                        <i class="fas fa-chart-line mr-2 text-blue-400"></i> Estadísticas por Grupo Muscular
                    </h3>
                    <div class="space-y-4">
                        <template x-for="muscle in selectedMuscles" :key="muscle">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 rounded-full mr-2" :class="muscleGroups.find(m => m.key === muscle).color"></div>
                                        <span class="font-medium text-white" x-text="muscleGroups.find(m => m.key === muscle).label"></span>
                                        <span class="text-sm text-blue-400 ml-2" x-text="'(' + calculateMuscleVolume(muscle) + ' kg)'"></span>
                                    </div>
                                    <div class="text-sm text-white" x-text="getMuscleCompletedSets(muscle) + '/' + getMuscleTotalSets(muscle) + ' series'"></div>
                                </div>
                                <div class="w-full bg-gray-600 rounded-full h-2">
                                    <div class="h-2 rounded-full progress-bar bg-blue-500" 
                                        :style="'width: ' + (getMuscleCompletedSets(muscle) / getMuscleTotalSets(muscle) * 100) + '%'"></div>
                                </div>
                                
                                <!-- CUADROS DE ESTADÍSTICAS EN ORDEN SOLICITADO -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
                                    <!-- 1. Ejecuciones completas de los ejercicios -->
                                    <div class="bg-gray-800 p-3 rounded text-center">
                                        <div class="text-xl font-bold text-green-400" 
                                            x-text="getMuscleCompletedExercises(muscle)"></div>
                                        <div class="text-xs text-gray-400">Ejecuciones Completas</div>
                                    </div>
                                    
                                    <!-- 2. Número de ejercicios -->
                                    <div class="bg-gray-800 p-3 rounded text-center">
                                        <div class="text-xl font-bold text-white" 
                                            x-text="selectedExercises[muscle]?.length || 0"></div>
                                        <div class="text-xs text-gray-400">Número de Ejercicios</div>
                                    </div>
                                    
                                    <!-- 3. Series que lo forman -->
                                    <div class="bg-gray-800 p-3 rounded text-center">
                                        <div class="text-xl font-bold text-blue-400" 
                                            x-text="getMuscleTotalSets(muscle)"></div>
                                        <div class="text-xs text-gray-400">Series Totales</div>
                                    </div>
                                    
                                    <!-- 4. Volumen -->
                                    <div class="bg-gray-800 p-3 rounded text-center">
                                        <div class="text-xl font-bold text-yellow-400" 
                                            x-text="calculateMuscleVolume(muscle) + ' kg'"></div>
                                        <div class="text-xs text-gray-400">Volumen Total</div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="flex justify-between">
                    <button @click="saveWorkoutAndRedirect()" class="px-4 md:px-6 py-2 md:py-3 bg-green-600 rounded-lg hover:bg-green-500 transition text-white">
                        <i class="fas fa-save mr-2"></i> Guardar y Ver Historial
                    </button>
                    <button @click="currentScreen = 'exercises'" class="px-4 md:px-6 py-2 md:py-3 bg-blue-600 rounded-lg hover:bg-blue-500 transition text-white">
                        <i class="fas fa-redo mr-2"></i> Nuevo Entrenamiento
                    </button>
                </div>
            </div>
            <!-- Pantalla de historial UNIFICADA -->
            <div x-show="currentScreen === 'history-manual'" x-transition:enter.duration.300 x-transition:leave.duration.300>
                <!-- Encabezado dinámico -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold mb-2 text-white" x-text="getHistoryTitle()"></h2>
                        <p class="text-gray-400" x-text="currentView.type === 'all' ? 
                            'Ejercicios que no pertenecen a rutinas' : 
                            'Entrenamientos de esta rutina'"></p>
                    </div>
                </div>
                <!-- Lista de entrenamientos filtrados -->
                <div class="space-y-4 mb-8" x-show="getFilteredWorkouts().length > 0">
                    <template x-for="(workout, index) in getFilteredWorkouts()" :key="index">
                        <div class="history-item bg-gray-700 p-4 md:p-5 rounded-xl">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-white" x-text="getTrainedMuscles(workout)"></h4>
                                    <div class="text-sm text-gray-400 mt-1">
                                        <span x-text="'Fecha: ' + formatDate(workout.date)"></span>
                                        <span class="ml-3 text-blue-400" x-text="workout.exercises + ' ejercicios'"></span>
                                    </div>
                                    <!-- Músculos trabajados -->
                                    <div class="mt-2 flex flex-wrap gap-1">
                                        <template x-for="muscle in getWorkoutMusclesByIndex(getWorkoutOriginalIndex(workout))" :key="muscle.key">
                                            <span class="text-xs px-2 py-1 rounded-full flex items-center"
                                                :class="muscle.color + ' bg-opacity-20 text-white'">
                                                <div class="w-2 h-2 rounded-full mr-1" :class="muscle.color"></div>
                                                <span x-text="muscle.label"></span>
                                            </span>
                                        </template>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-white" x-text="formatTime(workout.time)"></div>
                                    <div class="text-xs text-blue-400 mt-1" x-text="workout.totalVolume + ' kg'"></div>
                                    <div class="text-xs text-green-400 mt-1" x-text="workout.completedSets + '/' + workout.sets + ' series'"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                <!-- 1. Repeticiones -->
                                <div class="bg-gray-800 p-2 rounded text-center">
                                    <div class="font-bold text-yellow-400" x-text="calculateTotalReps(workout)"></div>
                                    <div class="text-xs text-gray-400">Repeticiones</div>
                                </div>
                                
                                <!-- 2. Ejercicios -->
                                <div class="bg-gray-800 p-2 rounded text-center">
                                    <div class="font-bold text-white" x-text="workout.exercises"></div>
                                    <div class="text-xs text-gray-400">Ejercicios</div>
                                </div>
                                
                                <!-- 3. Series -->
                                <div class="bg-gray-800 p-2 rounded text-center">
                                    <div class="font-bold text-white" x-text="workout.sets"></div>
                                    <div class="text-xs text-gray-400">Series</div>
                                </div>
                                
                                <!-- 4. Volumen -->
                                <div class="bg-gray-800 p-2 rounded text-center">
                                    <div class="font-bold text-blue-400" x-text="workout.totalVolume + ' kg'"></div>
                                    <div class="text-xs text-gray-400">Volumen</div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between space-x-2">
                                <div class="flex space-x-2 flex-1">
                                    <button @click="viewWorkoutDetails(getWorkoutOriginalIndex(workout))"  
                                            class="flex-1 px-3 py-2 bg-blue-600 rounded text-sm hover:bg-blue-500 transition text-white flex items-center justify-center">
                                        <i class="fas fa-eye mr-1"></i> Detalles
                                    </button>
                                    <button @click="useWorkoutAsTemplateFromIndex(getWorkoutOriginalIndex(workout))" 
                                            class="flex-1 px-3 py-2 bg-green-600 rounded text-sm hover:bg-green-500 transition text-white flex items-center justify-center">
                                        <i class="fas fa-copy mr-1"></i> Plantilla
                                    </button>
                                </div>
                                <button @click="deleteSingleWorkout(getWorkoutOriginalIndex(workout))" 
                                        class="flex-1 px-3 py-2 bg-red-600 rounded text-sm hover:bg-red-500 transition text-white delete-btn flex items-center justify-center">
                                    <i class="fas fa-trash mr-1"></i> Eliminar
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Mensaje cuando no hay entrenamientos - VERSIÓN SIMPLIFICADA -->
                <div x-show="getFilteredWorkouts().length === 0">
                    <template x-if="currentView.type === 'all'">
                        <!-- Pantalla para cuando NO HAY ejercicios sueltos (puede haber en rutinas) -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <!-- Tarjeta Crear Entrenamiento -->
                            <div class="bg-gray-700 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2 border-blue-500"
                                @click="currentScreen = 'level'">
                                <div class="text-4xl mb-4 text-blue-400">
                                    <i class="fas fa-dumbbell"></i>
                                </div>
                                <h3 class="text-xl font-semibold mb-3 text-white">Crear Entrenamiento Suelto</h3>
                                <p class="text-gray-400 mb-4" x-text="
                                    workoutHistory.length > 0 ? 
                                    'Añade un nuevo entrenamiento individual' :
                                    'Comienza tu primer entrenamiento manual'
                                "></p>
                                <div class="text-sm text-blue-300 flex items-center justify-center">
                                    <i class="fas fa-arrow-right mr-2"></i>
                                    <span>Empezar ahora</span>
                                </div>
                            </div>
                            
                            <!-- Tarjeta Gestionar Rutinas -->
                            <div class="bg-gray-700 rounded-xl p-6 text-center cursor-pointer transition-all duration-300 hover:transform hover:scale-105 border-2 border-green-500"
                                @click="currentScreen = 'workout-groups'">
                                <div class="text-4xl mb-4 text-green-400">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <h3 class="text-xl font-semibold mb-3 text-white" x-text="
                                    workoutGroups.length > 0 ? 
                                    'Recupera de Rutina' : 
                                    'Recupera de Rutina'
                                "></h3>
                                <p class="text-gray-400 mb-4">Recupera entrenamientos de rutinas guardadas</p>
                                <div class="text-sm text-green-300 flex items-center justify-center">
                                    <i class="fas fa-arrow-right mr-2"></i>
                                    <span x-text="workoutGroups.length > 0 ? 'Ver Rutinas' : 'Comenzar'"></span>
                                </div>
                            </div>
                        </div>
                    </template>
                    
                    <template x-if="currentView.type === 'routine'">
                        <!-- Pantalla para rutinas vacías -->
                        <div class="text-center py-10 bg-gray-700 rounded-xl">
                            <div class="text-5xl mb-4 text-gray-500">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2 text-white">Rutina vacía</h3>
                            <p class="text-gray-400 mb-4">Esta rutina no tiene entrenamientos guardados aún.</p>
                            <p class="text-sm text-gray-500 mb-6" x-text="
                                'Hay ' + workoutHistory.length + ' entrenamientos totales en la aplicación'
                            "></p>
                            
                            <div class="flex flex-col md:flex-row justify-center gap-4">
                                <button @click="viewAllHistory()" 
                                        class="px-6 py-3 bg-blue-600 rounded-lg hover:bg-blue-500 transition flex items-center justify-center">
                                    <i class="fas fa-history mr-2"></i> Ver Ejercicios Sueltos
                                </button>
                                <button @click="currentScreen = 'workout-groups'" 
                                        class="px-6 py-3 bg-gray-600 rounded-lg hover:bg-gray-500 transition flex items-center justify-center">
                                    <i class="fas fa-arrow-left mr-2"></i> Volver a Rutinas
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            <div class="flex space-x-2">
                    <!-- Botón para volver según el contexto -->
                    <template x-if="currentView.type === 'all'">
                        <button @click="currentScreen = 'history-selection'" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Volver
                        </button>
                    </template>
                    <template x-if="currentView.type === 'routine'">
                        <button @click="currentScreen = 'workout-group-details'" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                            <i class="fas fa-arrow-left mr-2"></i> Volver a Rutina
                        </button>
                    </template>
                
                    <button @click="viewEvolution()" class="px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-500 transition">
                        <i class="fas fa-chart-line mr-2"></i> Evolución
                    </button>
                </div>
            </div>
            
            <!-- Pantalla de detalles del entrenamiento - ORDEN CORREGIDO -->
            <div x-show="currentScreen === 'details'" x-transition:enter.duration.300 x-transition:leave.duration.300>
                <h2 class="text-2xl font-bold mb-2">Detalles del Entrenamiento</h2>
                <p class="text-gray-400 mb-6" x-text="'Fecha: ' + formatDate(viewedWorkout.date)"></p>
                
                <div class="bg-gray-700 rounded-xl p-4 md:p-5 mb-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-dumbbell mr-2 text-blue-400"></i> 
                        Ejercicios Realizados - Última Ejecución
                    </h3>
                    
                    <!-- Indicador de que es la última ejecución -->
                    <div class="bg-green-900 bg-opacity-30 border border-green-500 rounded-lg p-3 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-400 mr-2"></i>
                            <span class="text-green-300 font-medium">Mostrando la ejecución más reciente de cada ejercicio</span>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <template x-for="(muscle, muscleIndex) in (viewedWorkout.order || getDefaultOrderFromWorkout(viewedWorkout))" :key="muscle">
                            <div>
                                <h4 class="font-medium mb-3 text-lg flex items-center">
                                    <div class="w-3 h-3 rounded-full mr-2" 
                                        :class="muscleGroups.find(m => m.key === muscle)?.color || 'bg-gray-500'"></div>
                                    <span x-text="muscleGroups.find(m => m.key === muscle)?.label || muscle"></span>
                                </h4>
                                <div class="space-y-4">
                                    <template x-for="(exercise, exerciseIndex) in (viewedWorkout.exercisesData[muscle] || [])" :key="exercise.name">
                                        <div class="bg-gray-800 p-4 rounded-lg border-l-4 border-green-500">
                                            <!-- ENCABEZADO MEJORADO -->
                                            <div class="flex justify-between items-start mb-4">
                                                <div class="flex-1">
                                                    <h5 class="font-semibold wrap-text text-lg text-white mb-1" 
                                                        x-text="exercise.name"></h5>
                                                    <div class="text-sm text-gray-400">
                                                        <span class="text-green-400 font-medium">
                                                            <i class="fas fa-clock mr-1"></i>
                                                            Última ejecución: <span x-text="formatDateShort(viewedWorkout.date)"></span>
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-sm font-bold text-blue-400 bg-blue-900 bg-opacity-30 px-3 py-1 rounded-full" 
                                                        x-text="exercise.volume + ' kg'"></div>
                                                    <div class="text-xs text-green-400 mt-1" 
                                                        x-text="exercise.completed + '/' + exercise.sets + ' series'"></div>
                                                </div>
                                            </div>
                                            
                                            <!-- SERIES DE LA ÚLTIMA EJECUCIÓN -->
                                            <div class="mb-4">
                                                <div class="text-sm font-medium text-gray-300 mb-2">Series realizadas:</div>
                                                <div class="grid grid-cols-1 gap-2">
                                                    <template x-for="(set, index) in exercise.setsData" :key="index">
                                                        <div class="bg-gray-700 p-2 rounded text-sm" x-show="set.completed">
                                                            <div class="flex justify-between items-center">
                                                                <span class="font-medium" x-text="'Serie ' + (index + 1)"></span>
                                                                <span class="text-blue-300 font-semibold" 
                                                                    x-text="set.weight + ' kg x ' + set.reps + ' reps'"></span>
                                                            </div>
                                                        </div>
                                                    </template>
                                                    <div x-show="exercise.setsData.filter(s => s.completed).length === 0" 
                                                        class="text-sm text-gray-500 italic p-2">
                                                        No hay series completadas en esta ejecución.
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- HISTORIAL ANTERIOR - SEPARADO CLARAMENTE -->
                                            <div x-data="{ expanded: false }" class="border-t border-gray-600 pt-4">
                                                <button @click="expanded = !expanded" 
                                                        class="flex items-center text-sm text-yellow-400 hover:text-yellow-300 mb-2 w-full">
                                                    <i class="fas" :class="expanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                                    <span class="ml-2 flex-1 text-left">
                                                        <span x-text="expanded ? 'Ocultar ejecuciones anteriores' : 'Ver ejecuciones anteriores'"></span>
                                                        <span class="text-gray-400 ml-1" 
                                                            x-text="'(' + getExerciseHistoryCount(muscle, exercise.name, viewedWorkout.routineKey) + ')'"></span>
                                                    </span>
                                                </button>
                                                
                                                <div x-show="expanded" class="mt-3">
                                                    <div class="text-xs text-gray-400 mb-3 font-medium">
                                                        <i class="fas fa-history mr-1"></i>
                                                        Ejecuciones anteriores de este ejercicio:
                                                    </div>
                                                    
                                                    <div class="space-y-3">
                                                        <template x-for="(history, idx) in getExerciseHistory(muscle, exercise.name, viewedWorkout.routineKey)" :key="idx">
                                                            <div class="bg-gray-750 p-3 rounded-lg border-l-4 border-yellow-500">
                                                                <div class="flex justify-between items-start mb-2">
                                                                    <div class="text-xs font-medium text-gray-300" 
                                                                        x-text="formatDateShort(history.date)"></div>
                                                                    <div class="text-xs text-blue-400 font-semibold" 
                                                                        x-text="history.volume + ' kg'"></div>
                                                                </div>
                                                                <div class="space-y-1">
                                                                    <template x-for="(set, setIndex) in history.setsData" :key="setIndex">
                                                                        <div x-show="set.completed" class="text-xs text-gray-400">
                                                                            <span x-text="'S' + (setIndex + 1) + ': ' + set.weight + 'kg x ' + set.reps"></span>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </template>
                                                        
                                                        <div x-show="getExerciseHistory(muscle, exercise.name, viewedWorkout.routineKey).length === 0" 
                                                            class="text-xs text-gray-500 italic text-center py-2">
                                                            No hay ejecuciones anteriores registradas.
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="flex justify-between space-x-2">
                    <button @click="goBackFromDetails()" 
                            class="flex-1 px-3 py-2 bg-gray-700 rounded text-sm hover:bg-gray-600 transition text-white flex items-center justify-center">
                        <i class="fas fa-arrow-left mr-1"></i> Volver a la Rutina
                    </button>
                </div>
            </div>
            
            <!-- Pantalla de Limpieza de Historial -->
            <div x-show="currentScreen === 'cleanup'" x-transition:enter.duration.300>
                <h2 class="text-2xl font-bold mb-2">Gestionar Historial</h2>
                <p class="text-gray-400 mb-6">Selecciona las rutinas que quieres eliminar.</p>
                <div class="flex justify-between mb-4">
                    <div class="flex items-center">
                        <input type="checkbox" id="selectAll" class="mr-2" 
                        <label for="selectAll" class="text-sm">Seleccionar todo</label>
                    </div>
                </div>
                <div class="space-y-3 mb-6 max-h-96 overflow-y-auto">
                    <template x-for="workout in getFilteredWorkouts()" :key="workout.originalIndex">
                        <div class="routine-card bg-gray-700 p-4 rounded-lg flex items-start"
                            <input type="checkbox" class="mr-3 mt-1" 
                                :value="index" x-model="selectedRoutines">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold" x-text="getTrainedMuscles(workout)"></h4>
                                        <div class="text-sm text-gray-400 mt-1">
                                            <span x-text="'Último entrenamiento - ' + formatDateShort(workout.date)"></span>
                                                <i class="fas fa-clock"></i> Inactiva
                                            </span>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm" x-text="formatTime(workout.time)"></div>
                                        <div class="text-xs text-blue-400 mt-1" x-text="workout.totalVolume + ' kg'"></div>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-gray-400" x-text="getRoutineExercisesSummary(workout)"></div>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="flex justify-between">
                    <button @click="currentScreen = 'history-manual'" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                        <i class="fas fa-arrow-left mr-2"></i> Volver al Historial
                    </button>

                    <button @click="currentScreen = 'level'" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 transition">
                        <i class="fas fa-dumbbell mr-2"></i> Nuevo Entrenamiento
                    </button>
                </div>
            </div>
            <!-- Modal de Estadísticas -->
            <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" 
                 :class="{ 'active': showStatsModal }"
                 @click="showStatsModal = false"
                 x-show="showStatsModal" x-cloak>
                <div class="modal-container bg-gray-800 rounded-xl p-6" @click.stop>
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-blue-400"></i> Estadísticas de Progreso
                    </h3>
                    <div class="stats-grid mb-6">
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="text-2xl font-bold mb-1" x-text="workoutHistory.length"></div>
                            <div class="text-sm text-gray-400">Entrenamientos Totales</div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="text-2xl font-bold mb-1" x-text="totalHistorySets"></div>
                            <div class="text-sm text-gray-400">Series Totales</div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg">
                            <div class="text-2xl font-bold mb-1" x-text="totalHistoryVolume + ' kg'"></div>
                            <div class="text-sm text-gray-400">Volumen Total</div>
                        </div>
                    </div>
                    <div class="bg-gray-700 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold mb-3">Progreso por Grupo Muscular</h4>
                        <div class="space-y-3">
                            <template x-for="muscle in muscleGroups" :key="muscle.key">
                                <div x-show="hasDataForMuscle(muscle.key)">
                                    <div class="flex justify-between mb-1">
                                        <span class="text-sm" x-text="muscle.label"></span>
                                        <span class="text-sm font-semibold" x-text="calculateMuscleProgress(muscle.key) + ' kg'"></span>
                                    </div>
                                    <div class="progress-bar-stats">
                                        <div class="progress-fill bg-blue-500" 
                                             :style="'width: ' + Math.min(100, calculateMuscleProgress(muscle.key) / Math.max(...muscleGroups.map(m => calculateMuscleProgress(m.key))) * 100) + '%'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button @click="showStatsModal = false" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
            <!-- Modal de Configuración -->
            <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" 
                 :class="{ 'active': showSettingsModal }"
                 @click="showSettingsModal = false"
                 x-show="showSettingsModal" x-cloak>
                <div class="modal-container bg-gray-800 rounded-xl p-6" @click.stop>
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-cog mr-2 text-gray-400"></i> Configuración
                    </h3>
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Sonido al completar series</label>
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2 h-5 w-5 text-blue-500 rounded" 
                                    x-model="soundEnabled"
                                    @change="saveSoundPreference()">
                                <span x-text="soundEnabled ? 'Activado' : 'Desactivado'"></span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Modo Oscuro</label>
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2 h-5 w-5 text-blue-500 rounded" checked>
                                <span>Activado</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Notificaciones de Recordatorio</label>
                            <div class="flex items-center">
                                <input type="checkbox" class="mr-2 h-5 w-5 text-blue-500 rounded">
                                <span>Activado</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between">
                        <button @click="resetApp()" class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-500 transition">
                            <i class="fas fa-trash mr-1"></i> Restablecer
                        </button>
                        <button @click="showSettingsModal = false" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
             
            <!-- Modal para crear/editar rutinas de trabajo - VERSIÓN CORREGIDA -->
            <div class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50" 
                x-show="showCreateWorkoutGroupModal" 
                x-cloak
                :class="{ 'active': showCreateWorkoutGroupModal }"
                @click="showCreateWorkoutGroupModal = false">
                <div class="modal-container bg-gray-800 rounded-xl p-6 max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto" @click.stop>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">
                            <i class="fas fa-layer-group mr-2" :class="editingWorkoutGroup ? 'text-yellow-400' : 'text-blue-400'"></i>
                            <span x-text="editingWorkoutGroup ? 'Editar Rutina: ' + editingWorkoutGroup.name : 'Crear Nueva Rutina de Trabajo'"></span>
                        </h2>
                        <button class="text-gray-400 hover:text-white" @click="cancelWorkoutGroupModal()">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Nombre de la rutina -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2 text-white">Nombre de la rutina:</label>
                        <input type="text" 
                            x-model="newWorkoutGroupName"
                            placeholder="Ej: Rutina Semana 1, Full Body, etc."
                            class="w-full bg-gray-700 rounded-lg px-4 py-2 border border-gray-600 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 text-white">
                    </div>
                    
                    <!-- Lista de GRUPOS disponibles -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-3 text-white">Seleccionar plantillas base:</h3>
                        
                        <!-- Información de estado -->
                        <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-3 mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                                <div>
                                    <span class="text-blue-300" x-text="'Workouts disponibles: ' + getFilteredWorkouts().length"></span>
                                    <span class="text-green-300 ml-3" x-text="'Grupos encontrados: ' + getGroupedManualWorkouts().length"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border border-gray-700 rounded-lg p-3 max-h-64 overflow-y-auto">
                            <template x-for="(group, index) in getGroupedManualWorkouts()" :key="group.routineKey">
                                <div class="bg-gray-750 p-3 rounded mb-2 flex items-start transition-all hover:bg-gray-700">
                                    <input type="checkbox" 
                                        class="mr-3 mt-1 h-5 w-5 text-blue-500" 
                                        :checked="isGroupSelected(group.routineKey)"
                                        @change="toggleGroupForWorkoutGroup(group.routineKey)">
                                    <div class="flex-1">
                                        <!-- NOMBRE DEL GRUPO -->
                                        <div class="font-medium text-white text-sm mb-1">
                                            <i class="fas fa-dumbbell text-blue-400 mr-1"></i>
                                            <span x-text="getWorkoutTitleFromWorkout(group.representative)"></span>
                                        </div>
                                        
                                        <!-- FECHA Y ESTADÍSTICAS -->
                                        <div class="text-xs text-gray-400 mb-1">
                                            <span x-text="'Último: ' + formatDateShort(group.latestDate)"></span>
                                            <span class="ml-2 text-blue-400" x-text="group.latestExercises + ' ejercicios'"></span>
                                            <span class="ml-2 text-green-400" x-text="group.latestSets + ' series'"></span>
                                            <span class="ml-2 text-yellow-400" x-text="'(' + group.count + ' ejecuciones)'"></span>
                                        </div>
                                        
                                        <!-- LISTA DE EJERCICIOS (NOMBRES VISIBLES) -->
                                        <div class="mt-2">
                                            <div class="text-xs text-gray-300 font-medium mb-1">Ejercicios:</div>
                                            <div class="flex flex-wrap gap-1">
                                                <template x-for="(exercise, exIndex) in group.exercisesList" :key="exIndex">
                                                    <span class="text-xs bg-gray-600 px-2 py-1 rounded text-white border border-gray-500">
                                                        <i class="fas fa-dumbbell mr-1 text-blue-300"></i>
                                                        <span class="font-medium" x-text="exercise.name"></span>
                                                        <span class="text-gray-400 ml-1" x-text="'(' + exercise.sets + ')'"></span>
                                                    </span>
                                                </template>
                                                <span x-show="group.exercisesList.length === 0" 
                                                    class="text-xs text-red-400 italic">
                                                    No se pudieron cargar los ejercicios
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-blue-400 font-bold" x-text="group.latestVolume + ' kg'"></div>
                                        <div class="text-xs text-green-400" x-text="group.count + ' veces'"></div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Mensaje cuando no hay grupos -->
                            <div x-show="getGroupedManualWorkouts().length === 0" class="text-center py-8 text-gray-500">
                                <div class="text-4xl mb-3">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h4 class="font-medium text-white mb-2">No hay workouts disponibles</h4>
                                <p class="text-sm mb-4">Completa algunos entrenamientos manuales primero.</p>
                                <button @click="currentScreen = 'level'" 
                                        class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 transition">
                                    <i class="fas fa-dumbbell mr-2"></i> Crear Entrenamiento
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contador de selección -->
                        <div class="text-sm text-gray-400 mt-2">
                            <span x-text="selectedGroupsForWorkoutGroup.length + ' grupos seleccionados'"></span>
                            <span x-show="selectedGroupsForWorkoutGroup.length > 0" class="ml-2 text-green-400">
                                (<span x-text="calculateTotalWorkoutsInSelectedGroups()"></span> workouts)
                            </span>
                        </div>
                    </div>
                    
                    <!-- Botones de acción -->
                    <div class="flex justify-end gap-3 pt-4 border-t border-gray-700">
                        <button @click="cancelWorkoutGroupModal()" 
                                class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600 transition">
                            Cancelar
                        </button>
                        <button @click="editingWorkoutGroup ? updateWorkoutGroup() : createWorkoutGroup()" 
                                class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-500 transition disabled:opacity-50" 
                                :disabled="selectedGroupsForWorkoutGroup.length === 0 || !newWorkoutGroupName.trim()">
                            <i class="fas fa-save mr-1"></i> 
                            <span x-text="editingWorkoutGroup ? 'Actualizar Rutina' : 'Crear Rutina'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script defer>
        function gymApp() {
            return {
                // ==================================================
                // 1. ESTADO DE LA APLICACIÓN (VARIABLES REACTIVAS)
                // ==================================================
                currentScreen: 'mode-selection',
                userLevel: '',
                selectedMuscles: [],
                selectedExercises: {},
                exerciseWeights: {},
                exerciseReps: {},
                workoutTime: 0,
                workoutTimer: null,
                currentExercise: { muscle: '', name: '' },
                workoutHistory: [],
                viewedWorkout: {},
                showAdvancedMenu: false,
                showStatsModal: false,
                showSettingsModal: false,
                soundEnabled: true,
                audioContext: null,
                selectedGroupsForWorkoutGroup: [],
                currentView: {
                    type: 'all', // 'all', 'routine'
                    routineId: null,
                    filter: 'current'
                },
                workoutGroups: [],
                currentWorkoutGroup: null,
                showCreateWorkoutGroupModal: false,
                selectedWorkoutsForGroup: [],
                newWorkoutGroupName: '',
                editingWorkoutGroup: null,
                completedSetsState: {},
                // Variables para la evolución
                selectedMetric: 'volume',
                evolutionFilter: 'all',
                selectedExercise: '',
                evolutionChart: null,
                // Ejercicios personalizados
                newCustomExerciseName: '',
                newCustomExerciseMuscle: '',
                customMuscleName: '',
                customExercises: [],
                customMuscles: [],
                viewedWorkoutIndex: -1,
                restTimerConfig: {
                    enabled: true,
                    duration: 60, // 60 segundos por defecto entre series
                    muscleRestDuration: 120, // 120 segundos por defecto entre músculos
                    soundEnabled: true
                },
                isRestTimerActive: false,
                restTimeRemaining: 0,
                restTimer: null,
                currentSetInfo: {},

                // Constantes
                levelLabels: {
                    beginner: 'Principiante',
                    intermediate: 'Intermedio',
                    advanced: 'Avanzado'
                },
                seriesLimits: {
                    beginner: { min: 2, max: 3 },
                    intermediate: { min: 2, max: 4 },
                    advanced: { min: 2, max: 5 }
                },
                muscleGroups: [
                    { key: 'chest', label: 'Pecho', color: 'bg-red-500' },
                    { key: 'back', label: 'Espalda', color: 'bg-blue-500' },
                    { key: 'shoulders', label: 'Hombros', color: 'bg-yellow-500' },
                    { key: 'biceps', label: 'Bíceps', color: 'bg-green-500' },
                    { key: 'triceps', label: 'Tríceps', color: 'bg-purple-500' },
                    { key: 'legs', label: 'Piernas', color: 'bg-orange-500' },
                    { key: 'abs', label: 'Abdominales', color: 'bg-pink-500' },
                    { key: 'traps', label: 'Trapecio + Otros', color: 'bg-indigo-500' }
                ],
                exercisesByMuscle: {
                    chest: ['Press de banca', 'Press inclinado', 'Aperturas banca', 'Aperturas inclinadas', 'Fondos en paralelas', 'Press declinado', 'Cruces en polea alta' , 'Cruces en polea baja', 'Pullover pecho'],
                    back: ['Dominadas', 'Jalón al pecho', 'Remo invertido', 'Peso muerto', 'Remo en máquina', 'Hiperextensiones', 'Concentrado a una mano', 'Pullover espalda'],
                    shoulders: ['Press militar', 'Elevaciones laterales', 'Face pulls', 'Elevaciones frontales', 'Press Arnold', 'Pájaro', 'Cruce poleas'],
                    biceps: ['Curl de bíceps', 'Curl martillo', 'Curl concentrado', 'Curl en banco Scott', 'Curl con barra', '21'],
                    triceps: ['Fondos', 'Press francés', 'Extensiones polea alta', 'Patada de tríceps', 'Jalón de tríceps', 'Concentrado'],
                    legs: ['Sentadillas', 'Prensa', 'Prensa pies en V', 'Extensiones de cuádriceps', 'Curl femoral', 'Peso muerto rumano', 'Elevación de talones', 'Cuadriceps en pared', 'Zancada'],
                    abs: ['Crunch abdominal', 'Plancha', 'Elevaciones de piernas', 'Russian twists', 'Abdominales en bicicleta'],
                    traps: ['Encogimientos de hombros', 'Remo alto', 'Face pulls', 'Pájaros invertidos', 'Elevaciones laterales']
                },


                // ==================================================
                // 2. INICIALIZACIÓN Y CARGA DE DATOS
                // ==================================================
                init() {
                    localStorage.removeItem('userLevel');
                    this.userLevel = null;

                    console.log('Iniciando aplicación...');
                    this.migrateOldData();
                    this.loadFromLocalStorage();
                    this.loadCustomExercises();
                    this.currentScreen = 'mode-selection';
                    this.currentMode = '';
                    this.completedSetsState = {};
                       // Corregir workouts sin modo
                    this.fixWorkoutModes();
                    setTimeout(() => {
                        console.log('=== VERIFICACIÓN INICIAL DE RUTINAS ===');
                        const results = this.verifyAndFixWorkoutReferences();
                        
                        if (results.fixedCount > 0 || results.invalidCount > 0) {
                            console.log('Se corrigieron problemas en las rutinas al iniciar:', results);
                        }

                    }, 500);
                    
                    // Cargar configuración del temporizador
                    const savedRestConfig = localStorage.getItem('gymApp_restTimerConfig');
                    if (savedRestConfig) {
                        try {
                            const config = JSON.parse(savedRestConfig);
                            this.restTimerConfig = { 
                                enabled: config.enabled !== undefined ? config.enabled : true,
                                duration: config.duration || 60,
                                muscleRestDuration: config.muscleRestDuration || 120,
                                soundEnabled: config.soundEnabled !== undefined ? config.soundEnabled : true
                            };
                        } catch (error) {
                            console.error('Error parsing rest timer config:', error);
                        }
                    }
                    
                    // CARGAR RUTINAS DE TRABAJO GUARDADAS
                    const savedWorkoutGroups = localStorage.getItem('gymApp_workoutGroups');
                    if (savedWorkoutGroups) {
                        try {
                            this.workoutGroups = JSON.parse(savedWorkoutGroups);
                        } catch (error) {
                            console.error('Error parsing workout groups:', error);
                            this.workoutGroups = [];
                        }
                    }
                    
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('/sw.js')
                            .then(reg => console.log('Service Worker registrado', reg))
                            .catch(err => console.log('Error registrando Service Worker', err));
                    }
                    
                    if ('Notification' in window) {
                        Notification.requestPermission();
                    }
                },

                // ==================================================
                // 3. NAVEGACIÓN Y FLUJO PRINCIPAL
                // ==================================================

                selectLevel(level) {
                    this.userLevel = level;
                    setTimeout(() => {
                        this.currentScreen = 'muscles';
                    }, 300);
                },
                // REEMPLAZAR la función goBack() actual por esta versión mejorada:
                goBack() {
                    console.log('Volviendo desde Evolución...');
                    
                    // Determinar a dónde volver según el contexto
                    if (this.currentView.type === 'routine' && this.currentView.routineId) {
                        // Si veníamos de una rutina específica, volver al historial de esa rutina
                        this.currentScreen = 'history-manual';
                        console.log('Volviendo al historial de rutina');
                    } 
                    else if (this.currentScreen === 'evolution' && this.lastViewContext) {
                        // Si tenemos un contexto guardado, usarlo
                        if (this.lastViewContext.screen === 'workout-group-details') {
                            this.currentScreen = 'workout-group-details';
                        } else if (this.lastViewContext.screen === 'history-manual') {
                            this.currentScreen = 'history-manual';
                        } else {
                            this.currentScreen = 'history-manual';
                        }
                        console.log('Volviendo usando contexto:', this.lastViewContext);
                    }
                    else {
                        // Por defecto, volver al historial manual
                        this.currentScreen = 'history-manual';
                        console.log('Volviendo al historial general por defecto');
                    }
                    
                    // Limpiar filtros de evolución para la próxima vez
                    this.evolutionFilter = 'all';
                    this.selectedExercise = '';
                },

                // MEJORAR la navegación hacia Evolución para guardar el contexto
                viewEvolution() {
                    // Guardar el contexto actual antes de ir a Evolución
                    this.lastViewContext = {
                        screen: this.currentScreen,
                        routineId: this.currentView.routineId,
                        isRoutine: this.currentView.type === 'routine'
                    };
                    
                    console.log('Navegando a Evolución. Contexto:', this.lastViewContext);
                    this.currentScreen = 'evolution';
                    
                    // Inicializar el gráfico después de la transición
                    this.$nextTick(() => {
                        setTimeout(() => {
                            this.initEvolutionChart();
                        }, 300);
                    });
                },


                // ==================================================
                // 4. GESTIÓN DE MÚSCULOS Y EJERCICIOS
                // ==================================================

                toggleMuscleSelection(muscle) {
                    if (this.selectedMuscles.includes(muscle)) {
                        // CORREGIDO: usar 'muscle' en lugar de 'muscleKey'
                        this.selectedMuscles = this.selectedMuscles.filter(m => m !== muscle);
                        
                        // Eliminar también los ejercicios seleccionados para ese músculo
                        if (this.selectedExercises[muscle]) {
                            delete this.selectedExercises[muscle];
                        }
                    } else {
                        this.selectedMuscles.push(muscle);
                        if (!this.selectedExercises[muscle]) {
                            this.selectedExercises[muscle] = [];
                        }
                    }
                },
                toggleExercise(muscle, exercise) {
                    if (!this.selectedExercises[muscle]) {
                        this.selectedExercises[muscle] = [];
                    }
                    const exerciseIndex = this.selectedExercises[muscle].findIndex(e => e.name === exercise);
                    if (exerciseIndex !== -1) {
                        this.selectedExercises[muscle].splice(exerciseIndex, 1);
                        if (this.exerciseWeights[muscle] && this.exerciseWeights[muscle][exercise]) {
                            delete this.exerciseWeights[muscle][exercise];
                        }
                        if (this.exerciseReps[muscle] && this.exerciseReps[muscle][exercise]) {
                            delete this.exerciseReps[muscle][exercise];
                        }
                    } else {
                        this.selectedExercises[muscle].push({
                            name: exercise,
                            sets: this.seriesLimits[this.userLevel].min,
                            completed: 0
                        });
                        if (!this.exerciseWeights[muscle]) this.exerciseWeights[muscle] = {};
                        if (!this.exerciseReps[muscle]) this.exerciseReps[muscle] = {};
                        this.exerciseWeights[muscle][exercise] = Array.from(
                            {length: this.seriesLimits[this.userLevel].max},
                            () => 0
                        );
                        this.exerciseReps[muscle][exercise] = Array.from(
                            {length: this.seriesLimits[this.userLevel].max},
                            () => 0
                        );
                    }
                },
                isExerciseSelected(muscle, exercise) {
                    return this.selectedExercises[muscle]?.some(e => e.name === exercise) || false;
                },
                getExerciseSets(muscle, exercise) {
                    const ex = this.selectedExercises[muscle]?.find(e => e.name === exercise);
                    return ex ? ex.sets : this.seriesLimits[this.userLevel].min;
                },
                updateExerciseSets(muscle, exercise, sets) {
                    const ex = this.selectedExercises[muscle]?.find(e => e.name === exercise);
                    if (ex) {
                        ex.sets = sets;
                        if (!this.exerciseWeights[muscle]) this.exerciseWeights[muscle] = {};
                        if (!this.exerciseReps[muscle]) this.exerciseReps[muscle] = {};
                        if (!this.exerciseWeights[muscle][exercise]) {
                            this.exerciseWeights[muscle][exercise] = Array.from(
                                {length: this.seriesLimits[this.userLevel].max},
                                () => 0
                            );
                        }
                        if (!this.exerciseReps[muscle][exercise]) {
                            this.exerciseReps[muscle][exercise] = Array.from(
                                {length: this.seriesLimits[this.userLevel].max},
                                () => 0
                            );
                        }
                    }
                },
                // Métodos nuevos:
                createWorkoutGroup(workoutIndices, groupName) {
                const newGroup = {
                    id: 'group_' + Date.now(),
                    name: groupName,
                    workouts: workoutIndices,
                    createdFrom: 'manual',
                    creationDate: new Date().toISOString()
                };
                this.workoutGroups.push(newGroup);
                this.saveToLocalStorage();
                },

                loadWorkoutGroup(group) {
                    console.log('Cargando rutina:', group);
                    this.currentWorkoutGroup = { ...group };
                    
                    // Agrupar los workouts por routineKey
                    const groupedWorkouts = {};
                    
                    group.workouts.forEach(workoutIndex => {
                        if (workoutIndex >= 0 && workoutIndex < this.workoutHistory.length) {
                            const workout = this.workoutHistory[workoutIndex];
                            const routineKey = workout.routineKey || 'unknown';
                            
                            if (!groupedWorkouts[routineKey]) {
                                groupedWorkouts[routineKey] = {
                                    routineKey: routineKey,
                                    representative: workout,
                                    workoutIndices: [workoutIndex],
                                    count: 1,
                                    latestDate: workout.date
                                };
                            } else {
                                groupedWorkouts[routineKey].workoutIndices.push(workoutIndex);
                                groupedWorkouts[routineKey].count++;
                                // Mantener el más reciente
                                if (new Date(workout.date) > new Date(groupedWorkouts[routineKey].latestDate)) {
                                    groupedWorkouts[routineKey].representative = workout;
                                    groupedWorkouts[routineKey].latestDate = workout.date;
                                }
                            }
                        }
                    });
                    
                    // Reemplazar el array de workouts por los grupos
                    this.currentWorkoutGroup.groupedWorkouts = Object.values(groupedWorkouts);
                    this.currentScreen = 'workout-group-details';
                },
                getGroupedWorkoutsForGroup() {
                    if (!this.currentWorkoutGroup || !this.currentWorkoutGroup.workouts) {
                        console.log('No hay workouts en la rutina actual');
                        return [];
                    }
                    
                    const groups = this.getRoutineGroupsForWorkoutGroup(this.currentWorkoutGroup);
                    
                    // MEJORAR la información del grupo con detalles actualizados
                    return groups.map(group => {
                        // Contar workouts válidos en este grupo
                        const validWorkouts = group.workoutIndices.filter(index => 
                            index >= 0 && index < this.workoutHistory.length &&
                            this.workoutHistory[index] &&
                            this.workoutHistory[index].exercisesData
                        );
                        
                        const exercisesList = this.getExercisesListFromWorkout(group.representative);
                        
                        return {
                            ...group,
                            exercisesList: exercisesList,
                            exerciseCount: exercisesList.length,
                            // ACTUALIZAR el count con solo workouts válidos
                            count: validWorkouts.length,
                            workoutIndices: validWorkouts // Actualizar con índices válidos
                        };
                    });
                },
                getExercisesListFromWorkout(workout) {
                    if (!workout || !workout.exercisesData) {
                        console.warn('Workout sin exercisesData:', workout);
                        return [];
                    }
                    
                    const exercises = [];
                    try {
                        const muscles = Array.isArray(workout.order) && workout.order.length ? workout.order : Object.keys(workout.exercisesData);
                        
                        muscles.forEach(muscle => {
                            const muscleExercises = workout.exercisesData[muscle] || [];
                            muscleExercises.forEach(exercise => {
                                if (exercise && exercise.name) {
                                    exercises.push({
                                        name: exercise.name,
                                        muscle: muscle,
                                        sets: exercise.sets || 0,
                                        completed: exercise.completed || 0
                                    });
                                }
                            });
                        });
                    } catch (error) {
                        console.error('Error obteniendo ejercicios del workout:', error, workout);
                    }
                    
                    return exercises;
                },

                // REEMPLAZAR la función getExercisesPreview
                getExercisesPreview(exercisesList, maxExercises = 3) {
                    if (!exercisesList || !Array.isArray(exercisesList) || exercisesList.length === 0) {
                        return 'Sin ejercicios definidos';
                    }
                    
                    try {
                        const exerciseNames = exercisesList.map(ex => ex.name).filter(name => name);
                        
                        if (exerciseNames.length === 0) {
                            return 'Ejercicios sin nombre';
                        }
                        
                        if (exerciseNames.length <= maxExercises) {
                            return exerciseNames.join(', ');
                        }
                        
                        const firstExercises = exerciseNames.slice(0, maxExercises);
                        return `${firstExercises.join(', ')}... (+${exerciseNames.length - maxExercises})`;
                    } catch (error) {
                        console.error('Error en getExercisesPreview:', error);
                        return 'Error al cargar ejercicios';
                    }
                },
                getWorkoutTitleFromWorkout(workout) {
                    if (!workout || !workout.exercisesData) {
                        return 'Workout sin datos';
                    }
                    
                    try {
                        const muscles = workout.order && workout.order.length ? workout.order : Object.keys(workout.exercisesData);
                        if (muscles.length === 0) {
                            return 'Sin músculos definidos';
                        }
                        
                        const muscleNames = muscles.map(muscleKey => {
                            const muscleGroup = this.muscleGroups.find(m => m.key === muscleKey);
                            return muscleGroup ? muscleGroup.label : muscleKey;
                        });
                        
                        if (muscleNames.length <= 2) {
                            return muscleNames.join(" + ");
                        }
                        
                        return muscleNames.slice(0, 2).join(" + ") + ` + ${muscleNames.length - 2} más`;
                    } catch (error) {
                        console.error('Error en getWorkoutTitleFromWorkout:', error);
                        return 'Error al cargar título';
                    }
                },
                getRoutineGroupsForWorkoutGroup(workoutGroup) {
                    if (!workoutGroup || !workoutGroup.workouts) return [];
                    
                    console.log('=== CALCULANDO GRUPOS PARA RUTINA ===');
                    console.log('Total workouts en rutina:', workoutGroup.workouts.length);
                    
                    const groups = {};
                    
                    workoutGroup.workouts.forEach(workoutIndex => {
                        if (workoutIndex >= 0 && workoutIndex < this.workoutHistory.length) {
                            const workout = this.workoutHistory[workoutIndex];
                            
                            // VALIDACIÓN: Asegurar que el workout tiene datos válidos
                            if (!workout || !workout.exercisesData || Object.keys(workout.exercisesData).length === 0) {
                                console.log('❌ Workout inválido omitido:', workoutIndex);
                                return; // Saltar workouts inválidos
                            }
                            
                            const routineKey = workout.routineKey || 'unknown';
                            
                            if (!groups[routineKey]) {
                                groups[routineKey] = {
                                    routineKey: routineKey,
                                    representative: workout,
                                    workoutIndices: [workoutIndex],
                                    count: 1,
                                    latestDate: workout.date
                                };
                            } else {
                                groups[routineKey].workoutIndices.push(workoutIndex);
                                groups[routineKey].count++;
                                // Mantener el workout más reciente como representante
                                if (new Date(workout.date) > new Date(groups[routineKey].latestDate)) {
                                    groups[routineKey].representative = workout;
                                    groups[routineKey].latestDate = workout.date;
                                }
                            }
                        } else {
                            console.log('❌ Índice de workout fuera de rango:', workoutIndex);
                        }
                    });
                    
                    const result = Object.values(groups);
                    console.log('Grupos calculados:', result.length);
                    
                    return result;
                },

                // Función para contar rutinas únicas en un grupo
                getUniqueRoutinesCount(workoutGroup) {
                    if (!workoutGroup || !workoutGroup.workouts) return 0;
                    
                    const uniqueRoutines = new Set();
                    workoutGroup.workouts.forEach(workoutIndex => {
                        if (workoutIndex >= 0 && workoutIndex < this.workoutHistory.length) {
                            const workout = this.workoutHistory[workoutIndex];
                            // Solo contar workouts válidos
                            if (workout && workout.exercisesData && Object.keys(workout.exercisesData).length > 0) {
                                uniqueRoutines.add(workout.routineKey || 'unknown');
                            }
                        }
                    });
                    
                    return uniqueRoutines.size;
                },

                // Función para obtener músculos de un workout (ya existe pero por si acaso)
                getWorkoutMusclesFromWorkout(workout) {
                    if (!workout || !workout.exercisesData) return [];
                    
                    const muscles = workout.order && workout.order.length ? workout.order : Object.keys(workout.exercisesData);
                    
                    return muscles.map(muscleKey => {
                        const muscleGroup = this.muscleGroups.find(m => m.key === muscleKey);
                        return {
                            key: muscleKey,
                            label: muscleGroup ? muscleGroup.label : muscleKey,
                            color: muscleGroup ? muscleGroup.color : 'bg-gray-500'
                        };
                    });
                },
                calculateGroupVolume(workoutIndices) {
                    if (!workoutIndices || workoutIndices.length === 0) return 0;
                    
                    const validWorkouts = workoutIndices.filter(index => 
                        index >= 0 && index < this.workoutHistory.length &&
                        this.workoutHistory[index]
                    );
                    
                    if (validWorkouts.length === 0) return 0;
                    
                    const totalVolume = validWorkouts.reduce((sum, index) => {
                        const workout = this.workoutHistory[index];
                        return sum + (workout.totalVolume || 0);
                    }, 0);
                    
                    return Math.round(totalVolume / validWorkouts.length);
                },
                calculateGroupCompletion(workoutIndices) {
                    if (!workoutIndices || workoutIndices.length === 0) return 0;
                    
                    const validWorkouts = workoutIndices.filter(index => 
                        index >= 0 && index < this.workoutHistory.length &&
                        this.workoutHistory[index]
                    );
                    
                    if (validWorkouts.length === 0) return 0;
                    
                    let totalCompletion = 0;
                    let validWorkoutsCount = 0;
                    
                    validWorkouts.forEach(index => {
                        const workout = this.workoutHistory[index];
                        if (workout.sets > 0) {
                            totalCompletion += (workout.completedSets / workout.sets) * 100;
                            validWorkoutsCount++;
                        }
                    });
                    
                    return validWorkoutsCount > 0 ? Math.round(totalCompletion / validWorkoutsCount) : 0;
                },
                // Función para forzar la actualización del resumen
                refreshRoutineSummary() {
                    console.log('🔄 Actualizando resumen de rutina...');
                    
                    if (!this.currentWorkoutGroup) {
                        console.log('No hay rutina actual para actualizar');
                        return;
                    }
                    
                    // Buscar la rutina actualizada en workoutGroups
                    const currentGroupId = this.currentWorkoutGroup.id;
                    const updatedRoutine = this.workoutGroups.find(g => g.id === currentGroupId);
                    
                    if (updatedRoutine) {
                        // Actualizar la rutina actual con los datos frescos
                        this.currentWorkoutGroup = JSON.parse(JSON.stringify(updatedRoutine));
                        
                        // Forzar recálculo de los grupos
                        this.$nextTick(() => {
                            console.log('✅ Resumen de rutina actualizado:', {
                                nombre: this.currentWorkoutGroup.name,
                                workouts: this.currentWorkoutGroup.workouts?.length,
                                últimaModificación: this.currentWorkoutGroup.lastModified
                            });
                        });
                    } else {
                        console.error('❌ No se pudo encontrar la rutina actualizada:', currentGroupId);
                    }
                },

                viewGroupHistory(workoutIndices) {
                    // Aquí puedes implementar la navegación al historial específico del grupo
                    console.log('Ver historial del grupo:', workoutIndices);
                    alert('Funcionalidad de historial de grupo en desarrollo');
                },
                removeWorkoutGroupFromRoutine(groupId, workoutIndices) {
                    if (confirm(`¿Estás seguro de que quieres eliminar este grupo completo (${workoutIndices.length} entrenamientos) de la rutina?`)) {
                        const group = this.workoutGroups.find(g => g.id === groupId);
                        if (group) {
                            // Filtrar los workouts que NO están en el grupo a eliminar
                            group.workouts = group.workouts.filter(index => !workoutIndices.includes(index));
                            
                            // Si la rutina queda vacía, eliminarla
                            if (group.workouts.length === 0) {
                                this.workoutGroups = this.workoutGroups.filter(g => g.id !== groupId);
                            }
                            
                            this.saveToLocalStorage();
                            // Recargar la vista
                            this.loadWorkoutGroup(group);
                            alert('Grupo eliminado de la rutina');
                        }
                    }
                },

                getWorkoutPreview(workoutIndex) {
                const workout = this.workoutHistory[workoutIndex];
                return this.getTrainedMuscles(workout);
                },

                
                // Función para seleccionar/deseleccionar entrenamientos para el grupo
                toggleWorkoutForGroup(workoutIndex) {
                    console.log('Toggle workout:', workoutIndex); // Debug
                    const index = this.selectedWorkoutsForGroup.indexOf(workoutIndex);
                    if (index === -1) {
                        this.selectedWorkoutsForGroup.push(workoutIndex);
                    } else {
                        this.selectedWorkoutsForGroup.splice(index, 1);
                    }
                    console.log('Selected workouts:', this.selectedWorkoutsForGroup); // Debug
                },
                isWorkoutUsedInGroups(workoutIndex) {
                    for (const group of this.workoutGroups) {
                        if (group.workouts.includes(workoutIndex)) {
                            return true;
                        }
                    }
                    return false;
                },
                calculateTotalReps(workout) {
                    if (!workout || !workout.routineKey) return 1;
    
                    const routineKey = workout.routineKey;
                    let count = 0;
                    
                    this.workoutHistory.forEach(w => {
                        if (w.routineKey === routineKey) {
                            count++;
                        }
                    });
                    
                    return count;
                },

                // ==================================================
                // 5. EJERCICIOS PERSONALIZADOS
                // ==================================================
                addCustomExercise() {
                    if (!this.newCustomExerciseName || !this.newCustomExerciseMuscle) return;
                    let targetMuscle = this.newCustomExerciseMuscle;
                    if (targetMuscle === 'custom' && this.customMuscleName) {
                        const customMuscleKey = 'custom_' + this.customMuscleName.toLowerCase().replace(/\s+/g, '_');
                        if (!this.customMuscles.includes(customMuscleKey)) {
                            this.customMuscles.push(customMuscleKey);
                            if (!this.muscleGroups.find(m => m.key === customMuscleKey)) {
                                this.muscleGroups.push({
                                    key: customMuscleKey,
                                    label: this.customMuscleName,
                                    color: 'bg-gray-500'
                                });
                            }
                        }
                        targetMuscle = customMuscleKey;
                    }
                    if (!this.exercisesByMuscle[targetMuscle]) {
                        this.exercisesByMuscle[targetMuscle] = [];
                    }
                    if (!this.exercisesByMuscle[targetMuscle].includes(this.newCustomExerciseName)) {
                        this.exercisesByMuscle[targetMuscle].push(this.newCustomExerciseName);
                        this.saveCustomExercises();
                    }
                    this.newCustomExerciseName = '';
                    this.newCustomExerciseMuscle = '';
                    this.customMuscleName = '';
                    alert('Ejercicio personalizado añadido correctamente');
                },
                removeCustomExercise(muscle, exercise) {
                    if (confirm(`¿Estás seguro de que quieres eliminar el ejercicio "${exercise}"?`)) {
                        this.exercisesByMuscle[muscle] = this.exercisesByMuscle[muscle].filter(e => e !== exercise);
                        if (muscle.startsWith('custom_') && this.exercisesByMuscle[muscle].length === 0) {
                            delete this.exercisesByMuscle[muscle];
                            this.customMuscles = this.customMuscles.filter(m => m !== muscle);
                            this.muscleGroups = this.muscleGroups.filter(m => m.key !== muscle);
                        }
                        if (this.selectedExercises[muscle]) {
                            this.selectedExercises[muscle] = this.selectedExercises[muscle].filter(e => e.name !== exercise);
                            if (this.selectedExercises[muscle].length === 0) {
                                this.selectedMuscles = this.selectedMuscles.filter(m => m !== muscleKey);
                                this.selectedMuscles = [...this.selectedMuscles];
                                delete this.selectedExercises[muscle];
                            }
                        }
                        if (this.exerciseWeights[muscle]) {
                            delete this.exerciseWeights[muscle][exercise];
                        }
                        if (this.exerciseReps[muscle]) {
                            delete this.exerciseReps[muscle][exercise];
                        }
                        this.saveCustomExercises();
                        alert('Ejercicio personalizado eliminado correctamente');
                    }
                },
                isCustomExercise(muscle, exercise) {
                    const defaultExercises = {
                        chest: ['Press de banca', 'Press inclinado', 'Aperturas banca', 'Aperturas inclinadas', 'Fondos en paralelas', 'Press declinado', 'Cruces en polea alta' , 'Cruces en polea baja', 'Pullover pecho'],
                        back: ['Dominadas', 'Jalón al pecho', 'Remo invertido', 'Peso muerto', 'Remo en máquina', 'Hiperextensiones', 'Concentrado a una mano', 'Pullover espalda'],
                        shoulders: ['Press militar', 'Elevaciones laterales', 'Face pulls', 'Elevaciones frontales', 'Press Arnold', 'Pájaro', 'Cruce poleas'],
                        biceps: ['Curl de bíceps', 'Curl martillo', 'Curl concentrado', 'Curl en banco Scott', 'Curl con barra', '21'],
                        triceps: ['Fondos', 'Press francés', 'Extensiones polea alta', 'Patada de tríceps', 'Jalón de tríceps', 'Concentrado'],
                        legs: ['Sentadillas', 'Prensa', 'Prensa pies en V', 'Extensiones de cuádriceps', 'Curl femoral', 'Peso muerto rumano', 'Elevación de talones', 'Cuadriceps en pared', 'Zancada'],
                        abs: ['Crunch abdominal', 'Plancha', 'Elevaciones de piernas', 'Russian twists', 'Abdominales en bicicleta'],
                        traps: ['Encogimientos de hombros', 'Remo alto', 'Face pulls', 'Pájaros invertidos', 'Elevaciones laterales']
                    };
                        if (defaultExercises[muscle] && !defaultExercises[muscle].includes(exercise)) {
                        return true;
                    }
                    
                    // Si el músculo es personalizado (empieza con 'custom_'), es personalizado
                    if (muscle.startsWith('custom_')) {
                        return true;
                    }
                    
                    return false;
                },
                // REEMPLAZAR la función loadCustomExercises con esta versión mejorada
                loadCustomExercises() {
                    const saved = localStorage.getItem('gymApp_customExercises');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            console.log('Datos cargados de localStorage:', data);
                            
                            // Limpiar estructuras existentes primero
                            this.customMuscles = [];
                            
                            // Cargar ejercicios
                            if (data.exercises) {
                                Object.keys(data.exercises).forEach(muscle => {
                                    // Inicializar el array si no existe
                                    if (!this.exercisesByMuscle[muscle]) {
                                        this.exercisesByMuscle[muscle] = [];
                                    }
                                    
                                    // Añadir ejercicios que no existan ya
                                    data.exercises[muscle].forEach(exercise => {
                                        if (!this.exercisesByMuscle[muscle].includes(exercise)) {
                                            this.exercisesByMuscle[muscle].push(exercise);
                                        }
                                    });
                                    
                                    // Si es músculo personalizado, añadir a la lista
                                    if (muscle.startsWith('custom_')) {
                                        if (!this.customMuscles.includes(muscle)) {
                                            this.customMuscles.push(muscle);
                                        }
                                    }
                                });
                            }
                            
                            // Cargar músculos personalizados
                            if (data.customMuscles) {
                                this.customMuscles = data.customMuscles.filter(muscle => {
                                    // Solo mantener músculos que tengan ejercicios
                                    return this.exercisesByMuscle[muscle] && this.exercisesByMuscle[muscle].length > 0;
                                });
                            }
                            
                            // Cargar muscleGroups
                            if (data.muscleGroups) {
                                data.muscleGroups.forEach(muscle => {
                                    // Solo añadir si no existe ya y si tiene ejercicios
                                    const exists = this.muscleGroups.find(m => m.key === muscle.key);
                                    const hasExercises = this.exercisesByMuscle[muscle.key] && this.exercisesByMuscle[muscle.key].length > 0;
                                    
                                    if (!exists && hasExercises) {
                                        this.muscleGroups.push(muscle);
                                    }
                                });
                            }
                            
                            console.log('Ejercicios personalizados cargados:', this.exercisesByMuscle);
                            console.log('Músculos personalizados:', this.customMuscles);
                            
                        } catch (error) {
                            console.error('Error loading custom exercises:', error);
                            // En caso de error, limpiar datos corruptos
                            localStorage.removeItem('gymApp_customExercises');
                        }
                    }
                },

                regenerateDefaultData() {
                    if (confirm('¿Estás seguro de que quieres regenerar los ejercicios predeterminados? Esto no afectará tus ejercicios personalizados.')) {
                        // Restaurar ejercicios predeterminados
                        const defaultExercises = {
                            chest: ['Press de banca', 'Press inclinado', 'Aperturas banca', 'Aperturas inclinadas', 'Fondos en paralelas', 'Press declinado', 'Cruces en polea alta' , 'Cruces en polea baja', 'Pullover pecho'],
                            back: ['Dominadas', 'Jalón al pecho', 'Remo invertido', 'Peso muerto', 'Remo en máquina', 'Hiperextensiones', 'Concentrado a una mano', 'Pullover espalda'],
                            shoulders: ['Press militar', 'Elevaciones laterales', 'Face pulls', 'Elevaciones frontales', 'Press Arnold', 'Pájaro', 'Cruce poleas'],
                            biceps: ['Curl de bíceps', 'Curl martillo', 'Curl concentrado', 'Curl en banco Scott', 'Curl con barra', '21'],
                            triceps: ['Fondos', 'Press francés', 'Extensiones polea alta', 'Patada de tríceps', 'Jalón de tríceps', 'Concentrado'],
                            legs: ['Sentadillas', 'Prensa', 'Prensa pies en V', 'Extensiones de cuádriceps', 'Curl femoral', 'Peso muerto rumano', 'Elevación de talones', 'Cuadriceps en pared', 'Zancada'],
                            abs: ['Crunch abdominal', 'Plancha', 'Elevaciones de piernas', 'Russian twists', 'Abdominales en bicicleta'],
                            traps: ['Encogimientos de hombros', 'Remo alto', 'Face pulls', 'Pájaros invertidos', 'Elevaciones laterales']
                        };
                        
                        // Combinar con ejercicios personalizados existentes
                        Object.keys(defaultExercises).forEach(muscle => {
                            if (!this.exercisesByMuscle[muscle]) {
                                this.exercisesByMuscle[muscle] = [];
                            }
                            // Añadir ejercicios predeterminados que no existan ya
                            defaultExercises[muscle].forEach(exercise => {
                                if (!this.exercisesByMuscle[muscle].includes(exercise)) {
                                    this.exercisesByMuscle[muscle].push(exercise);
                                }
                            });
                        });
                        
                        // Guardar cambios
                        this.saveCustomExercises();
                        alert('Ejercicios predeterminados regenerados correctamente.');
                        this.showAdvancedMenu = false;
                    }
                },
                // REEMPLAZAR la función saveCustomExercises con esta versión mejorada
                saveCustomExercises() {
                    // Primero limpiar músculos personalizados que no tengan ejercicios
                    const validCustomMuscles = this.customMuscles.filter(muscleKey => {
                        return this.exercisesByMuscle[muscleKey] && this.exercisesByMuscle[muscleKey].length > 0;
                    });
                    
                    // Actualizar la lista de customMuscles
                    this.customMuscles = validCustomMuscles;
                    
                    // También limpiar muscleGroups de músculos personalizados sin ejercicios
                    this.muscleGroups = this.muscleGroups.filter(muscle => {
                        if (muscle.key.startsWith('custom_')) {
                            return this.exercisesByMuscle[muscle.key] && this.exercisesByMuscle[muscle.key].length > 0;
                        }
                        return true; // Mantener músculos predefinidos
                    });
                    
                    // Preparar datos para guardar
                    const exercisesToSave = {};
                    const muscleGroupsToSave = [];
                    
                    // Solo guardar músculos que tengan ejercicios
                    Object.keys(this.exercisesByMuscle).forEach(muscleKey => {
                        if (this.exercisesByMuscle[muscleKey].length > 0) {
                            exercisesToSave[muscleKey] = this.exercisesByMuscle[muscleKey];
                            
                            // Si es un músculo personalizado, asegurarse de que esté en muscleGroups
                            if (muscleKey.startsWith('custom_')) {
                                const exists = this.muscleGroups.find(m => m.key === muscleKey);
                                if (!exists) {
                                    const muscleName = muscleKey.replace('custom_', '').replace(/_/g, ' ');
                                    this.muscleGroups.push({
                                        key: muscleKey,
                                        label: muscleName,
                                        color: 'bg-gray-500'
                                    });
                                }
                            }
                        }
                    });
                    
                    // Guardar muscleGroups actualizados
                    this.muscleGroups.forEach(muscle => {
                        muscleGroupsToSave.push(muscle);
                    });
                    
                    // Guardar en localStorage
                    localStorage.setItem('gymApp_customExercises', JSON.stringify({
                        exercises: exercisesToSave,
                        customMuscles: validCustomMuscles,
                        muscleGroups: muscleGroupsToSave
                    }));
                    
                    console.log('Ejercicios personalizados guardados:', exercisesToSave);
                },
                currentTemplateOrigin: {
                    type: null, // 'routine', 'single', null
                    routineId: null,
                    workoutIndex: null
                },

                // ==================================================
                // 6. CONFIGURACIÓN DE ENTRENAMIENTO (FATIGA)
                // ==================================================
                get muscleFatigue() {
                    const fatigue = {};
                    for (const muscle of this.selectedMuscles) {
                        const exercises = this.selectedExercises[muscle] || [];
                        let totalSets = 0;
                        for (const ex of exercises) {
                            totalSets += ex.sets;
                        }
                        const maxRecommended = this.userLevel === 'beginner' ? 15 :
                                              this.userLevel === 'intermediate' ? 20 : 25;
                        fatigue[muscle] = Math.min(100, Math.round((totalSets / maxRecommended) * 100));
                    }
                    return fatigue;
                },
                get totalFatigue() {
                    if (this.selectedMuscles.length === 0) return 0;
                    let total = 0;
                    for (const muscle of this.selectedMuscles) {
                        total += this.muscleFatigue[muscle];
                    }
                    return Math.round(total / this.selectedMuscles.length);
                },
                get totalFatigueMessage() {
                    if (this.totalFatigue <= 40) {
                        return "Volumen bajo. Ideal para mantenimiento o recuperación.";
                    } else if (this.totalFatigue <= 70) {
                        return "Volumen moderado. Bueno para crecimiento muscular.";
                    } else if (this.totalFatigue <= 85) {
                        return "Volumen alto. Máximo estímulo para el crecimiento.";
                    } else {
                        return "Volumen muy alto. Riesgo de sobreentrenamiento.";
                    }
                },
                getMuscleFatigueMessage(muscle) {
                    const fatigue = this.muscleFatigue[muscle];
                    if (fatigue <= 40) {
                        return "Volumen bajo para este grupo muscular.";
                    } else if (fatigue <= 70) {
                        return "Volumen adecuado para crecimiento.";
                    } else if (fatigue <= 85) {
                        return "Volumen alto. Máximo estímulo.";
                    } else {
                        return "Volumen muy alto. Considera reducir series.";
                    }
                },
                get selectedExercisesCount() {
                    let count = 0;
                    for (const muscle of this.selectedMuscles) {
                        count += (this.selectedExercises[muscle]?.length || 0);
                    }
                    return count;
                },
                

                // ==================================================
                // 7. EJECUCIÓN DE ENTRENAMIENTO
                // ==================================================
                startWorkout() {
                    console.log('Iniciando workout - modo:', this.currentMode);
                    this.currentScreen = 'workout';
                    this.workoutTime = 0;
                    this.currentExercise = { muscle: '', name: '' };
                    this.workoutTimer = setInterval(() => {
                        this.workoutTime++;
                    }, 1000);
                },
                pauseWorkout() {
                    if (this.workoutTimer) {
                        clearInterval(this.workoutTimer);
                        this.workoutTimer = null;
                    } else {
                        this.workoutTimer = setInterval(() => {
                            this.workoutTime++;
                        }, 1000);
                    }
                },
                finishWorkout() {
                    if (this.workoutTimer) {
                        clearInterval(this.workoutTimer);
                        this.workoutTimer = null;
                    }
                    this.currentScreen = 'summary';
                },
                completeSet(muscle, exercise, setIndex) {
                    // Seguridad: obtener ejercicio y array de reps
                    const ex = this.selectedExercises[muscle]?.find(e => e.name === exercise);
                    const repsArray = this.exerciseReps[muscle] && this.exerciseReps[muscle][exercise];

                    if (!ex || !Array.isArray(repsArray)) {
                        console.log('completeSet: ejercicio o repsArray no encontrado', { muscle, exercise, setIndex });
                        return;
                    }

                    // Solo permitir completar si el usuario ha puesto reps (>0) en esa serie
                    if (repsArray[setIndex] <= 0) {
                        console.log('completeSet: reps <= 0, no se completa', { muscle, exercise, setIndex });
                        return;
                    }

                    // Marcar sets completadas hasta el índice actual
                    ex.completed = repsArray.filter((r, idx) => idx <= setIndex && r > 0).length;
                    this.playCompletionSound();

                    // Mantener ejercicio activo
                    this.currentExercise = { muscle, name: exercise };

                    // ✅ TEMPORIZADOR SIMPLIFICADO - SALTA SIEMPRE
                    if (this.restTimerConfig.enabled) {
                        console.log('Activando temporizador después de completar serie');
                        
                        // Determinar la siguiente serie
                        const nextSetIndex = setIndex + 1;
                        
                        // Si hay más series en este ejercicio, temporizador para la siguiente serie
                        if (nextSetIndex < ex.sets) {
                            this.startRestTimer(muscle, exercise, nextSetIndex, ex.sets, 'set');
                        }
                        // Si es la última serie del ejercicio, temporizador para reiniciar
                        else {
                            this.startRestTimer(muscle, exercise, 0, ex.sets, 'set');
                        }
                    }
                },
                // Función para completar serie con efecto visual
                completeSetWithVisual(muscle, exercise, setIndex) {
                    // Ejecutar la función original
                    this.completeSet(muscle, exercise, setIndex);
                    
                    // Marcar como completado visualmente
                    const key = `${muscle}_${exercise}_${setIndex}`;
                    if (!this.completedSetsState) {
                        this.completedSetsState = {};
                    }
                    this.completedSetsState[key] = true;
                },
                isSetCompletedVisually(muscle, exercise, setIndex) {
                    const key = `${muscle}_${exercise}_${setIndex}`;
                    return this.completedSetsState && this.completedSetsState[key] === true;
                },

                // Obtener clase del botón basado en estado
                getCompleteButtonClass(muscle, exercise, setIndex) {
                    const isCompleted = this.isSetCompletedVisually(muscle, exercise, setIndex);
                    
                    if (isCompleted) {
                        return 'bg-blue-700 border-2 border-blue-800 text-white cursor-default';
                    } else {
                        return 'bg-green-600 hover:bg-green-500 text-white';
                    }
                },
                // Función para verificar si una serie está completada
                isSetCompleted(muscle, exercise, setIndex) {
                    const reps = this.exerciseReps[muscle]?.[exercise]?.[setIndex];
                    return reps > 0;
                },

                startRestTimer(muscle, exercise, nextSetIndex, totalSets, timerType = 'set') {
                    console.log('Iniciando temporizador de descanso:', { muscle, exercise, nextSetIndex, totalSets, timerType });

                    // Limpiar temporizador previo si existe
                    if (this.restTimer) {
                        clearInterval(this.restTimer);
                        this.restTimer = null;
                    }

                    this.isRestTimerActive = true;
                    
                    // ✅ SIEMPRE usa la duración entre series (eliminada la lógica de músculo)
                    const duration = Number(this.restTimerConfig.duration) || 60;
                    
                    this.restTimeRemaining = duration;

                    // Guardar info simplificada
                    this.currentSetInfo = {
                        muscle,
                        exercise,
                        setIndex: nextSetIndex,
                        setNumber: nextSetIndex + 1,
                        totalSets,
                        timerType: 'set', // ✅ SIEMPRE 'set'
                        isLastSet: nextSetIndex === totalSets - 1
                    };

                    console.log('Información del temporizador:', this.currentSetInfo);

                    this.restTimer = setInterval(() => {
                        this.restTimeRemaining--;

                        // Sonidos de cuenta atrás
                        if (this.restTimerConfig.soundEnabled) {
                            if (this.restTimeRemaining === 10) {
                                this.playCountdownSound(800);
                            } else if (this.restTimeRemaining <= 5 && this.restTimeRemaining > 0) {
                                this.playCountdownSound(600);
                            } else if (this.restTimeRemaining === 0) {
                                this.playCountdownSound(1200);
                            }
                        }

                        if (this.restTimeRemaining <= 0) {
                            console.log('Temporizador terminado automáticamente');
                            this.stopRestTimerWithAnimation();
                        }
                    }, 1000);
                },
                stopRestTimerWithAnimation() {
                    console.log('Deteniendo temporizador con animación');
                    
                    // Primero reproducir sonido de finalización
                    if (this.restTimerConfig.soundEnabled) {
                        this.playCompletionSound();
                    }
                    
                    // Iniciar animación de desvanecimiento
                    this.startFadeOutAnimation();
                },
                startFadeOutAnimation() {
                    let opacity = 1;
                    const fadeInterval = setInterval(() => {
                        opacity -= 0.05;
                        
                        // Actualizar visualmente la opacidad del modal
                        const modalContainer = document.querySelector('.modal-overlay.active .modal-container');
                        if (modalContainer) {
                            modalContainer.style.opacity = opacity;
                        }
                        
                        if (opacity <= 0) {
                            clearInterval(fadeInterval);
                            this.completeRestTimer();
                        }
                    }, 50);
                },
                completeRestTimer() {
                    // Limpiar intervalo del temporizador
                    if (this.restTimer) {
                        clearInterval(this.restTimer);
                        this.restTimer = null;
                    }
                    
                    // Resetear estado
                    this.isRestTimerActive = false;
                    this.restTimeRemaining = 0;
                    
                    // Notificación opcional
                    if ('Notification' in window && Notification.permission === 'granted') {
                        let message = '';
                        const info = this.currentSetInfo;
                        
                        if (info.timerType === 'set') {
                            message = `¡Listo para la serie ${info.setNumber} de ${info.exercise}!`;
                        } else if (info.timerType === 'exercise') {
                            message = `¡Listo para empezar ${info.exercise}!`;
                        } else if (info.timerType === 'muscle') {
                            message = `¡Listo para trabajar ${this.getMuscleLabel(info.muscle)}!`;
                        }
                        
                        new Notification('Descanso terminado', { body: message });
                    }

                    // Activar automáticamente el siguiente ejercicio/músculo
                    if (this.currentSetInfo.muscle && this.currentSetInfo.exercise) {
                        this.currentExercise = { 
                            muscle: this.currentSetInfo.muscle, 
                            name: this.currentSetInfo.exercise 
                        };
                    }
                },
                getTimerTitle() {
                    if (!this.currentSetInfo.timerType) return 'Tiempo de Descanso';
                    
                    switch(this.currentSetInfo.timerType) {
                        case 'set':
                            return 'Descanso entre Series';
                        case 'exercise':
                            return 'Cambio de Ejercicio';
                        case 'muscle':
                            return 'Cambio de Músculo';
                        default:
                            return 'Tiempo de Descanso';
                    }
                },

                getTimerSubtitle() {
                    const info = this.currentSetInfo;
                    if (!info.timerType) return '';
                    
                    switch(info.timerType) {
                        case 'set':
                            return `Serie ${info.setNumber} de ${info.totalSets}`;
                        case 'exercise':
                            return `Siguiente: ${info.exercise}`;
                        case 'muscle':
                            return `Siguiente: ${this.getMuscleLabel(info.muscle)}`;
                        default:
                            return '';
                    }
                },
                getTimerProgress() {
                    if (!this.currentSetInfo.timerType) return 0;
                    
                    let totalDuration;
                    if (this.currentSetInfo.timerType === 'muscle') {
                        totalDuration = Number(this.restTimerConfig.muscleRestDuration) || 120;
                    } else {
                        totalDuration = Number(this.restTimerConfig.duration) || 60;
                    }
                    
                    return ((totalDuration - this.restTimeRemaining) / totalDuration) * 100;
                },
                stopRestTimer() {
                    console.log('Deteniendo temporizador manualmente');
                    
                    // Limpiar intervalo
                    if (this.restTimer) {
                        clearInterval(this.restTimer);
                        this.restTimer = null;
                    }
                    
                    // Resetear estado inmediatamente
                    this.isRestTimerActive = false;
                    this.restTimeRemaining = 0;
                    
                    // Resetear opacidad del modal si existe
                    const modalContainer = document.querySelector('.modal-overlay.active .modal-container');
                    if (modalContainer) {
                        modalContainer.style.opacity = '1';
                    }
                },
                playCountdownSound(frequency) {
                    if (!this.restTimerConfig.soundEnabled) return;
                    
                    try {
                        if (!this.audioContext) {
                            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        }
                        
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        
                        // Configurar el sonido
                        oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                        
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + 0.2);
                        
                    } catch (error) {
                        console.log('Error reproduciendo sonido de cuenta atrás:', error);
                    }
                },
                markExerciseAsCurrent(muscle, exercise) {
                    this.currentExercise = { muscle, name: exercise };
                    this.playCompletionSound();
                    
                    // Mostrar notificación de ejercicio activado
                    setTimeout(() => {
                        alert(`Ejercicio "${exercise}" activado. Los demás ejercicios están bloqueados para evitar errores.`);
                    }, 300);
                },
                markExerciseAsCompleted(muscle, exercise) {
                    const ex = this.selectedExercises[muscle].find(e => e.name === exercise);
                    if (ex) {
                        ex.completed = ex.sets;
                        for (let i = 0; i < ex.sets; i++) {
                            if (this.exerciseReps[muscle][exercise][i] === 0) {
                                this.exerciseReps[muscle][exercise][i] = 1;
                            }
                        }
                        this.playCompletionSound();
                    }
                },
                updateSetData(muscle, exercise, setIndex) {
                    const weight = this.exerciseWeights[muscle][exercise][setIndex];
                    const reps = this.exerciseReps[muscle][exercise][setIndex];
                    if (reps > 0 && weight <= 0) {
                        this.exerciseWeights[muscle][exercise][setIndex] = 10;
                    }
                    const ex = this.selectedExercises[muscle].find(e => e.name === exercise);
                    if (ex) {
                        const completedSets = this.exerciseReps[muscle][exercise].filter(reps => reps > 0).length;
                        ex.completed = completedSets;
                    }
                },
                getMuscleCompletedExercises(muscle) {
                    if (!this.selectedExercises[muscle]) return 0;
                    
                    let completedCount = 0;
                    this.selectedExercises[muscle].forEach(exercise => {
                        if (exercise.completed === exercise.sets && exercise.completed > 0) {
                            completedCount++;
                        }
                    });
                    
                    return completedCount;
                },

                // ==================================================
                // 8. RESUMEN Y GUARDADO DE ENTRENAMIENTO
                // ==================================================
                get totalExercises() {
                    let count = 0;
                    for (const muscle of this.selectedMuscles) {
                        count += (this.selectedExercises[muscle]?.length || 0);
                    }
                    return count;
                },
                get totalSets() {
                    let count = 0;
                    for (const muscle of this.selectedMuscles) {
                        for (const ex of this.selectedExercises[muscle] || []) {
                            count += ex.sets;
                        }
                    }
                    return count;
                },
                // FUNCIONES PARA EL RESUMEN
                getMuscleCompletedSets(muscle) {
                    let completed = 0;
                    if (this.selectedExercises[muscle]) {
                        for (const exercise of this.selectedExercises[muscle]) {
                            completed += exercise.completed || 0;
                        }
                    }
                    return completed;
                },

                getMuscleTotalSets(muscle) {
                    let total = 0;
                    if (this.selectedExercises[muscle]) {
                        for (const exercise of this.selectedExercises[muscle]) {
                            total += exercise.sets || 0;
                        }
                    }
                    return total;
                },

                createWorkoutGroup() {
                    console.log('=== CREANDO NUEVA RUTINA ===');
                    
                    if (!this.newWorkoutGroupName.trim()) {
                        alert('⚠️ Por favor, ingresa un nombre para la rutina.');
                        return;
                    }
                    
                    if (this.selectedGroupsForWorkoutGroup.length === 0) {
                        alert('⚠️ Selecciona al menos un grupo de entrenamiento.');
                        return;
                    }

                    // Obtener todos los workouts de los grupos seleccionados
                    const allWorkoutIndices = [];
                    const groupedWorkouts = this.getGroupedManualWorkouts();
                    
                    this.selectedGroupsForWorkoutGroup.forEach(groupKey => {
                        const group = groupedWorkouts.find(g => g.routineKey === groupKey);
                        if (group && group.allWorkouts) {
                            group.allWorkouts.forEach(workout => {
                                if (workout.originalIndex !== undefined) {
                                    allWorkoutIndices.push(workout.originalIndex);
                                    console.log(`✓ Añadiendo workout ${workout.originalIndex} del grupo ${groupKey}`);
                                }
                            });
                        }
                    });

                    // Eliminar duplicados
                    const uniqueWorkoutIndices = [...new Set(allWorkoutIndices)];
                    
                    console.log('Índices únicos para la rutina:', uniqueWorkoutIndices);

                    if (uniqueWorkoutIndices.length === 0) {
                        alert('❌ No se encontraron entrenamientos válidos para la rutina.');
                        return;
                    }

                    // Crear el nuevo grupo
                    const newGroup = {
                        id: 'group_' + Date.now(),
                        name: this.newWorkoutGroupName.trim(),
                        workouts: uniqueWorkoutIndices,
                        createdFrom: 'manual',
                        creationDate: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    };

                    console.log('Nueva rutina creada:', newGroup);

                    // Añadir a la lista de grupos
                    this.workoutGroups.push(newGroup);
                    this.saveToLocalStorage();
                    
                    // Cerrar modal y limpiar
                    this.showCreateWorkoutGroupModal = false;
                    this.selectedGroupsForWorkoutGroup = [];
                    this.newWorkoutGroupName = '';
                    
                    // Mostrar confirmación
                    alert(`✅ Rutina "${newGroup.name}" creada correctamente con ${uniqueWorkoutIndices.length} entrenamientos.`);
                    
                    console.log('Rutina guardada en localStorage');
                },

                // MEJORAR la función saveWorkoutAndRedirect para garantizar orden consistente
                saveWorkoutAndRedirect() {
                    console.log('=== GUARDANDO WORKOUT ===');
                    console.log('Orden actual de músculos:', this.selectedMuscles);

                    // VALIDACIÓN CRÍTICA: Verificar que hay datos reales antes de guardar
                    let hasValidData = false;
                    let completedSetsCount = 0;
                    
                    for (const muscle of this.selectedMuscles) {
                        for (const ex of this.selectedExercises[muscle] || []) {
                            const reps = this.exerciseReps[muscle]?.[ex.name] || [];
                            const completedSets = reps.filter(rep => rep > 0).length;
                            completedSetsCount += completedSets;
                            
                            if (completedSets > 0) {
                                hasValidData = true;
                            }
                        }
                    }
                    
                    console.log('Sets completados encontrados:', completedSetsCount);
                    console.log('¿Tiene datos válidos?:', hasValidData);

                    // Si no hay datos válidos, preguntar al usuario
                    if (!hasValidData) {
                        const userChoice = confirm('⚠️ No hay series completadas en este entrenamiento. ¿Estás seguro de que quieres guardarlo como vacío?');
                        if (!userChoice) {
                            console.log('Guardado cancelado por el usuario');
                            return; // Cancelar guardado si el usuario no confirma
                        }
                        console.log('Usuario confirmó guardar workout vacío');
                    }

                    // Guardar el origen ANTES de resetear
                    const originType = this.currentTemplateOrigin.type;
                    const originRoutineId = this.currentTemplateOrigin.routineId;

                    console.log('Origen del workout:', { originType, originRoutineId });

                    // Determinar routineKey
                    let finalRoutineKey;
                    if (originType === 'routine' && this.viewedWorkout) {
                        finalRoutineKey = this.viewedWorkout.routineKey;
                        console.log('Forzando routineKey desde plantilla:', finalRoutineKey);
                    } else {
                        finalRoutineKey = this.getRoutineKeyFromCurrent();
                    }

                    const workout = {
                        date: new Date().toISOString(),
                        level: this.userLevel,
                        time: this.workoutTime,
                        muscles: this.selectedMuscles.length,
                        exercises: this.totalExercises,
                        sets: this.totalSets,
                        completedSets: this.completedSets,
                        totalVolume: this.totalVolume,
                        mode: 'manual',
                        exercisesData: {},
                        order: [...this.selectedMuscles], // ← Orden canónico (sin inversión)
                        routineKey: finalRoutineKey,
                        templateOrigin: { ...this.currentTemplateOrigin }
                    };

                    console.log('✅ Orden guardado en workout:', workout.order);

                    // Guardar ejercicios respetando el orden
                    for (const muscle of this.selectedMuscles) {
                        workout.exercisesData[muscle] = [];
                        for (const ex of this.selectedExercises[muscle] || []) {
                            const exerciseData = {
                                name: ex.name,
                                sets: ex.sets,
                                completed: ex.completed,
                                volume: this.calculateExerciseVolume(muscle, ex.name),
                                setsData: []
                            };
                            for (let i = 0; i < ex.sets; i++) {
                                const weight = this.exerciseWeights[muscle]?.[ex.name]?.[i] || 0;
                                const reps = this.exerciseReps[muscle]?.[ex.name]?.[i] || 0;
                                exerciseData.setsData.push({
                                    weight: weight,
                                    reps: reps,
                                    completed: reps > 0
                                });
                            }
                            workout.exercisesData[muscle].push(exerciseData);
                        }
                    }

                    // VALIDACIÓN FINAL: Verificar que el workout tiene datos coherentes
                    const isValidWorkout = workout.exercisesData && 
                                        Object.keys(workout.exercisesData).length > 0 &&
                                        workout.sets > 0 &&
                                        workout.exercises > 0;
                    
                    if (!isValidWorkout) {
                        console.error('❌ Workout inválido detectado, cancelando guardado:', {
                            exercisesData: workout.exercisesData,
                            sets: workout.sets,
                            exercises: workout.exercises
                        });
                        alert('Error: No se puede guardar un entrenamiento sin ejercicios o series.');
                        return;
                    }

                    // Añadir al historial
                    const newWorkoutIndex = this.workoutHistory.length;
                    this.workoutHistory.push(workout);

                    // Si viene de una rutina, añadirlo automáticamente
                    let updatedRoutine = null;
                    if (originType === 'routine') {
                        const routine = this.workoutGroups.find(g => g.id === originRoutineId);
                        if (routine) {
                            if (!routine.workouts) routine.workouts = [];
                            routine.workouts.push(newWorkoutIndex);
                            routine.lastModified = new Date().toISOString();
                            updatedRoutine = routine;
                            console.log('Workout añadido automáticamente a la rutina:', routine.name);
                        } else {
                            console.error('❌ Rutina no encontrada:', originRoutineId);
                        }
                    }

                    this.saveToLocalStorage();

                    // VERIFICACIÓN POST-GUARDADO
                    const savedWorkout = this.workoutHistory[newWorkoutIndex];
                    console.log('✅ Workout guardado - Verificación:', {
                        index: newWorkoutIndex,
                        exercises: savedWorkout.exercises,
                        sets: savedWorkout.sets,
                        volume: savedWorkout.totalVolume,
                        completedSets: savedWorkout.completedSets
                    });

                    // Resetear estado
                    this.userLevel = '';
                    this.selectedMuscles = [];
                    this.selectedExercises = {};
                    this.exerciseWeights = {};
                    this.exerciseReps = {};
                    this.workoutTime = 0;
                    this.currentExercise = { muscle: '', name: '' };

                    // NAVEGACIÓN Y ACTUALIZACIÓN DEL RESUMEN
                    this.$nextTick(() => {
                        if (originType === 'routine' && originRoutineId) {
                            console.log('🔄 Navegando a historial de rutina:', originRoutineId);
                            
                            // ACTUALIZAR EL RESUMEN DE LA RUTINA ANTES DE NAVEGAR
                            if (updatedRoutine) {
                                // Forzar la actualización de la rutina actual
                                this.currentWorkoutGroup = JSON.parse(JSON.stringify(updatedRoutine));
                                console.log('✅ Rutina actual actualizada con nuevo workout');
                            }
                            
                            // Navegar al historial de la rutina
                            this.viewRoutineHistory(originRoutineId);
                            
                            // ACTUALIZACIÓN ADICIONAL PARA GARANTIZAR QUE SE VEA EL CAMBIO
                            setTimeout(() => {
                                this.refreshRoutineSummary();
                            }, 300);
                            
                        } else {
                            console.log('🔄 Navegando a ejercicios sueltos');
                            this.currentView = {
                                type: 'all',
                                routineId: null,
                                filter: 'current'
                            };
                            this.currentScreen = 'history-manual';
                        }
                        
                        // Resetear el origen después de la navegación
                        this.currentTemplateOrigin = { type: null, routineId: null, workoutIndex: null };
                    });

                    setTimeout(() => {
                        alert('✅ Entrenamiento guardado correctamente con el orden preservado.');
                    }, 100);
                },
                // Función para limpiar workouts fantasma existentes
                cleanupGhostWorkouts() {
                    const initialCount = this.workoutHistory.length;
                    
                    this.workoutHistory = this.workoutHistory.filter(workout => {
                        const isValid = workout.exercisesData && 
                                    Object.keys(workout.exercisesData).length > 0 &&
                                    workout.sets > 0;
                        
                        return isValid;
                    });
                    
                    const removedCount = initialCount - this.workoutHistory.length;
                    
                    if (removedCount > 0) {
                        this.saveToLocalStorage();
                        console.log(`🧹 Limpiados ${removedCount} workouts fantasma`);
                        alert(`Se eliminaron ${removedCount} entrenamientos vacíos o corruptos.`);
                    } else {
                        console.log('✅ No se encontraron workouts fantasma');
                    }
                    
                    return removedCount;
                },
                // Función para verificar que todos los workouts de una rutina tienen la misma routineKey
                verifyRoutineConsistency(routineId) {
                    const routine = this.workoutGroups.find(g => g.id === routineId);
                    if (!routine || !routine.workouts) return;
                    
                    const routineKeys = new Set();
                    
                    routine.workouts.forEach(workoutIndex => {
                        if (workoutIndex >= 0 && workoutIndex < this.workoutHistory.length) {
                            const workout = this.workoutHistory[workoutIndex];
                            if (workout.routineKey) {
                                routineKeys.add(workout.routineKey);
                            }
                        }
                    });
                    
                    console.log(`Rutina ${routine.name} - RoutineKeys únicas:`, Array.from(routineKeys));
                    
                    if (routineKeys.size > 1) {
                        console.warn('⚠️ ADVERTENCIA: La rutina tiene workouts con diferentes routineKeys');
                        // Opcional: Corregir automáticamente
                        this.fixRoutineKeys(routineId);
                    }
                },

                // Función para corregir las routineKeys de una rutina
                fixRoutineKeys(routineId) {
                    const routine = this.workoutGroups.find(g => g.id === routineId);
                    if (!routine || !routine.workouts) return;
                    
                    // Encontrar la routineKey más común
                    const keyCounts = {};
                    routine.workouts.forEach(workoutIndex => {
                        if (workoutIndex >= 0 && workoutIndex < this.workoutHistory.length) {
                            const workout = this.workoutHistory[workoutIndex];
                            if (workout.routineKey) {
                                keyCounts[workout.routineKey] = (keyCounts[workout.routineKey] || 0) + 1;
                            }
                        }
                    });
                    
                    const mostCommonKey = Object.keys(keyCounts).reduce((a, b) => 
                        keyCounts[a] > keyCounts[b] ? a : b
                    );
                    
                    console.log('Corrigiendo routineKeys a:', mostCommonKey);
                    
                    // Aplicar la corrección
                    routine.workouts.forEach(workoutIndex => {
                        if (workoutIndex >= 0 && workoutIndex < this.workoutHistory.length) {
                            this.workoutHistory[workoutIndex].routineKey = mostCommonKey;
                        }
                    });
                    
                    this.saveToLocalStorage();
                },
                toggleGroupForWorkoutGroup(groupKey) {
                    const index = this.selectedGroupsForWorkoutGroup.indexOf(groupKey);
                    if (index === -1) {
                        this.selectedGroupsForWorkoutGroup.push(groupKey);
                    } else {
                        this.selectedGroupsForWorkoutGroup.splice(index, 1);
                    }
                },
                isGroupSelected(groupKey) {
                    return this.selectedGroupsForWorkoutGroup.includes(groupKey);
                },

                // Asegurar que las propiedades computadas funcionen correctamente
                get totalVolume() {
                    let volume = 0;
                    for (const muscle of this.selectedMuscles) {
                        for (const ex of this.selectedExercises[muscle] || []) {
                            volume += this.calculateExerciseVolume(muscle, ex.name);
                        }
                    }
                    return volume;
                },

                get completedSets() {
                    let count = 0;
                    for (const muscle of this.selectedMuscles) {
                        for (const ex of this.selectedExercises[muscle] || []) {
                            count += ex.completed || 0;
                        }
                    }
                    return count;
                },

                get completedExercises() {
                    let count = 0;
                    for (const muscle of this.selectedMuscles) {
                        for (const ex of this.selectedExercises[muscle] || []) {
                            if (ex.completed === ex.sets) {
                                count++;
                            }
                        }
                    }
                    return count;
                },

                get workoutProgress() {
                    if (this.totalSets === 0) return 0;
                    return Math.round((this.completedSets / this.totalSets) * 100);
                },
                calculateExerciseVolume(muscle, exercise) {
                    const weights = this.exerciseWeights[muscle][exercise] || [];
                    const reps = this.exerciseReps[muscle][exercise] || [];
                    let volume = 0;
                    for (let i = 0; i < weights.length; i++) {
                        if (i < reps.length && reps[i] > 0) {
                            volume += weights[i] * reps[i];
                        }
                    }
                    return volume;
                },

                calculateMuscleVolume(muscle) {
                    let volume = 0;
                    for (const ex of this.selectedExercises[muscle] || []) {
                        volume += this.calculateExerciseVolume(muscle, ex.name);
                    }
                    return volume;
                },
                
                removeExercise(muscle, exercise) {
                    if (confirm(`¿Estás seguro de que quieres eliminar el ejercicio "${exercise}"?`)) {
                        
                        // Guardar estado actual para determinar navegación después
                        const wasSelected = this.isExerciseSelected(muscle, exercise);
                        const hadOtherExercises = this.exercisesByMuscle[muscle] && 
                                                this.exercisesByMuscle[muscle].length > 1;
                        const isLastExerciseInMuscle = this.exercisesByMuscle[muscle] && 
                                                    this.exercisesByMuscle[muscle].length === 1;
                        const isCustomMuscle = muscle.startsWith('custom_');

                        // 1. Eliminar de exercisesByMuscle
                        if (this.exercisesByMuscle[muscle]) {
                            this.exercisesByMuscle[muscle] = this.exercisesByMuscle[muscle].filter(e => e !== exercise);
                            
                            // Si es músculo personalizado y no quedan ejercicios, eliminar el músculo
                            if (isCustomMuscle && this.exercisesByMuscle[muscle].length === 0) {
                                delete this.exercisesByMuscle[muscle];
                                this.customMuscles = this.customMuscles.filter(m => m !== muscle);
                                this.muscleGroups = this.muscleGroups.filter(m => m.key !== muscle);
                                
                                // También eliminar de selectedMuscles si estaba seleccionado
                                if (this.selectedMuscles.includes(muscle)) {
                                    this.selectedMuscles = this.selectedMuscles.filter(m => m !== muscleKey);
                                    this.selectedMuscles = [...this.selectedMuscles];
                                    delete this.selectedExercises[muscle];
                                }
                            }
                        }

                        // 2. Eliminar de selectedExercises si está seleccionado
                        if (this.selectedExercises[muscle]) {
                            this.selectedExercises[muscle] = this.selectedExercises[muscle].filter(e => e.name !== exercise);
                            if (this.selectedExercises[muscle].length === 0) {
                                delete this.selectedExercises[muscle];
                                // No eliminar de selectedMuscles aquí para mantener la pantalla actual
                            }
                        }

                        // 3. Eliminar datos de pesos y reps
                        if (this.exerciseWeights[muscle]) {
                            delete this.exerciseWeights[muscle][exercise];
                        }
                        if (this.exerciseReps[muscle]) {
                            delete this.exerciseReps[muscle][exercise];
                        }

                        // 4. Guardar cambios si es ejercicio personalizado
                        if (this.isCustomExercise(muscle, exercise)) {
                            this.saveCustomExercises();
                        }

                        // 5. Determinar navegación después de eliminar
                        setTimeout(() => {
                            // Caso 1: Se eliminó el último ejercicio de un músculo personalizado
                            if (isCustomMuscle && isLastExerciseInMuscle) {
                                if (this.selectedMuscles.length === 0) {
                                    // No hay más músculos seleccionados, ir a selección de músculos
                                    this.currentScreen = 'muscles';
                                    alert('Se eliminó el último ejercicio del grupo muscular personalizado. Redirigiendo a selección de músculos.');
                                } else {
                                    // Hay otros músculos seleccionados, permanecer en ejercicios
                                    alert('Se eliminó el grupo muscular personalizado porque no tenía más ejercicios.');
                                }
                            }
                            // Caso 2: Se eliminó un ejercicio pero quedan más en el músculo
                            else if (hadOtherExercises && wasSelected) {
                                // Permanecer en la pantalla de ejercicios
                                alert('Ejercicio eliminado correctamente.');
                            }
                            // Caso 3: Se eliminó el último ejercicio de un músculo no personalizado
                            else if (isLastExerciseInMuscle && !isCustomMuscle) {
                                alert('Ejercicio eliminado. Este grupo muscular ya no tiene ejercicios disponibles.');
                            }
                            // Caso 4: Ejercicio no seleccionado fue eliminado
                            else {
                                alert('Ejercicio eliminado correctamente.');
                            }
                        }, 100);

                        // 6. Forzar actualización de la interfaz
                        this.$nextTick(() => {
                            // Actualizar cálculos de fatiga
                            this.muscleFatigue;
                            this.totalFatigue;
                        });
                    }
                },
                // REEMPLAZAR la función removeCustomMuscle con esta versión mejorada
                removeCustomMuscle(muscleKey) {
                    if (!muscleKey.startsWith('custom_')) {
                        alert('Solo puedes eliminar grupos musculares personalizados.');
                        return;
                    }
                    
                    // Obtener el nombre legible del músculo para el mensaje
                    const muscleName = this.getMuscleLabel(muscleKey);
                    
                    // Contar ejercicios en este músculo
                    const exerciseCount = this.exercisesByMuscle[muscleKey] ? this.exercisesByMuscle[muscleKey].length : 0;
                    
                    let message = `¿Estás seguro de que quieres eliminar el grupo muscular "${muscleName}"?`;
                    if (exerciseCount > 0) {
                        message += `\n\nSe eliminarán también ${exerciseCount} ejercicio(s) asociado(s).`;
                    }
                    
                    if (confirm(message)) {
                        console.log(`Eliminando músculo personalizado: ${muscleKey}`);
                        
                        // 1. Eliminar de selectedMuscles si está seleccionado
                        if (this.selectedMuscles.includes(muscleKey)) {
                            this.selectedMuscles = this.selectedMuscles.filter(m => m !== muscleKey);
                            this.selectedMuscles = [...this.selectedMuscles];
                            console.log(`Eliminado de selectedMuscles: ${muscleKey}`);
                        }
                        
                        // 2. Eliminar de selectedExercises
                        if (this.selectedExercises[muscleKey]) {
                            delete this.selectedExercises[muscleKey];
                            console.log(`Eliminado de selectedExercises: ${muscleKey}`);
                        }
                        
                        // 3. Eliminar ejercicios asociados de exercisesByMuscle
                        if (this.exercisesByMuscle[muscleKey]) {
                            delete this.exercisesByMuscle[muscleKey];
                            console.log(`Eliminados ejercicios de exercisesByMuscle: ${muscleKey}`);
                        }
                        
                        // 4. Eliminar de customMuscles
                        this.customMuscles = this.customMuscles.filter(m => m !== muscleKey);
                        console.log(`Eliminado de customMuscles: ${muscleKey}`);
                        
                        // 5. Eliminar de muscleGroups
                        this.muscleGroups = this.muscleGroups.filter(m => m.key !== muscleKey);
                        console.log(`Eliminado de muscleGroups: ${muscleKey}`);
                        
                        // 6. Eliminar datos de pesos y reps
                        if (this.exerciseWeights[muscleKey]) {
                            delete this.exerciseWeights[muscleKey];
                            console.log(`Eliminado de exerciseWeights: ${muscleKey}`);
                        }
                        if (this.exerciseReps[muscleKey]) {
                            delete this.exerciseReps[muscleKey];
                            console.log(`Eliminado de exerciseReps: ${muscleKey}`);
                        }
                        
                        // 7. Guardar cambios
                        this.saveCustomExercises();
                        console.log('Cambios guardados en localStorage');
                        
                        alert(`Grupo muscular "${muscleName}" eliminado correctamente.`);
                    }
                },

                

                getRoutineKeyFromCurrent() {
                    const parts = [];
                    // ✅ Usar this.selectedMuscles en el orden real (sin invertir, sin sort)
                    for (const muscle of this.selectedMuscles) {
                        const exercises = this.selectedExercises[muscle] || [];
                        if (exercises.length === 0) continue;
                        const exParts = exercises.map(ex => `${ex.name}|${ex.sets}`).join(',');
                        parts.push(`${muscle}:${exParts}`);
                    }
                    return parts.join(';');
                },

                // AÑADIR función auxiliar para generar routineKey desde un orden específico
                generateRoutineKeyFromOrder(muscleOrder) {
                    const routineParts = [];
                    
                    muscleOrder.forEach(muscle => {
                        if (this.selectedExercises[muscle]) {
                            const exercisesWithSets = this.selectedExercises[muscle].map(ex => {
                                return `${ex.name}|${ex.sets || 0}`;
                            });
                            routineParts.push(`${muscle}:${exercisesWithSets.join(',')}`);
                        }
                    });
                    
                    return routineParts.join(';');
                },
                // Función para ordenar los días de la semana correctamente
                getSortedDays(daysArray) {
                    const dayOrder = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                    if (!Array.isArray(daysArray)) {
                        return [];
                    }
                    return [...daysArray].sort((a, b) => {
                        const indexA = dayOrder.indexOf(a);
                        const indexB = dayOrder.indexOf(b);
                        // Si un día no está en dayOrder, lo ponemos al final
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                },
                // ==================================================
                // NUEVO: SISTEMA UNIFICADO DE HISTORIAL
                // ==================================================

                // REEMPLAZAR completamente la función getFilteredWorkouts
                getFilteredWorkouts() {
                    console.log('=== FILTRANDO WORKOUTS - VERSIÓN CORREGIDA ===');
                    console.log('Vista actual:', this.currentView.type);
                    console.log('Total workouts en historial:', this.workoutHistory.length);
                    
                    // 1. Obtener todos los índices de workouts que están en rutinas
                    const workoutsInRoutines = new Set();
                    this.workoutGroups.forEach(group => {
                        if (group.workouts && Array.isArray(group.workouts)) {
                            group.workouts.forEach(index => {
                                if (index >= 0 && index < this.workoutHistory.length) {
                                    workoutsInRoutines.add(index);
                                }
                            });
                        }
                    });
                    
                    console.log('Workouts en rutinas:', Array.from(workoutsInRoutines));

                    // 2. Filtrar según el tipo de vista
                    let baseWorkouts = [];
                    
                    if (this.currentView.type === 'all') {
                        // SOLO los sueltos (NO en rutinas)
                        baseWorkouts = this.workoutHistory
                            .map((w, idx) => ({ ...w, originalIndex: idx }))
                            .filter(w => !workoutsInRoutines.has(w.originalIndex));
                        
                        console.log('Workouts sueltos encontrados:', baseWorkouts.length);
                    } 
                    else if (this.currentView.type === 'routine') {
                        // Solo los de la rutina específica
                        const routine = this.workoutGroups.find(g => g.id === this.currentView.routineId);
                        if (routine && routine.workouts) {
                            baseWorkouts = routine.workouts
                                .map(idx => {
                                    if (idx >= 0 && idx < this.workoutHistory.length && workoutsInRoutines.has(idx)) {
                                        return { ...this.workoutHistory[idx], originalIndex: idx };
                                    }
                                    return null;
                                })
                                .filter(Boolean);
                        }
                        console.log('Workouts en rutina específica:', baseWorkouts.length);
                    }

                    // 3. FILTRAR WORKOUTS FANTASMA O VACÍOS
                    const validWorkouts = baseWorkouts.filter(workout => {
                        // Verificar que el workout tenga datos válidos
                        const hasExercisesData = workout.exercisesData && 
                                                Object.keys(workout.exercisesData).length > 0;
                        
                        const hasValidSets = workout.sets > 0;
                        const hasValidExercises = workout.exercises > 0;
                        const hasValidVolume = workout.totalVolume >= 0; // Permitir 0 pero no undefined/null
                        
                        const isValid = hasExercisesData && hasValidSets && hasValidExercises && hasValidVolume;
                        
                        if (!isValid) {
                            console.log('❌ Workout excluido por datos inválidos:', {
                                originalIndex: workout.originalIndex,
                                date: workout.date,
                                hasExercisesData: hasExercisesData,
                                sets: workout.sets,
                                exercises: workout.exercises,
                                volume: workout.totalVolume,
                                exercisesDataKeys: workout.exercisesData ? Object.keys(workout.exercisesData) : 'none'
                            });
                        } else {
                            console.log('✅ Workout válido:', {
                                originalIndex: workout.originalIndex,
                                date: workout.date,
                                exercises: workout.exercises,
                                sets: workout.sets,
                                volume: workout.totalVolume
                            });
                        }
                        
                        return isValid;
                    });
                    
                    console.log(`Workouts después de filtrar fantasma: ${validWorkouts.length} de ${baseWorkouts.length}`);

                    // 4. Agrupar por routineKey para mostrar solo uno por grupo
                    const groups = {};
                    validWorkouts.forEach(workout => {
                        const key = workout.routineKey || 'unknown';
                        if (!groups[key]) {
                            groups[key] = {
                                routineKey: key,
                                representative: workout,
                                allWorkouts: [workout],
                                workoutIndices: [workout.originalIndex],
                                count: 1
                            };
                        } else {
                            groups[key].allWorkouts.push(workout);
                            groups[key].workoutIndices.push(workout.originalIndex);
                            groups[key].count++;
                            // Mantener el más reciente como representante
                            if (new Date(workout.date) > new Date(groups[key].representative.date)) {
                                groups[key].representative = workout;
                            }
                        }
                    });

                    const result = Object.values(groups).map(g => ({
                        ...g.representative,
                        groupWorkoutIndices: g.workoutIndices,
                        groupCount: g.count
                    }));

                    console.log('Resultado final:', result.length, 'grupos válidos');
                    
                    // Log detallado de los resultados
                    result.forEach((workout, index) => {
                        console.log(`Grupo ${index + 1}:`, {
                            routineKey: workout.routineKey,
                            date: workout.date,
                            exercises: workout.exercises,
                            sets: workout.sets,
                            volume: workout.totalVolume,
                            groupCount: workout.groupCount
                        });
                    });
                    
                    return result;
                },
                // Función para ver el historial de una rutina específica
                viewRoutineHistory(routineId) {
                    console.log('Navegando al historial de rutina:', routineId);
                    
                    // Establecer la vista actual como la rutina específica
                    this.currentView = {
                        type: 'routine',
                        routineId: routineId,
                        filter: 'current'
                    };
                    
                    // Navegar al historial manual (que ahora filtrará por rutina)
                    this.currentScreen = 'history-manual';
                    
                    console.log('Vista configurada:', this.currentView);
                },
                // AÑADIR esta función auxiliar
                isWorkoutInAnyRoutine(workoutIndex) {
                    if (workoutIndex < 0 || workoutIndex >= this.workoutHistory.length) return false;
                    
                    const isInRoutine = this.workoutGroups.some(group => 
                        group.workouts && group.workouts.includes(workoutIndex)
                    );
                    
                    console.log(`Workout ${workoutIndex} en rutina:`, isInRoutine);
                    return isInRoutine;
                },
                // Obtener todos los entrenamientos de un grupo dado un representante
                getGroupWorkouts(representative) {
                    const key = representative.routineKey || 'unknown';
                    let baseWorkouts = [];

                    if (this.currentView.type === 'all') {
                        const soloIndices = new Set();
                        for (let i = 0; i < this.workoutHistory.length; i++) {
                            const inGroup = this.workoutGroups.some(g => g.workouts?.includes(i));
                            if (!inGroup) soloIndices.add(i);
                        }
                        baseWorkouts = this.workoutHistory
                            .map((w, idx) => ({ ...w, originalIndex: idx }))
                            .filter(w => soloIndices.has(w.originalIndex));
                    } else if (this.currentView.type === 'routine') {
                        const routine = this.workoutGroups.find(g => g.id === this.currentView.routineId);
                        if (routine) {
                            baseWorkouts = (routine.workouts || [])
                                .map(idx => {
                                    if (idx >= 0 && idx < this.workoutHistory.length) {
                                        return { ...this.workoutHistory[idx], originalIndex: idx };
                                    }
                                    return null;
                                })
                                .filter(Boolean);
                        }
                    }

                    return baseWorkouts.filter(w => (w.routineKey || 'unknown') === key);
                },
                viewGroupDetails(representative) {
                    const groupWorkouts = this.getGroupWorkouts(representative);
                    // Guardar el grupo completo en viewedWorkout
                    this.viewedWorkout = {
                        ...representative,
                        isGroup: true,
                        allWorkouts: groupWorkouts
                    };
                    this.currentScreen = 'details';
                },

                cancelWorkout() {
                    this.currentTemplateOrigin = { type: null, routineId: null, workoutIndex: null };
                    this.currentScreen = 'exercises';
                },

                // Verificar si un entrenamiento está en alguna rutina - VERSIÓN CORREGIDA
                isWorkoutInAnyGroup(workoutIndex) {
                    if (workoutIndex < 0 || workoutIndex >= this.workoutHistory.length) return false;
                    
                    const isInGroup = this.workoutGroups.some(group => 
                        group.workouts && group.workouts.includes(workoutIndex)
                    );
                    console.log(`Workout ${workoutIndex} en alguna rutina:`, isInGroup);
                    return isInGroup;
                },

                // Título dinámico del historial
                getHistoryTitle() {
                    switch(this.currentView.type) {
                        case 'all':
                            return 'Historial de Ejercicios Sueltos';
                        case 'routine':
                            const routine = this.workoutGroups.find(g => g.id === this.currentView.routineId);
                            return `Historial - ${routine?.name || 'Rutina'}`;
                        default:
                            return 'Historial de Entrenamientos';
                    }
                },
                // AÑADIR función para limpiar datos existentes (ejecutar una vez)


                // Navegación al historial de ejercicios sueltos
                viewAllHistory() {
                    console.log('Navegando a ejercicios sueltos');
                    this.currentView = {
                        type: 'all',
                        routineId: null,
                        filter: 'current'
                    };
                    this.currentScreen = 'history-manual';
                },

                // Datos de evolución filtrados
                getFilteredEvolutionData() {
                    const workouts = this.getFilteredWorkouts();
                    return this.prepareEvolutionData(workouts);
                },
                // Función para obtener el índice original de un workout - VERSIÓN CORREGIDA
                getWorkoutOriginalIndex(workout) {
                    // El índice original ya está guardado en el objeto workout
                    return workout.originalIndex !== undefined ? workout.originalIndex : -1;
                },

                // REEMPLAZAR la función viewWorkoutDetails
                viewWorkoutDetails(originalIndex) {
                    console.log('Ver detalles del workout con índice:', originalIndex);
                    
                    if (originalIndex >= 0 && originalIndex < this.workoutHistory.length) {
                        this.viewedWorkout = { ...this.workoutHistory[originalIndex] };
                        this.viewedWorkoutIndex = originalIndex;
                        
                        // DETERMINAR EL CONTEXTO ACTUAL
                        if (this.currentScreen === 'workout-group-details' && this.currentWorkoutGroup) {
                            // Viene desde una rutina específica
                            this.lastViewContext = {
                                screen: 'workout-group-details',
                                routineId: this.currentWorkoutGroup.id,
                                routineName: this.currentWorkoutGroup.name,
                                isRoutine: true
                            };
                        } else if (this.currentView.type === 'routine' && this.currentView.routineId) {
                            // Viene desde el historial de una rutina
                            this.lastViewContext = {
                                screen: 'history-manual',
                                routineId: this.currentView.routineId,
                                isRoutine: true
                            };
                        } else {
                            // Viene desde ejercicios sueltos
                            this.lastViewContext = {
                                screen: 'history-manual',
                                isRoutine: false
                            };
                        }
                        
                        this.currentScreen = 'details';
                        
                        console.log('Contexto guardado:', this.lastViewContext);
                    } else {
                        console.error('Índice inválido:', originalIndex);
                        alert('Error: No se pudo cargar el entrenamiento seleccionado.');
                    }
                },

                // Función para obtener orden por defecto si no existe
                getDefaultOrderFromWorkout(workout) {
                    if (!workout || !workout.exercisesData) return [];
                    
                    // Si no hay orden guardado, usar las claves de exercisesData
                    return Object.keys(workout.exercisesData);
                },

                // Función para obtener color por índice (para numeración)
                getMuscleColorByIndex(index) {
                    const colors = [
                        'bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500',
                        'bg-purple-500', 'bg-orange-500', 'bg-pink-500', 'bg-indigo-500'
                    ];
                    return colors[index % colors.length];
                },

                // Función mejorada para usar workout como plantilla
                useWorkoutAsTemplateFromIndex(originalIndex) {
                    console.log('=== USANDO WORKOUT COMO PLANTILLA - VERSIÓN MEJORADA ===');
                    
                    if (originalIndex >= 0 && originalIndex < this.workoutHistory.length) {
                        const workout = this.workoutHistory[originalIndex];
                        this.viewedWorkout = { ...workout };
                        
                        // DETERMINAR SI VIENE DE RUTINA O EJERCICIO SUELTO
                        const routineOrigin = this.findWorkoutRoutineOrigin(originalIndex);
                        this.currentTemplateOrigin = routineOrigin;
                        
                        console.log('Origen de la plantilla:', this.currentTemplateOrigin);
                        console.log('Orden en workout original:', workout.order);
                        console.log('ExercisesData keys:', workout.exercisesData ? Object.keys(workout.exercisesData) : 'none');
                        
                        // USAR LA FUNCIÓN ACTUALIZADA QUE PRESERVA EL ORDEN
                        this.useWorkoutAsTemplateWithOrder();
                    } else {
                        console.error('Índice inválido para plantilla:', originalIndex);
                        alert('Error: No se pudo cargar la plantilla del entrenamiento.');
                    }
                },

                // Función mejorada que preserva el orden al usar plantilla
                useWorkoutAsTemplateWithOrder() {
                    console.log('=== CARGANDO PLANTILLA CON ORDEN PRESERVADO ===');
                    
                    if (!this.viewedWorkout || !this.viewedWorkout.exercisesData) {
                        alert('No hay un workout cargado para usar como plantilla.');
                        return;
                    }

                    const workout = JSON.parse(JSON.stringify(this.viewedWorkout)); // clone seguro

                    // Nivel (si viene)
                    if (workout.level) this.userLevel = workout.level;

                    // ORDEN CRÍTICO: Usar workout.order si existe, si no usar orden por defecto
                    const muscleOrder = Array.isArray(workout.order) && workout.order.length > 0
                        ? workout.order.slice() // PRESERVAR ORDEN ORIGINAL
                        : Object.keys(workout.exercisesData || []); // Orden por defecto

                    console.log('Orden de músculos a cargar:', muscleOrder);

                    // Asignar selectedMuscles RESPETANDO EL ORDEN ORIGINAL
                    this.selectedMuscles = muscleOrder.slice();

                    // Construir selectedExercises preservando estructura y orden
                    this.selectedExercises = {};
                    this.exerciseWeights = {};
                    this.exerciseReps = {};
                    
                    muscleOrder.forEach(muscleKey => {
                        const muscleExercises = workout.exercisesData && workout.exercisesData[muscleKey] ? workout.exercisesData[muscleKey] : [];
                        this.selectedExercises[muscleKey] = muscleExercises.map(ex => {
                            if (typeof ex === 'string') {
                                return { 
                                    name: ex, 
                                    sets: this.seriesLimits[this.userLevel]?.min || 3,
                                    completed: 0
                                };
                            }
                            // Si ya es objeto, clonar y resetear estado de completado
                            return {
                                name: ex.name,
                                sets: ex.sets || this.seriesLimits[this.userLevel]?.min || 3,
                                completed: 0 // Resetear a 0
                            };
                        });

                        // Inicializar arrays de pesos y reps CON LOS DATOS DE REFERENCIA
                        this.exerciseWeights[muscleKey] = {};
                        this.exerciseReps[muscleKey] = {};
                        
                        this.selectedExercises[muscleKey].forEach(ex => {
                            const maxSets = this.seriesLimits[this.userLevel]?.max || 5;
                            
                            // Buscar los datos del ejercicio en el workout de referencia
                            const referenceExercise = muscleExercises.find(e => e.name === ex.name);
                            
                            if (referenceExercise && referenceExercise.setsData) {
                                // Cargar pesos y reps de la sesión anterior
                                this.exerciseWeights[muscleKey][ex.name] = Array.from({length: maxSets}, (_, i) => {
                                    return referenceExercise.setsData[i]?.weight || 0;
                                });
                                
                                this.exerciseReps[muscleKey][ex.name] = Array.from({length: maxSets}, (_, i) => {
                                    return referenceExercise.setsData[i]?.reps || 0;
                                });
                                
                                console.log(`Cargados datos para ${ex.name}:`, {
                                    weights: this.exerciseWeights[muscleKey][ex.name],
                                    reps: this.exerciseReps[muscleKey][ex.name]
                                });
                            } else {
                                // Si no hay datos anteriores, inicializar en 0
                                this.exerciseWeights[muscleKey][ex.name] = Array.from({length: maxSets}, () => 0);
                                this.exerciseReps[muscleKey][ex.name] = Array.from({length: maxSets}, () => 0);
                            }
                        });
                    });

                    // Forzar reactividad
                    this.selectedMuscles = [...this.selectedMuscles];
                    this.selectedExercises = JSON.parse(JSON.stringify(this.selectedExercises));

                    console.log('✅ Plantilla cargada con orden:', this.selectedMuscles);

                    // INICIAR DIRECTAMENTE EL ENTRENAMIENTO
                    console.log('Plantilla cargada, iniciando entrenamiento...');
                    this.startWorkout();

                    this.$nextTick(() => {
                        console.log('Entrenamiento iniciado desde plantilla. Orden final:', this.selectedMuscles);
                        alert('✅ Plantilla cargada correctamente. ¡Se ha preservado el orden original y precargado los pesos!');
                    });
                },
                // MEJORAR la función deleteSingleWorkout
                deleteSingleWorkout(originalIndex) {
                    console.log('Eliminando workout con índice:', originalIndex);
                    
                    if (originalIndex >= 0 && originalIndex < this.workoutHistory.length) {
                        const workoutDate = this.formatDate(this.workoutHistory[originalIndex].date);
                        const workoutMuscles = this.getTrainedMuscles(this.workoutHistory[originalIndex]);
                        
                        if (confirm(`¿Estás seguro de que quieres eliminar el entrenamiento del ${workoutDate}?\n${workoutMuscles}`)) {
                            this.workoutHistory.splice(originalIndex, 1);
                            this.saveToLocalStorage();
                            
                            // Redirigir al historial correspondiente
                            if (this.currentScreen === 'details') {
                                this.currentScreen = 'history-manual';
                            }
                            
                            alert('Entrenamiento eliminado correctamente.');
                        }
                    } else {
                        console.error('Índice inválido para eliminar:', originalIndex);
                        alert('Error: No se pudo eliminar el entrenamiento seleccionado.');
                    }
                },
                // Función para encontrar en qué rutina está un workout
                findWorkoutRoutineOrigin(workoutIndex) {
                    for (const group of this.workoutGroups) {
                        if (group.workouts && group.workouts.includes(workoutIndex)) {
                            return {
                                type: 'routine',
                                routineId: group.id,
                                routineName: group.name,
                                workoutIndex: workoutIndex
                            };
                        }
                    }
                    return {
                        type: 'single',
                        routineId: null,
                        routineName: null,
                        workoutIndex: workoutIndex
                    };
                },

                // Función para obtener músculos por índice
                getWorkoutMusclesByIndex(index) {
                    const workout = this.workoutHistory[index];
                    if (!workout || !workout.exercisesData) return [];
                    
                    return workout.order && workout.order.length ? workout.order : Object.keys(workout.exercisesData).map(muscleKey => {
                        const muscleGroup = this.muscleGroups.find(m => m.key === muscleKey);
                        return {
                            key: muscleKey,
                            label: muscleGroup ? muscleGroup.label : muscleKey,
                            color: muscleGroup ? muscleGroup.color : 'bg-gray-500'
                        };
                    });
                },

                // ==================================================
                // 9. HISTORIAL Y GESTIÓN DE DATOS
                // ==================================================
                // FUNCIÓN PARA MIGRAR DATOS ANTIGUOS
                migrateOldData() {
                    console.log('Verificando migración de datos antiguos...');
                    
                    const savedHistory = localStorage.getItem('gymApp_workoutHistory');
                    if (!savedHistory) return;
                    
                    try {
                        const history = JSON.parse(savedHistory);
                        let migratedCount = 0;
                        let fixedCount = 0;
                        
                        history.forEach(workout => {
                            // 1. Asegurar que todos los workouts tengan modo
                            if (!workout.mode) {
                                workout.mode = 'manual';
                                migratedCount++;
                            }
                            
                            // 2. Asegurar que todos los workouts tengan completedSets
                            if (workout.completedSets === undefined || workout.completedSets === null) {
                                workout.completedSets = this.calculateCompletedSets(workout);
                                fixedCount++;
                            }
                            
                            // 3. Asegurar que todos los workouts tengan routineKey
                            if (!workout.routineKey || workout.routineKey === 'unknown') {
                                workout.routineKey = this.getRoutineKey(workout);
                                migratedCount++;
                            }
                            
                            // 4. Asegurar que todos los ejercicios tengan completed
                            if (workout.exercisesData) {
                                Object.values(workout.exercisesData).forEach(muscleExercises => {
                                    muscleExercises.forEach(exercise => {
                                        if (exercise.completed === undefined || exercise.completed === null) {
                                            // Calcular completed basado en setsData
                                            if (exercise.setsData && Array.isArray(exercise.setsData)) {
                                                exercise.completed = exercise.setsData.filter(set => 
                                                    set.completed && set.reps > 0
                                                ).length;
                                            } else {
                                                exercise.completed = 0;
                                            }
                                            fixedCount++;
                                        }
                                    });
                                });
                            }
                        });
                        
                        if (migratedCount > 0 || fixedCount > 0) {
                            console.log(`Migrados ${migratedCount} workouts, corregidos ${fixedCount} datos`);
                            localStorage.setItem('gymApp_workoutHistory', JSON.stringify(history));
                        }
                        
                    } catch (error) {
                        console.error('Error en migración:', error);
                    }
                },

                // FUNCIÓN AUXILIAR PARA CALCULAR COMPLETED SETS
                calculateCompletedSets(workout) {
                    if (!workout.exercisesData) return 0;
                    
                    let completed = 0;
                    Object.values(workout.exercisesData).forEach(muscleExercises => {
                        muscleExercises.forEach(exercise => {
                            if (exercise.completed !== undefined && exercise.completed !== null) {
                                completed += exercise.completed;
                            } else if (exercise.setsData) {
                                // Calcular de setsData como fallback
                                completed += exercise.setsData.filter(set => 
                                    set.completed && set.reps > 0
                                ).length;
                            }
                        });
                    });
                    
                    return completed;
                },
                loadFromLocalStorage() {
                    //const savedLevel = localStorage.getItem('gymApp_userLevel');

                    //this.userLevel = savedLevel || '';

                    
                    const savedHistory = localStorage.getItem('gymApp_workoutHistory');
                    if (savedHistory) {
                        try {
                            this.workoutHistory = JSON.parse(savedHistory);
                            this.migrateOldHistory();
                            this.workoutHistory.forEach(workout => {
                                if (!workout.routineKey) {
                                    workout.routineKey = this.getRoutineKey(workout);
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing workout history:', error);
                            this.workoutHistory = [];
                        }
                    }
                    
                    const savedSound = localStorage.getItem('gymApp_soundEnabled');
                    if (savedSound !== null) {
                        this.soundEnabled = savedSound === 'true';
                    }
                    const savedRestConfig = localStorage.getItem('gymApp_restTimerConfig');
                    if (savedRestConfig) {
                        try {
                            const config = JSON.parse(savedRestConfig);
                            this.restTimerConfig = { 
                                enabled: config.enabled !== undefined ? config.enabled : true,
                                duration: config.duration || 60,
                                muscleRestDuration: config.muscleRestDuration || 120,
                                soundEnabled: config.soundEnabled !== undefined ? config.soundEnabled : true
                            };
                        } catch (error) {
                            console.error('Error parsing rest timer config:', error);
                        }
                    }
                },
                saveToLocalStorage() {
                    // localStorage.setItem('gymApp_userLevel', this.userLevel);
                    localStorage.setItem('gymApp_workoutHistory', JSON.stringify(this.workoutHistory));
                    localStorage.setItem('gymApp_soundEnabled', this.soundEnabled);
                    localStorage.setItem('gymApp_restTimerConfig', JSON.stringify(this.restTimerConfig));
                    localStorage.setItem('gymApp_workoutGroups', JSON.stringify(this.workoutGroups));
                },

                // FUNCIÓN SIMPLIFICADA SIN MENSAJES EMERGENTES
                toggleExerciseActivation(muscle, exercise) {
                    // Si ya está activo este ejercicio, lo desactivamos
                    if (this.currentExercise.muscle === muscle && this.currentExercise.name === exercise) {
                        this.currentExercise = { muscle: '', name: '' };
                    } 
                    // Si no está activo, lo activamos
                    else {
                        this.currentExercise = { muscle, name: exercise };
                    }
                    this.playCompletionSound();
                    
                    // Si hay un temporizador activo, detenerlo al cambiar de ejercicio
                    if (this.isRestTimerActive) {
                        this.stopRestTimer();
                    }
                },
                formatRestTime(seconds) {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    if (mins > 0) {
                        return `${mins}:${secs.toString().padStart(2, '0')}`;
                    } else {
                        return `${secs.toString().padStart(2, '0')}`;
                    }
                },

                // Función para formatear fecha y hora
                formatDateTime(isoString) {
                    const date = new Date(isoString);
                    if (isNaN(date.getTime())) {
                        return 'Fecha inválida';
                    }
                    return date.toLocaleString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                // Función para obtener la etiqueta localizada de un músculo
                getMuscleLabel(muscleKey) {
                    const muscle = this.muscleGroups.find(m => m.key === muscleKey);
                    return muscle ? muscle.label : muscleKey;
                },
                // Función para verificar si es el último elemento en un array (para formatear listas)
                isLastItem(array, index) {
                    return index === array.length - 1;
                },

                // EN LA FUNCIÓN migrateOldHistory, agregar esto
                migrateOldHistory() {
                    let needsMigration = false;
                    for (const w of this.workoutHistory) {
                        if (!w.order || !Array.isArray(w.order)) {
                            needsMigration = true;
                            break;
                        }
                    }
                    if (needsMigration) {
                        this.workoutHistory = this.workoutHistory.map(w => {
                            if (!w.order || !Array.isArray(w.order)) {
                                w.order = w.exercisesData ? Object.keys(w.exercisesData) : [];
                            }
                            return w;
                        });
                        this.saveToLocalStorage();
                    }
                },
                toggleGroupForWorkoutGroup(routineKey) {
                    const index = this.selectedGroupsForWorkoutGroup.indexOf(routineKey);
                    if (index === -1) {
                        this.selectedGroupsForWorkoutGroup.push(routineKey);
                    } else {
                        this.selectedGroupsForWorkoutGroup.splice(index, 1);
                    }
                },
                isGroupSelected(routineKey) {
                    return this.selectedGroupsForWorkoutGroup.includes(routineKey);
                },
                getGroupedWorkouts() {
                    const groups = {};
                    this.workoutHistory
                        .filter(w => w.mode === 'manual')
                        .forEach((workout, index) => {
                            const routineKey = this.getRoutineKey(workout);
                            if (!groups[routineKey]) {
                                groups[routineKey] = {
                                    routineKey,
                                    routineName: this.getRoutineName(workout),
                                    latestDate: workout.date,
                                    latestTime: workout.time || 0,
                                    latestExercises: workout.exercises,
                                    latestSets: workout.sets,
                                    latestVolume: workout.totalVolume,
                                    latestWorkoutIndex: index,
                                    count: 1
                                };
                            } else {
                                const g = groups[routineKey];
                                g.count++;
                                if (new Date(workout.date) > new Date(g.latestDate)) {
                                    g.latestDate = workout.date;
                                    g.latestTime = workout.time || 0;
                                    g.latestExercises = workout.exercises;
                                    g.latestSets = workout.sets;
                                    g.latestVolume = workout.totalVolume;
                                    g.latestWorkoutIndex = index;
                                }
                            }
                        });
                    return Object.values(groups).sort((a, b) => new Date(b.latestDate) - new Date(a.latestDate));
                },

                // Función para obtener la clave de rutina de un workout existente - VERSIÓN CORREGIDA
                getRoutineKey(workout) {
                    if (!workout.exercisesData || !workout.order || workout.order.length === 0) {
                        // Fallback: usar orden de claves (pero esto es inconsistente)
                        return 'unknown';
                    }

                    const parts = [];
                    // ✅ USAR EL ORDEN GUARDADO EN `workout.order`
                    for (const muscle of workout.order) {
                        const exercises = workout.exercisesData[muscle] || [];
                        if (exercises.length === 0) continue;

                        // ✅ PRESERVAR EL ORDEN DE EJERCICIOS TAL CUAL ESTÁ GUARDADO
                        const exParts = exercises.map(ex => `${ex.name}|${ex.sets}`).join(',');
                        parts.push(`${muscle}:${exParts}`);
                    }

                    return parts.join(';');
                },
                // AÑADIR esta función para corregir workouts sin modo
                fixWorkoutModes() {
                    let fixedCount = 0;
                    this.workoutHistory.forEach(workout => {
                        if (!workout.mode) {
                            workout.mode = 'manual'; // Asumir que son manuales si no tienen modo
                            fixedCount++;
                        }
                    });
                    
                    if (fixedCount > 0) {
                        this.saveToLocalStorage();
                        console.log(`Corregidos ${fixedCount} workouts sin modo`);
                    }
                    return fixedCount;
                },
                // ACTUALIZAR la función migrateExistingWorkouts
                migrateExistingWorkouts() {
                    console.log('=== MIGRANDO WORKOUTS EXISTENTES ===');
                    let migratedCount = 0;
                    let routineKeyCount = 0;
                    
                    this.workoutHistory.forEach((workout, index) => {
                        // Migrar routineKey si no existe
                        if (!workout.routineKey || workout.routineKey === 'unknown') {
                            const newKey = this.getRoutineKey(workout);
                            workout.routineKey = newKey;
                            migratedCount++;
                        }
                        
                        // Contar routineKeys únicas
                        if (workout.routineKey && workout.routineKey !== 'unknown') {
                            routineKeyCount++;
                        }
                    });
                    
                    if (migratedCount > 0 || fixedAssignments > 0) {
                        this.saveToLocalStorage();
                        console.log(`Migrados ${migratedCount} workouts, corregidas ${fixedAssignments} asignaciones`);
                        console.log(`Total routineKeys únicas: ${routineKeyCount}`);
                    }
                    
                    return migratedCount;
                },

                getRoutineName(workout) {
                    if (!workout.exercisesData) return 'Rutina sin datos';
                    
                    // Obtener todos los ejercicios únicos de la rutina
                    const allExercises = [];
                    const muscles = workout.order && workout.order.length > 0 
                        ? workout.order 
                        : Object.keys(workout.exercisesData || {});
                    
                    muscles.forEach(muscle => {
                        const exercises = workout.exercisesData[muscle] || [];
                        exercises.forEach(exercise => {
                            if (!allExercises.includes(exercise.name)) {
                                allExercises.push(exercise.name);
                            }
                        });
                    });
                    
                    // Si hay pocos ejercicios, mostrarlos todos
                    if (allExercises.length <= 3) {
                        return allExercises.join(' + ');
                    }
                    
                    // Si hay muchos ejercicios, mostrar los primeros + contador
                    const firstExercises = allExercises.slice(0, 2);
                    return `${firstExercises.join(' + ')} + ${allExercises.length - 2} más`;
                },
                viewLatestWorkout(index) {
                    // Validar índice
                    if (index < 0 || index >= this.workoutHistory.length) {
                        console.error("Índice de entrenamiento inválido:", index);
                        alert("Error: No se puede encontrar el entrenamiento seleccionado.");
                        return;
                    }

                    // CLONAR el workout (no mutar historial)
                    this.viewedWorkout = JSON.parse(JSON.stringify(this.workoutHistory[index]));
                    this.viewedWorkoutIndex = index;

                    // Asegurar routineKey
                    if (!this.viewedWorkout.routineKey) {
                        this.viewedWorkout.routineKey = this.getRoutineKey(this.viewedWorkout);
                    }

                    console.log("Viewing workout details:", this.viewedWorkout);
                    this.currentScreen = 'details';

                    this.$nextTick(() => {
                        console.log("Pantalla de detalles cargada");
                    });
                },


                deleteSingleWorkout(index) {
                    const workoutDate = this.formatDate(this.workoutHistory[index].date);
                    if (confirm(`¿Estás seguro de que quieres eliminar el entrenamiento del ${workoutDate}?`)) {
                        this.workoutHistory.splice(index, 1);
                        this.saveToLocalStorage();
                        this.currentScreen = 'history-manual';
                        alert('Entrenamiento eliminado correctamente.');
                    }
                },

                useWorkoutAsTemplate() {
                    console.log('=== CARGANDO PLANTILLA Y INICIANDO ENTRENAMIENTO ===');
                    if (!this.viewedWorkout || !this.viewedWorkout.exercisesData) {
                        alert('No hay un workout cargado para usar como plantilla.');
                        return;
                    }

                    const workout = JSON.parse(JSON.stringify(this.viewedWorkout)); // clone seguro

                    // Nivel (si viene)
                    if (workout.level) this.userLevel = workout.level;

                    // Orden de músculos: preferir workout.order si existe
                    const muscleOrder = Array.isArray(workout.order) && workout.order.length > 0
                        ? workout.order.slice()
                        : Object.keys(workout.exercisesData || []);

                    // Asignar selectedMuscles respetando el orden
                    this.selectedMuscles = muscleOrder.slice();

                    // Construir selectedExercises preservando estructura
                    this.selectedExercises = {};
                    this.exerciseWeights = {};
                    this.exerciseReps = {};
                    
                    muscleOrder.forEach(muscleKey => {
                        const muscleExercises = workout.exercisesData && workout.exercisesData[muscleKey] ? workout.exercisesData[muscleKey] : [];
                        this.selectedExercises[muscleKey] = muscleExercises.map(ex => {
                            if (typeof ex === 'string') {
                                return { 
                                    name: ex, 
                                    sets: this.seriesLimits[this.userLevel]?.min || 3,
                                    completed: 0
                                };
                            }
                            // Si ya es objeto, clonar y resetear estado de completado
                            return {
                                name: ex.name,
                                sets: ex.sets || this.seriesLimits[this.userLevel]?.min || 3,
                                completed: 0 // Resetear a 0
                            };
                        });

                        // Inicializar arrays de pesos y reps CON LOS DATOS DE REFERENCIA
                        this.exerciseWeights[muscleKey] = {};
                        this.exerciseReps[muscleKey] = {};
                        
                        this.selectedExercises[muscleKey].forEach(ex => {
                            const maxSets = this.seriesLimits[this.userLevel]?.max || 5;
                            
                            // Buscar los datos del ejercicio en el workout de referencia
                            const referenceExercise = muscleExercises.find(e => e.name === ex.name);
                            
                            if (referenceExercise && referenceExercise.setsData) {
                                // Cargar pesos y reps de la sesión anterior
                                this.exerciseWeights[muscleKey][ex.name] = Array.from({length: maxSets}, (_, i) => {
                                    return referenceExercise.setsData[i]?.weight || 0;
                                });
                                
                                this.exerciseReps[muscleKey][ex.name] = Array.from({length: maxSets}, (_, i) => {
                                    return referenceExercise.setsData[i]?.reps || 0;
                                });
                                
                                console.log(`Cargados datos para ${ex.name}:`, {
                                    weights: this.exerciseWeights[muscleKey][ex.name],
                                    reps: this.exerciseReps[muscleKey][ex.name]
                                });
                            } else {
                                // Si no hay datos anteriores, inicializar en 0
                                this.exerciseWeights[muscleKey][ex.name] = Array.from({length: maxSets}, () => 0);
                                this.exerciseReps[muscleKey][ex.name] = Array.from({length: maxSets}, () => 0);
                            }
                        });
                    });

                    // Forzar reactividad
                    this.selectedMuscles = [...this.selectedMuscles];
                    this.selectedExercises = JSON.parse(JSON.stringify(this.selectedExercises));

                    // INICIAR DIRECTAMENTE EL ENTRENAMIENTO
                    console.log('Plantilla cargada, iniciando entrenamiento...');
                    this.startWorkout();

                    this.$nextTick(() => {
                        console.log('Entrenamiento iniciado desde plantilla. selectedMuscles =', this.selectedMuscles);
                        alert('✅ Plantilla cargada correctamente. ¡Se han precargado los pesos de tu última sesión!');
                    });
                },

                getPreviousExerciseData(muscle, exercise) {
                    for (const workout of this.workoutHistory) {
                        if (workout.exercisesData[muscle]) {
                            for (const ex of workout.exercisesData[muscle]) {
                                if (ex.name === exercise) {
                                    const bestSet = ex.setsData.reduce((best, set) => {
                                        return set.weight * set.reps > best.weight * best.reps ? set : best;
                                    }, {weight: 0, reps: 0});
                                    return `${bestSet.weight}kg x ${bestSet.reps} reps`;
                                }
                            }
                        }
                    }
                    return null;
                },

                deleteWorkoutGroup(groupId) {
                    if (!confirm('¿Estás seguro de que quieres eliminar esta rutina de trabajo? Los entrenamientos volverán a estar disponibles individualmente.')) {
                        return;
                    }

                    const groupIndex = this.workoutGroups.findIndex(g => g.id === groupId);
                    if (groupIndex === -1) {
                        console.warn('Intento de eliminar rutina inexistente:', groupId);
                        return;
                    }

                    // Extraer el grupo que vamos a eliminar
                    const removedGroup = this.workoutGroups.splice(groupIndex, 1)[0];
                    console.log('Eliminando rutina:', removedGroup);

                    // 1) Liberar los workouts para que vuelvan a estar disponibles
                    if (removedGroup && Array.isArray(removedGroup.workouts)) {
                        console.log(`Liberando ${removedGroup.workouts.length} workouts de la rutina`);
                        
                        // Los workouts automáticamente estarán disponibles en "sueltos" 
                        // porque ya no estarán referenciados en ninguna rutina
                        // No necesitamos cambiar su modo, solo eliminar la referencia
                    }

                    // 2) Guardar cambios
                    this.saveToLocalStorage();

                    // 3) Limpiar contexto relacionado
                    if (this.currentWorkoutGroup && this.currentWorkoutGroup.id === groupId) {
                        this.currentWorkoutGroup = null;
                    }

                    // 4) Forzar actualización de la vista
                    this.currentScreen = 'workout-groups';
                    
                    // 5) Verificar que los workouts estén disponibles
                    setTimeout(() => {
                        const availableCount = this.getFilteredWorkouts().length;
                        console.log(`Workouts disponibles después de eliminar rutina: ${availableCount}`);
                    }, 100);

                    alert('Rutina de trabajo eliminada correctamente. Los entrenamientos ahora están disponibles en "Ejercicios sueltos".');
                },

                // Función para eliminar un entrenamiento específico de una rutina de trabajo
                removeWorkoutFromGroup(groupId, workoutIndex) {
                    if (confirm('¿Estás seguro de que quieres eliminar este entrenamiento de la rutina? Volverá a estar disponible individualmente.')) {
                        const group = this.workoutGroups.find(g => g.id === groupId);
                        if (group) {
                            group.workouts.splice(workoutIndex, 1);
                            
                            // Si la rutina queda vacía, eliminarla
                            if (group.workouts.length === 0) {
                                this.workoutGroups = this.workoutGroups.filter(g => g.id !== groupId);
                            }
                            
                            this.saveToLocalStorage();
                            alert('Entrenamiento eliminado de la rutina');
                        }
                    }
                },
                // AÑADIR esta función para verificar y corregir referencias
                verifyAndFixWorkoutReferences() {
                    console.log('=== VERIFICANDO REFERENCIAS DE WORKOUTS ===');
                    let fixedCount = 0;
                    let invalidCount = 0;

                    // Verificar cada grupo de trabajo
                    this.workoutGroups.forEach((group, groupIndex) => {
                        if (group.workouts && Array.isArray(group.workouts)) {
                            const validWorkouts = [];
                            
                            group.workouts.forEach(workoutIndex => {
                                // Verificar que el índice sea válido y el workout exista
                                if (workoutIndex >= 0 && 
                                    workoutIndex < this.workoutHistory.length && 
                                    this.workoutHistory[workoutIndex]) {
                                    
                                    validWorkouts.push(workoutIndex);
                                } else {
                                    console.warn(`Referencia inválida encontrada: grupo ${groupIndex}, workout ${workoutIndex}`);
                                    invalidCount++;
                                }
                            });

                            // Actualizar solo si hay cambios
                            if (validWorkouts.length !== group.workouts.length) {
                                group.workouts = validWorkouts;
                                fixedCount++;
                            }
                        }
                    });

                    // Eliminar grupos vacíos
                    const initialGroupCount = this.workoutGroups.length;
                    this.workoutGroups = this.workoutGroups.filter(group => 
                        group.workouts && group.workouts.length > 0
                    );
                    
                    const removedEmptyGroups = initialGroupCount - this.workoutGroups.length;

                    if (fixedCount > 0 || invalidCount > 0 || removedEmptyGroups > 0) {
                        console.log(`Corregidas ${fixedCount} referencias, ${invalidCount} inválidas, eliminados ${removedEmptyGroups} grupos vacíos`);
                        this.saveToLocalStorage();
                    }

                    return { fixedCount, invalidCount, removedEmptyGroups };
                },

                editWorkoutGroup(groupId) {
                    const group = this.workoutGroups.find(g => g.id === groupId);
                    if (!group) return;

                    // Crear una copia profunda del grupo para evitar referencias directas
                    this.editingWorkoutGroup = JSON.parse(JSON.stringify(group));

                    // Si el grupo tenía workouts con índices antiguos inválidos, se filtran
                    this.editingWorkoutGroup.workouts = this.editingWorkoutGroup.workouts.filter(
                        i => typeof i === 'number' && i >= 0 && i < this.workoutHistory.length
                    );

                    this.newWorkoutGroupName = this.editingWorkoutGroup.name || '';
                    this.selectedGroupsForWorkoutGroup = [...this.editingWorkoutGroup.workouts];

                    this.showCreateWorkoutGroupModal = true;
                },


                // Función para actualizar rutina de trabajo - VERSIÓN CORREGIDA
                updateWorkoutGroup() {
                    if (!this.newWorkoutGroupName.trim()) {
                        alert('Por favor, ingresa un nombre para la rutina.');
                        return;
                    }
                    if (this.selectedGroupsForWorkoutGroup.length === 0) {
                        alert('Selecciona al menos un grupo de entrenamiento.');
                        return;
                    }

                    console.log('Actualizando rutina:', this.editingWorkoutGroup?.id);

                    // Obtener TODOS los workouts de cada grupo
                    const allWorkoutIndices = [];
                    const grouped = this.getGroupedManualWorkouts();
                    
                    this.selectedGroupsForWorkoutGroup.forEach(key => {
                        const group = grouped.find(g => g.routineKey === key);
                        if (group && group.allWorkouts) {
                            group.allWorkouts.forEach(workout => {
                                if (workout.originalIndex !== undefined) {
                                    allWorkoutIndices.push(workout.originalIndex);
                                }
                            });
                        }
                    });

                    const groupIndex = this.workoutGroups.findIndex(g => g.id === this.editingWorkoutGroup.id);
                    if (groupIndex !== -1) {
                        this.workoutGroups[groupIndex].name = this.newWorkoutGroupName.trim();
                        this.workoutGroups[groupIndex].workouts = allWorkoutIndices;
                        this.workoutGroups[groupIndex].lastModified = new Date().toISOString();
                        
                        this.saveToLocalStorage();
                        
                        // LIMPIAR el modal completamente
                        this.showCreateWorkoutGroupModal = false;
                        this.selectedGroupsForWorkoutGroup = [];
                        this.newWorkoutGroupName = '';
                        this.editingWorkoutGroup = null;
                        
                        this.currentScreen = 'workout-groups';
                        alert(`Rutina actualizada correctamente con ${allWorkoutIndices.length} entrenamientos.`);
                    }
                },
                forceRoutineKeyMigration() {
                    if (confirm('¿Estás seguro de que quieres forzar la migración de todas las routineKeys? Esto corregirá posibles inconsistencias.')) {
                        let migratedCount = 0;
                        
                        this.workoutHistory.forEach(workout => {
                            const newKey = this.getRoutineKey(workout);
                            if (workout.routineKey !== newKey) {
                                workout.routineKey = newKey;
                                migratedCount++;
                            }
                        });
                        
                        this.saveToLocalStorage();
                        alert(`Migradas ${migratedCount} routineKeys.`);

                    }
                },
                cancelWorkoutGroupModal() {
                    console.log('Cancelando modal de rutina');
                    this.showCreateWorkoutGroupModal = false;
                    this.selectedGroupsForWorkoutGroup = [];
                    this.newWorkoutGroupName = '';
                    this.editingWorkoutGroup = null;
                },
                openCreateWorkoutGroupModal() {
                    console.log('=== ABRIENDO MODAL DE CREACIÓN DE RUTINA ===');
                    
                    // Limpiar estado completamente
                    this.selectedGroupsForWorkoutGroup = [];
                    this.newWorkoutGroupName = '';
                    this.editingWorkoutGroup = null;
                    
                    // Verificar disponibilidad de workouts
                    const availableGroups = this.getGroupedManualWorkouts();
                    console.log('Grupos disponibles:', availableGroups.length);

                    if (availableGroups.length === 0) {
                        alert('❌ No hay entrenamientos disponibles para crear rutinas.\n\nPrimero completa algunos entrenamientos manuales desde "Crear Entrenamiento Manual".');
                        return;
                    }

                    // Abrir modal directamente
                    this.showCreateWorkoutGroupModal = true;
                    
                    console.log('Modal abierto correctamente');
                },

                useWorkoutFromGroupAsTemplate(workoutIndex) {
                    console.log('=== CARGANDO PLANTILLA DESDE RUTINA ===');
                    
                    const workout = this.workoutHistory[workoutIndex];
                    if (workout) {
                        this.viewedWorkout = { ...workout };
                        
                        // Establecer el origen como la rutina actual
                        this.currentTemplateOrigin = {
                            type: 'routine',
                            routineId: this.currentWorkoutGroup.id,
                            routineName: this.currentWorkoutGroup.name,
                            workoutIndex: workoutIndex
                        };
                        
                        console.log('Usando plantilla desde rutina:', this.currentTemplateOrigin);
                        
                        // USAR LA FUNCIÓN ACTUALIZADA QUE INCLUYE LOS PESOS DE REFERENCIA
                        this.useWorkoutAsTemplate();
                    } else {
                        console.error('Workout no encontrado en índice:', workoutIndex);
                        alert('Error: No se pudo cargar la plantilla del entrenamiento.');
                    }
                },

                // REEMPLAZAR la función viewWorkoutInGroup
                viewWorkoutInGroup(workoutIndex) {
                    const workout = this.workoutHistory[workoutIndex];
                    if (workout) {
                        this.viewedWorkout = { ...workout };
                        this.viewedWorkoutIndex = workoutIndex;
                        
                        // CONTEXTO RUTINA: Siempre marcamos que venimos de una rutina
                        this.lastViewContext = {
                            screen: 'workout-group-details',
                            routineId: this.currentWorkoutGroup.id,
                            routineName: this.currentWorkoutGroup.name,
                            isRoutine: true
                        };
                        
                        this.currentScreen = 'details';
                        console.log('Navegando desde rutina. Contexto:', this.lastViewContext);
                    }
                },
                // REEMPLAZAR la función goBackFromDetails
                // Función para volver desde detalles - VERSIÓN SIMPLIFICADA
                goBackFromDetails() {
                    console.log('Volviendo desde detalles a rutina');
                    
                    // SIEMPRE volver a la rutina cuando estamos en contexto de rutina
                    if (this.lastViewContext && this.lastViewContext.isRoutine) {
                        this.currentScreen = 'workout-group-details';
                    } else {
                        // Fallback: volver al historial general
                        this.currentView = {
                            type: 'all',
                            routineId: null,
                            filter: 'current'
                        };
                        this.currentScreen = 'history-manual';
                    }
                    
                    // Limpiar el contexto
                    this.lastViewContext = null;
                },

                getBackButtonText() {
                    if (this.lastViewContext && this.lastViewContext.isRoutine) {
                        if (this.lastViewContext.screen === 'workout-group-details') {
                            return 'Volver a la Rutina';
                        } else {
                            return 'Volver al Historial de Rutina';
                        }
                    } else {
                        return 'Volver al Historial';
                    }
                },

                // Función para obtener la previsualización de un entrenamiento
                getWorkoutPreview(workoutIndex) {
                    const workout = this.workoutHistory[workoutIndex];
                    return this.getTrainedMuscles(workout);
                },

                // Función para ver la evolución de una rutina completa
                viewGroupEvolution(group) {
                    // Aquí puedes implementar la lógica para ver la evolución del grupo completo
                    alert('Funcionalidad de evolución de rutina en desarrollo');
                },

                getCompletedSets(workoutIndex) {
                    const workout = this.workoutHistory[workoutIndex];
                    if (!workout) return 0;
                    
                    // Usar el valor guardado si existe y es válido
                    if (workout.completedSets !== undefined && workout.completedSets !== null) {
                        return workout.completedSets;
                    }
                    
                    // Si no, calcularlo
                    return this.calculateCompletedSets(workout);
                },


                // Función para obtener los días ordenados correctamente
                getSortedDays(week1) {
                    if (!week1) return [];
                    const dayOrder = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                    return Object.keys(week1).sort((a, b) => {
                        const indexA = dayOrder.indexOf(a);
                        const indexB = dayOrder.indexOf(b);
                        // Si un día no está en dayOrder, lo ponemos al final
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                },

                // ==================================================
                // 11. EVOLUCIÓN Y GRÁFICOS (CHART.JS)
                // ==================================================
                initEvolutionChart() {
                    this.$nextTick(() => {
                        setTimeout(() => {
                            const ctx = document.getElementById('evolutionChart');
                            if (!ctx) {
                                console.error('No se encontró el elemento del gráfico');
                                return;
                            }
                            
                            const chartData = this.prepareEvolutionData();
                            
                            console.log('Inicializando gráfico con:', chartData);

                            // Destruir gráfico existente
                            if (this.evolutionChart) {
                                this.evolutionChart.destroy();
                            }

                            // Solo crear gráfico si hay datos
                            if (chartData.values.length > 0) {
                                this.evolutionChart = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: chartData.labels,
                                        datasets: [{
                                            label: chartData.label,
                                            data: chartData.values,
                                            borderColor: '#4299e1',
                                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.4,
                                            pointBackgroundColor: '#4299e1',
                                            pointBorderColor: '#ffffff',
                                            pointBorderWidth: 2,
                                            pointRadius: 5,
                                            pointHoverRadius: 7
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                display: true,
                                                position: 'top',
                                                labels: {
                                                    color: '#d1d5db',
                                                    font: {
                                                        size: 12
                                                    }
                                                }
                                            },
                                            tooltip: {
                                                mode: 'index',
                                                intersect: false,
                                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                                titleColor: '#ffffff',
                                                bodyColor: '#ffffff'
                                            }
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                grid: {
                                                    color: 'rgba(255, 255, 255, 0.1)'
                                                },
                                                ticks: {
                                                    color: '#d1d5db',
                                                    callback: function(value) {
                                                        return value + (chartData.label.includes('%') ? '%' : '');
                                                    }
                                                },
                                                title: {
                                                    display: true,
                                                    text: chartData.label,
                                                    color: '#d1d5db'
                                                }
                                            },
                                            x: {
                                                grid: {
                                                    color: 'rgba(255, 255, 255, 0.1)'
                                                },
                                                ticks: {
                                                    color: '#d1d5db',
                                                    maxRotation: 45,
                                                    minRotation: 45
                                                }
                                            }
                                        },
                                        interaction: {
                                            intersect: false,
                                            mode: 'index'
                                        }
                                    }
                                });
                            } else {
                                console.log('No hay datos para mostrar en el gráfico');
                                // Mostrar mensaje de no datos
                                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                                ctx.getContext('2d').fillStyle = '#d1d5db';
                                ctx.getContext('2d').font = '16px Arial';
                                ctx.getContext('2d').fillText('No hay datos para mostrar', 50, 50);
                            }
                        }, 300);
                    });
                },
                updateChart() {
                    console.log('=== ACTUALIZANDO GRÁFICO ===');
                    console.log('Filtro:', this.evolutionFilter);
                    console.log('Ejercicio:', this.selectedExercise);
                    console.log('Métrica:', this.selectedMetric);
                    
                    this.$nextTick(() => {
                        setTimeout(() => {
                            this.initEvolutionChart();
                        }, 200);
                    });
                },
                // REEMPLAZAR completamente la función prepareEvolutionData
                prepareEvolutionData() {
                    console.log('Preparando datos de evolución:', {
                        metric: this.selectedMetric,
                        filter: this.evolutionFilter,
                        exercise: this.selectedExercise,
                        totalWorkouts: this.workoutHistory.length
                    });

                    // Usar todos los workouts del historial para la evolución
                    const data = this.workoutHistory.filter(workout => 
                        workout && workout.exercisesData && Object.keys(workout.exercisesData).length > 0
                    );
                    
                    if (data.length === 0) {
                        console.log('No hay datos para mostrar');
                        return { labels: [], values: [], label: 'Sin datos' };
                    }

                    // Ordenar por fecha
                    const sortedData = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    const labels = [];
                    const values = [];
                    let label = '';

                    sortedData.forEach(workout => {
                        let value = 0;
                        let hasData = false;

                        switch(this.selectedMetric) {
                            case 'volume':
                                // VOLUMEN - CORREGIDO
                                if (this.evolutionFilter === 'specific' && this.selectedExercise) {
                                    // Ejercicio específico
                                    Object.keys(workout.exercisesData).forEach(muscle => {
                                        workout.exercisesData[muscle].forEach(exercise => {
                                            if (exercise.name === this.selectedExercise) {
                                                value += exercise.volume || 0;
                                                hasData = true;
                                                console.log(`Ejercicio ${this.selectedExercise}: volumen ${exercise.volume}`);
                                            }
                                        });
                                    });
                                } 
                                else if (this.evolutionFilter.startsWith('muscle_')) {
                                    // Músculo específico
                                    const muscleKey = this.evolutionFilter.replace('muscle_', '');
                                    if (workout.exercisesData[muscleKey]) {
                                        workout.exercisesData[muscleKey].forEach(exercise => {
                                            value += exercise.volume || 0;
                                            hasData = true;
                                        });
                                    }
                                }
                                else {
                                    // Todos los datos
                                    value = workout.totalVolume || 0;
                                    hasData = value > 0;
                                }
                                label = 'Volumen Total (kg)';
                                break;

                            case 'weight':
                                // PESO MÁXIMO - CORREGIDO
                                let maxWeight = 0;
                                
                                if (this.evolutionFilter === 'specific' && this.selectedExercise) {
                                    // Ejercicio específico
                                    Object.keys(workout.exercisesData).forEach(muscle => {
                                        workout.exercisesData[muscle].forEach(exercise => {
                                            if (exercise.name === this.selectedExercise && exercise.setsData) {
                                                exercise.setsData.forEach(set => {
                                                    if (set.completed && set.weight > maxWeight) {
                                                        maxWeight = set.weight;
                                                        hasData = true;
                                                    }
                                                });
                                            }
                                        });
                                    });
                                } 
                                else if (this.evolutionFilter.startsWith('muscle_')) {
                                    // Músculo específico
                                    const muscleKey = this.evolutionFilter.replace('muscle_', '');
                                    if (workout.exercisesData[muscleKey]) {
                                        workout.exercisesData[muscleKey].forEach(exercise => {
                                            if (exercise.setsData) {
                                                exercise.setsData.forEach(set => {
                                                    if (set.completed && set.weight > maxWeight) {
                                                        maxWeight = set.weight;
                                                        hasData = true;
                                                    }
                                                });
                                            }
                                        });
                                    }
                                }
                                else {
                                    // Todos los datos
                                    Object.keys(workout.exercisesData).forEach(muscle => {
                                        workout.exercisesData[muscle].forEach(exercise => {
                                            if (exercise.setsData) {
                                                exercise.setsData.forEach(set => {
                                                    if (set.completed && set.weight > maxWeight) {
                                                        maxWeight = set.weight;
                                                        hasData = true;
                                                    }
                                                });
                                            }
                                        });
                                    });
                                }
                                value = maxWeight;
                                label = 'Peso Máximo (kg)';
                                break;

                            case 'reps':
                                // REPETICIONES MÁXIMAS - CORREGIDO
                                let maxReps = 0;
                                
                                if (this.evolutionFilter === 'specific' && this.selectedExercise) {
                                    // Ejercicio específico
                                    Object.keys(workout.exercisesData).forEach(muscle => {
                                        workout.exercisesData[muscle].forEach(exercise => {
                                            if (exercise.name === this.selectedExercise && exercise.setsData) {
                                                exercise.setsData.forEach(set => {
                                                    if (set.completed && set.reps > maxReps) {
                                                        maxReps = set.reps;
                                                        hasData = true;
                                                    }
                                                });
                                            }
                                        });
                                    });
                                } 
                                else if (this.evolutionFilter.startsWith('muscle_')) {
                                    // Músculo específico
                                    const muscleKey = this.evolutionFilter.replace('muscle_', '');
                                    if (workout.exercisesData[muscleKey]) {
                                        workout.exercisesData[muscleKey].forEach(exercise => {
                                            if (exercise.setsData) {
                                                exercise.setsData.forEach(set => {
                                                    if (set.completed && set.reps > maxReps) {
                                                        maxReps = set.reps;
                                                        hasData = true;
                                                    }
                                                });
                                            }
                                        });
                                    }
                                }
                                else {
                                    // Todos los datos
                                    Object.keys(workout.exercisesData).forEach(muscle => {
                                        workout.exercisesData[muscle].forEach(exercise => {
                                            if (exercise.setsData) {
                                                exercise.setsData.forEach(set => {
                                                    if (set.completed && set.reps > maxReps) {
                                                        maxReps = set.reps;
                                                        hasData = true;
                                                    }
                                                });
                                            }
                                        });
                                    });
                                }
                                value = maxReps;
                                label = 'Repeticiones Máximas';
                                break;

                            case 'consistency':
                                // CONSISTENCIA - usa todos los datos
                                if (workout.sets > 0) {
                                    value = Math.round((workout.completedSets / workout.sets) * 100);
                                    hasData = true;
                                }
                                label = 'Tasa de Completado (%)';
                                break;
                        }

                        // Solo añadir datos si hay valores válidos
                        if (hasData && value >= 0) {
                            labels.push(this.formatDateShort(workout.date));
                            values.push(value);
                            console.log(`Añadido punto: ${this.formatDateShort(workout.date)} - ${value}`);
                        }
                    });

                    // Personalizar etiqueta según el filtro
                    if (this.evolutionFilter === 'specific' && this.selectedExercise) {
                        label = `${this.selectedExercise} - ${label}`;
                    } else if (this.evolutionFilter.startsWith('muscle_')) {
                        const muscleKey = this.evolutionFilter.replace('muscle_', '');
                        const muscle = this.muscleGroups.find(m => m.key === muscleKey);
                        if (muscle) {
                            label = `${muscle.label} - ${label}`;
                        }
                    }

                    console.log('Datos finales del gráfico:', {
                        labels: labels.length,
                        values: values.length,
                        label: label
                    });

                    return { labels, values, label };
                },
                
                calculateProgress() {
                    const chartData = this.prepareEvolutionData();
                    const values = chartData.values.filter(v => v > 0);
                    if (values.length === 0) {
                        return {
                            current: 0,
                            best: 0,
                            progress: 0,
                            consistency: 0
                        };
                    }
                    const current = values[values.length - 1];
                    const best = Math.max(...values);
                    const initial = values[0];
                    let progress = 0;
                    if (initial > 0) {
                        progress = Math.round(((current - initial) / initial) * 100);
                    }
                    const totalDays = Math.ceil((new Date() - new Date(this.workoutHistory[0].date)) / (1000 * 60 * 60 * 24));
                    const consistency = totalDays > 0 ? Math.round((this.workoutHistory.length / totalDays) * 100) : 0;
                    return {
                        current: current,
                        best: best,
                        progress: progress,
                        consistency: consistency
                    };
                },
                exportProgressReport() {
                    const progress = this.calculateProgress();
                    const chartData = this.prepareEvolutionData();
                    const report = {
                        title: `Reporte de Progreso - ${new Date().toLocaleDateString()}`,
                        metric: this.selectedMetric,
                        filter: this.evolutionFilter,
                        currentValue: progress.current,
                        bestValue: progress.best,
                        progress: `${progress.progress}%`,
                        consistency: `${progress.consistency}%`,
                        data: chartData.values.map((value, index) => ({
                            date: chartData.labels[index],
                            value: value
                        }))
                    };
                    const dataStr = JSON.stringify(report, null, 2);
                    const dataUri = 'application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    const exportFileDefaultName = `progress_report_${new Date().toISOString().slice(0,10)}.json`;
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                },
                getAllUniqueExercises() {
                    const exercises = new Set();
                    
                    this.workoutHistory.forEach(workout => {
                        if (workout.exercisesData) {
                            Object.values(workout.exercisesData).forEach(muscleExercises => {
                                muscleExercises.forEach(exercise => {
                                    if (exercise.name && exercise.name.trim() !== '') {
                                        exercises.add(exercise.name);
                                    }
                                });
                            });
                        }
                    });
                    
                    return Array.from(exercises).sort();
                },
                changeMetric(metric) {
                    this.selectedMetric = metric;
                    console.log('Cambiando métrica a:', metric);
                    this.updateChart();
                },
                changeEvolutionFilter(filter) {
                    this.evolutionFilter = filter;
                    // Resetear ejercicio específico si no es el filtro correspondiente
                    if (filter !== 'specific') {
                        this.selectedExercise = '';
                    }
                    console.log('Cambiando filtro a:', filter);
                    this.updateChart();
                },
                getTrainingPeriod() {
                    if (this.workoutHistory.length < 2) return "0 días";
                    const firstDate = new Date(this.workoutHistory[0].date);
                    const lastDate = new Date(this.workoutHistory[this.workoutHistory.length - 1].date);
                    const days = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24));
                    if (days < 30) return `${days} días`;
                    if (days < 365) return `${Math.round(days / 30)} meses`;
                    return `${Math.round(days / 365)} años`;
                },

                // ==================================================
                // 12. UTILIDADES Y FUNCIONES AUXILIARES
                // ==================================================
                getMuscleLabel(muscleKey) {
                    const muscle = this.muscleGroups.find(m => m.key === muscleKey);
                    return muscle ? muscle.label : muscleKey;
                },
                formatTime(seconds) {
                    if (seconds === undefined || seconds === null) {
                        seconds = 0;
                    }
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                },
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                formatDateShort(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                },
                playCompletionSound() {
                    if (!this.soundEnabled) return;
                    try {
                        if (!this.audioContext) {
                            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        }
                        const oscillator = this.audioContext.createOscillator();
                        const gainNode = this.audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(this.audioContext.destination);
                        oscillator.frequency.setValueAtTime(800, this.audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(600, this.audioContext.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                        oscillator.start(this.audioContext.currentTime);
                        oscillator.stop(this.audioContext.currentTime + 0.3);
                    } catch (error) {
                        console.log('Error reproduciendo sonido:', error);
                    }
                },
                saveSoundPreference() {
                    this.saveToLocalStorage();
                },

                // Función para eliminar un músculo de un día específico
                removeMuscleFromDay(dayName, muscleToRemove) {
                    if (confirm(`¿Estás seguro de que quieres eliminar el grupo muscular "${muscleToRemove}" del ${dayName}? Esto también eliminará todos sus ejercicios.`)) {
                        // Encontrar el día en el plan
                        const dayIndex = this.currentPlan.findIndex(d => d.dayName === dayName);
                        if (dayIndex !== -1) {
                            // Filtrar el músculo
                            this.currentPlan[dayIndex].muscles = this.currentPlan[dayIndex].muscles.filter(muscle => muscle !== muscleToRemove);
                            // Filtrar los ejercicios asociados a ese músculo
                            this.currentPlan[dayIndex].exercises = this.currentPlan[dayIndex].exercises.filter(ex => ex.muscle !== muscleToRemove);
                            // Guardar cambios
                            localStorage.setItem("gymApp_currentPlan", JSON.stringify(this.currentPlan));
                            alert(`Grupo muscular "${muscleToRemove}" eliminado del ${dayName}.`);
                        }
                    }
                },

                // Función para mostrar el modal de añadir músculo (por ahora es un alert, puedes mejorarlo)
                showAddMuscleModal(dayName) {
                    const muscle = prompt("Introduce el nombre del grupo muscular a añadir (chest, back, legs, etc.):");
                    if (muscle && muscle.trim() !== '') {
                        const muscleKey = muscle.trim().toLowerCase();
                        // Verificar que el músculo existe en muscleGroups
                        if (this.muscleGroups.find(m => m.key === muscleKey)) {
                            const dayIndex = this.currentPlan.findIndex(d => d.dayName === dayName);
                            if (dayIndex !== -1) {
                                // Añadir el músculo si no existe ya
                                if (!this.currentPlan[dayIndex].muscles.includes(muscleKey)) {
                                    this.currentPlan[dayIndex].muscles.push(muscleKey);
                                    // Añadir algunos ejercicios básicos para ese músculo
                                    const exercises = this.selectExercisesForMuscle(muscleKey, 2); // 2 ejercicios por defecto
                                    exercises.forEach(exerciseName => {
                                        this.currentPlan[dayIndex].exercises.push({
                                            name: exerciseName,
                                            muscle: muscleKey,
                                            type: 'normal',
                                            sets: 3,
                                            reps: 10,
                                            rest: 90
                                        });
                                    });
                                    // Guardar cambios
                                    localStorage.setItem("gymApp_currentPlan", JSON.stringify(this.currentPlan));
                                    alert(`Grupo muscular "${muscleKey}" añadido al ${dayName}.`);
                                } else {
                                    alert(`El grupo muscular "${muscleKey}" ya está en el ${dayName}.`);
                                }
                            }
                        } else {
                            alert(`El grupo muscular "${muscleKey}" no es válido. Usa: chest, back, legs, shoulders, biceps, triceps, abs, traps.`);
                        }
                    }
                },

                // ==================================================
                // 13. GESTIÓN AVANZADA (EXPORTAR, IMPORTAR, RESET)
                // ==================================================
                toggleAdvancedMenu() {
                    this.showAdvancedMenu = !this.showAdvancedMenu;
                },
                // REEMPLAZAR la función exportData con esta versión corregida
                exportData() {
                    try {
                        console.log('=== EXPORTANDO DATOS ===');
                        
                        // Preparar todos los datos para exportar
                        const exportData = {
                            workoutHistory: this.workoutHistory,
                            workoutGroups: this.workoutGroups,
                            customExercises: {
                                exercises: this.exercisesByMuscle,
                                customMuscles: this.customMuscles,
                                muscleGroups: this.muscleGroups
                            },
                            userPreferences: {
                                userLevel: this.userLevel,
                                soundEnabled: this.soundEnabled,
                                restTimerConfig: this.restTimerConfig
                            },
                            exportInfo: {
                                version: '1.0',
                                exportDate: new Date().toISOString(),
                                totalWorkouts: this.workoutHistory.length,
                                totalRoutines: this.workoutGroups.length
                            }
                        };

                        // Convertir a JSON
                        const dataStr = JSON.stringify(exportData, null, 2);
                        
                        // Crear blob y descargar
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        
                        // Crear enlace de descarga
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = `gymapp_backup_${new Date().toISOString().split('T')[0]}.json`;
                        
                        // Trigger la descarga
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Liberar memoria
                        URL.revokeObjectURL(url);
                        
                        console.log('✅ Datos exportados correctamente');
                        alert('✅ Datos exportados correctamente. Archivo descargado: ' + link.download);
                        
                    } catch (error) {
                        console.error('❌ Error exportando datos:', error);
                        alert('❌ Error al exportar datos: ' + error.message);
                    }
                },

                // También verificar la función importData por si acaso
                importData() {
                    try {
                        // Crear input file
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = '.json';
                        
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                try {
                                    const importedData = JSON.parse(event.target.result);
                                    console.log('Datos importados:', importedData);
                                    
                                    if (confirm('¿Estás seguro de que quieres importar estos datos? Se sobrescribirán los datos actuales.')) {
                                        this.processImportedData(importedData);
                                    }
                                } catch (error) {
                                    console.error('Error parsing imported file:', error);
                                    alert('❌ Error: El archivo no es válido o está corrupto.');
                                }
                            };
                            
                            reader.readAsText(file);
                        };
                        
                        input.click();
                        
                    } catch (error) {
                        console.error('Error en importData:', error);
                        alert('❌ Error al importar datos: ' + error.message);
                    }
                },

                // AÑADIR función para procesar datos importados
                processImportedData(importedData) {
                    try {
                        console.log('=== PROCESANDO DATOS IMPORTADOS ===');
                        
                        // Validar estructura básica
                        if (!importedData || typeof importedData !== 'object') {
                            throw new Error('Estructura de datos inválida');
                        }
                        
                        // Restaurar workoutHistory
                        if (Array.isArray(importedData.workoutHistory)) {
                            this.workoutHistory = importedData.workoutHistory;
                            console.log('✅ Workout history restaurado:', this.workoutHistory.length);
                        }
                        
                        // Restaurar workoutGroups
                        if (Array.isArray(importedData.workoutGroups)) {
                            this.workoutGroups = importedData.workoutGroups;
                            console.log('✅ Workout groups restaurados:', this.workoutGroups.length);
                        }
                        
                        // Restaurar ejercicios personalizados
                        if (importedData.customExercises) {
                            const customData = importedData.customExercises;
                            
                            if (customData.exercises && typeof customData.exercises === 'object') {
                                // Combinar ejercicios existentes con importados
                                Object.keys(customData.exercises).forEach(muscle => {
                                    if (!this.exercisesByMuscle[muscle]) {
                                        this.exercisesByMuscle[muscle] = [];
                                    }
                                    customData.exercises[muscle].forEach(exercise => {
                                        if (!this.exercisesByMuscle[muscle].includes(exercise)) {
                                            this.exercisesByMuscle[muscle].push(exercise);
                                        }
                                    });
                                });
                            }
                            
                            if (Array.isArray(customData.customMuscles)) {
                                this.customMuscles = [...new Set([...this.customMuscles, ...customData.customMuscles])];
                            }
                            
                            if (Array.isArray(customData.muscleGroups)) {
                                // Añadir músculos personalizados que no existan
                                customData.muscleGroups.forEach(muscle => {
                                    const exists = this.muscleGroups.find(m => m.key === muscle.key);
                                    if (!exists) {
                                        this.muscleGroups.push(muscle);
                                    }
                                });
                            }
                            
                            console.log('✅ Ejercicios personalizados restaurados');
                        }
                        
                        // Restaurar preferencias
                        if (importedData.userPreferences) {
                            const prefs = importedData.userPreferences;
                            
                            if (prefs.userLevel) this.userLevel = prefs.userLevel;
                            if (prefs.soundEnabled !== undefined) this.soundEnabled = prefs.soundEnabled;
                            if (prefs.restTimerConfig) this.restTimerConfig = { ...this.restTimerConfig, ...prefs.restTimerConfig };
                            
                            console.log('✅ Preferencias de usuario restauradas');
                        }
                        
                        // Guardar en localStorage
                        this.saveToLocalStorage();
                        
                        // Recargar ejercicios personalizados
                        this.loadCustomExercises();
                        
                        alert('✅ Datos importados correctamente. La página se recargará.');
                        
                        // Recargar para aplicar cambios
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error procesando datos importados:', error);
                        alert('❌ Error al procesar datos importados: ' + error.message);
                    }
                },
                resetApp() {
                    if (confirm('¿Estás seguro de que quieres restablecer la aplicación? Se perderán todos tus datos.')) {
                        localStorage.clear();
                        location.reload();
                    }
                },
                openAdvancedManagementModal() {
                    this.selectedWorkoutsToDelete = [];
                    this.dateFilter = '';
                    this.sortFilter = 'newest';
                    this.currentDeletionMode = 'routine';
                },

                get filteredWorkoutsToDelete() {
                    let workouts = this.workoutHistory.filter(w => w.mode === 'manual');
                    if (this.dateFilter) {
                        const filterDate = new Date(this.dateFilter);
                        workouts = workouts.filter(workout => {
                            const workoutDate = new Date(workout.date);
                            return workoutDate.toDateString() === filterDate.toDateString();
                        });
                    }
                    if (this.sortFilter === 'newest') {
                        workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                    } else {
                        workouts.sort((a, b) => new Date(a.date) - new Date(b.date));
                    }
                    return workouts;
                },
                getTrainedMuscles(workout) {
                    if (!workout.exercisesData) return "Sin datos de músculos";
                    
                    const muscles = workout.order && workout.order.length ? workout.order : Object.keys(workout.exercisesData);
                    
                    // Si hay 3 o menos músculos, mostrar todos
                    if (muscles.length <= 3) {
                        const muscleLabels = muscles.map(muscle => {
                            const muscleGroup = this.muscleGroups.find(m => m.key === muscle);
                            return muscleGroup ? muscleGroup.label : muscle;
                        });
                        return muscleLabels.join(" + ");
                    }
                    // Si hay más de 3 músculos, mostrar los primeros 2 + "y X más"
                    else {
                        const firstMuscles = muscles.slice(0, 2).map(muscle => {
                            const muscleGroup = this.muscleGroups.find(m => m.key === muscle);
                            return muscleGroup ? muscleGroup.label : muscle;
                        });
                        return firstMuscles.join(" + ") + ` + ${muscles.length - 2} más`;
                    }
                },
                // Función CORREGIDA para obtener historial de ejercicios (orden correcto)
                getExerciseHistory(muscle, exerciseName, currentRoutineKey) {
                    console.log('=== OBTENIENDO HISTORIAL DE EJERCICIO ===');
                    console.log('Parámetros:', { muscle, exerciseName, currentRoutineKey });
                    
                    const history = [];
                    const currentWorkoutDate = this.viewedWorkout ? new Date(this.viewedWorkout.date) : null;
                    
                    // Recorrer todos los workouts en orden inverso (más reciente primero)
                    for (let i = this.workoutHistory.length - 1; i >= 0; i--) {
                        const workout = this.workoutHistory[i];
                        
                        // Saltar el workout actual que estamos viendo
                        if (currentWorkoutDate && new Date(workout.date).getTime() === currentWorkoutDate.getTime()) {
                            continue;
                        }
                        
                        // Filtrar por routineKey si se especifica
                        if (currentRoutineKey && workout.routineKey !== currentRoutineKey) {
                            continue;
                        }
                        
                        // Buscar el ejercicio en el workout
                        if (workout.exercisesData && workout.exercisesData[muscle]) {
                            for (const exercise of workout.exercisesData[muscle]) {
                                if (exercise.name === exerciseName) {
                                    history.push({
                                        date: workout.date,
                                        volume: exercise.volume,
                                        setsData: exercise.setsData,
                                        workoutDate: workout.date,
                                        workoutIndex: i
                                    });
                                    break; // Solo un ejercicio por workout
                                }
                            }
                        }
                        
                        // Limitar a 3 ejecuciones anteriores máximo
                        if (history.length >= 3) {
                            break;
                        }
                    }
                    
                    console.log(`Historial encontrado: ${history.length} ejecuciones anteriores`);
                    
                    // Ya están en orden descendente (más reciente primero) por el loop inverso
                    return history;
                },
                // Función CORREGIDA para contar ejecuciones anteriores
                getExerciseHistoryCount(muscle, exerciseName, routineKey) {
                    const currentWorkoutDate = this.viewedWorkout ? new Date(this.viewedWorkout.date) : null;
                    let count = 0;
                    
                    for (let i = this.workoutHistory.length - 1; i >= 0; i--) {
                        const workout = this.workoutHistory[i];
                        
                        // Saltar el workout actual
                        if (currentWorkoutDate && new Date(workout.date).getTime() === currentWorkoutDate.getTime()) {
                            continue;
                        }
                        
                        // Filtrar por routineKey si se especifica
                        if (routineKey && workout.routineKey !== routineKey) {
                            continue;
                        }
                        
                        if (workout.exercisesData && workout.exercisesData[muscle]) {
                            for (const exercise of workout.exercisesData[muscle]) {
                                if (exercise.name === exerciseName) {
                                    count++;
                                    break;
                                }
                            }
                        }
                    }
                    
                    return count;
                },

                // ==================================================
                // 14. ESTADÍSTICAS
                // ==================================================
                get totalHistorySets() {
                    return this.workoutHistory.reduce((total, workout) => total + workout.sets, 0);
                },
                get totalHistoryVolume() {
                    return this.workoutHistory.reduce((total, workout) => total + workout.totalVolume, 0);
                },
                calculateMuscleProgress(muscleKey) {
                    let totalVolume = 0;
                    for (const workout of this.workoutHistory) {
                        if (workout.exercisesData[muscleKey]) {
                            for (const exercise of workout.exercisesData[muscleKey]) {
                                totalVolume += exercise.volume;
                            }
                        }
                    }
                    return totalVolume;
                },
                hasDataForMuscle(muscleKey) {
                    return this.workoutHistory.some(workout => workout.exercisesData[muscleKey]);
                },

                getRoutineExercisesSummary(workout) {
                    if (!workout.exercisesData) return "Sin información de ejercicios";
                    const exercises = [];
                    workout.order && workout.order.length ? workout.order : Object.keys(workout.exercisesData).forEach(muscle => {
                        workout.exercisesData[muscle].forEach(exercise => {
                            exercises.push(`${exercise.name} (${exercise.sets} series)`);
                        });
                    });
                    return exercises.slice(0, 3).join(', ') + (exercises.length > 3 ? '...' : '');
                },

                // ==================================================
                // 15. FUNCIONES PARA EL CENTRO DE ENTRENAMIENTO IA
                // ==================================================
                manageExistingPlans() {
                    this.currentScreen = 'manage-ai-plans';
                },
                recoverRoutine(routine) {
                    // Cargar la rutina seleccionada en currentWeek
                    this.currentWeek = routine.plan;
                    this.trainingDays = Object.keys(routine.plan);
                    this.trainingGoal = routine.goal;
                    this.userLevel = routine.level;
                },
                adjustRoutine(routine) {
                    // Aquí iría la lógica para ajustar la rutina (cambiar ejercicios, etc.)
                    alert('Funcionalidad de "Ajustar Rutina" en desarrollo.');
                },
                superchargeRoutine(routine) {
                    // Aquí iría la lógica para "superar" la rutina (aumentar pesos, series, etc.)
                    alert('Funcionalidad de "Superar Rutina" en desarrollo.');
                },

                // =============== FUNCIONES DEL ASISTENTE CONVERSACIONAL IA ===============
                startAIChat() {
                    this.isChatActive = true;
                    this.currentStep = 0;
                    this.chatMessages = [];
                    this.userProfile = { goal: '', daysPerWeek: 0, preferredMuscles: [], limitations: '', level: '' };
                    this.startTypingQuestion();
                },

                getChatQuestions() {
                    return [
                        {
                            question: "¡Hola! 👋 Soy tu asistente de entrenamiento inteligente. ¿Cuál es tu objetivo principal?",
                            options: ["Hipertrofia (aumentar músculo)", "Fuerza (levantar más peso)", "Resistencia (más repeticiones)"],
                            key: "goal"
                        },
                        {
                            question: "¿Cuántos días a la semana puedes entrenar consistentemente?",
                            options: ["2 días", "3 días", "4 días", "5 días", "6 días"],
                            key: "daysPerWeek"
                        },
                        {
                            question: "¿Qué grupos musculares te gustaría priorizar o trabajar con más frecuencia?",
                            options: ["Pecho", "Espalda", "Piernas", "Hombros", "Bíceps", "Tríceps", "Abdominales", "Trapecio"],
                            key: "preferredMuscles",
                            multiSelect: true
                        },
                        {
                            question: "¿Tienes alguna lesión, limitación física o ejercicio que deba evitar?",
                            type: "text",
                            key: "limitations"
                        },
                        {
                            question: "¿Cuál es tu nivel de experiencia?",
                            options: ["Principiante (0-1 año)", "Intermedio (1-3 años)", "Avanzado (3+ años)"],
                            key: "level"
                        }
                    ];
                },

                startTypingQuestion() {
                    const questions = this.getChatQuestions();
                    if (this.currentStep < questions.length) {
                        const currentQuestion = questions[this.currentStep];
                        this.isTyping = true;
                        this.currentTypingText = currentQuestion.question;
                        this.typingIndex = 0;
                        this.typeCharacter();
                    } else {
                        this.generatePlanFromProfile();
                    }
                },

                typeCharacter() {
                    if (this.typingIndex < this.currentTypingText.length) {
                        this.typingIndex++;
                        setTimeout(() => {
                            this.typeCharacter();
                        }, this.typingSpeed);
                    } else {
                        this.isTyping = false;
                        // Añadir la pregunta completa al historial
                        const questions = this.getChatQuestions();
                        const currentQuestion = questions[this.currentStep];
                        this.chatMessages.push({
                            sender: 'ia',
                            text: currentQuestion.question,
                            options: currentQuestion.options || [],
                            type: currentQuestion.type || 'options',
                            step: this.currentStep
                        });
                    }
                },

                handleUserResponse(response) {
                    const questions = this.getChatQuestions();
                    const currentQuestion = questions[this.currentStep];
                    
                    if (currentQuestion.multiSelect && Array.isArray(response)) {
                        this.userProfile[currentQuestion.key] = response;
                    } else if (currentQuestion.type === 'text') {
                        this.userProfile[currentQuestion.key] = response;
                    } else {
                        this.userProfile[currentQuestion.key] = response;
                    }
                    
                    this.chatMessages.push({
                        sender: 'user',
                        text: response,
                        step: this.currentStep
                    });
                    
                    this.currentStep++;
                    this.startTypingQuestion();
                },

                goBackStep() {
                    if (this.currentStep > 0) {
                        this.currentStep--;
                        // Eliminar la última respuesta del usuario
                        this.chatMessages = this.chatMessages.filter(msg => !(msg.sender === 'user' && msg.step === this.currentStep));
                        // Eliminar la última pregunta de la IA
                        this.chatMessages = this.chatMessages.filter(msg => !(msg.sender === 'ia' && msg.step === this.currentStep));
                        // Reiniciar la respuesta para esta pregunta
                        const questions = this.getChatQuestions();
                        const currentQuestion = questions[this.currentStep];
                        if (currentQuestion.multiSelect) {
                            this.userProfile[currentQuestion.key] = [];
                        } else {
                            this.userProfile[currentQuestion.key] = '';
                        }
                        // Volver a escribir la pregunta
                        this.startTypingQuestion();
                    }
                },

                generatePlanFromProfile() {
                    // Extraer datos del perfil del usuario
                    const availableDays = parseInt(this.userProfile.daysPerWeek.split(' ')[0]);
                    const goal = this.userProfile.goal.split(' ')[0];
                    const level = this.userProfile.level.split(' ')[0];

                    // Validar datos
                    if (!availableDays || !goal || !level) {
                        this.chatMessages.push({
                            sender: 'ia',
                            text: "Lo siento, no pude generar un plan. Por favor, asegúrate de responder todas las preguntas."
                        });
                        return;
                    }

                    // Crear plan
                    let plan = {};
                    const days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];

                    // Definir split de músculos según días
                    let muscleSplit = {};
                    if (availableDays === 3) {
                        muscleSplit = {
                            "Lunes": ["Pecho", "Tríceps", "Hombros"],
                            "Miércoles": ["Piernas", "Abdominales"],
                            "Viernes": ["Espalda", "Bíceps", "Trapecio"]
                        };
                    } else if (availableDays === 4) {
                        muscleSplit = {
                            "Lunes": ["Pecho", "Tríceps"],
                            "Martes": ["Piernas", "Abdominales"],
                            "Jueves": ["Espalda", "Bíceps"],
                            "Viernes": ["Hombros", "Trapecio"]
                        };
                    } else if (availableDays >= 5) {
                        muscleSplit = {
                            "Lunes": ["Pecho"],
                            "Martes": ["Piernas"],
                            "Miércoles": ["Espalda"],
                            "Jueves": ["Hombros", "Trapecio"],
                            "Viernes": ["Bíceps", "Tríceps", "Abdominales"]
                        };
                    }

                    // Asignar días reales
                    let dayIndex = 0;
                    const availableDayNames = days.filter(day => {
                        return dayIndex++ < availableDays;
                    }).slice(0, availableDays);

                    dayIndex = 0;
                    for (let day of availableDayNames) {
                        if (dayIndex < Object.keys(muscleSplit).length) {
                            const splitKey = Object.keys(muscleSplit)[dayIndex];
                            plan[day] = {
                                muscles: muscleSplit[splitKey],
                                exercises: {}
                            };
                            muscleSplit[splitKey].forEach(muscle => {
                                const muscleKey = this.getMuscleKeyFromLabel(muscle);
                                const availableExercises = this.exercisesByMuscle[muscleKey] || [];
                                const exerciseCount = level === 'Principiante' ? 2 : level === 'Intermedio' ? 3 : 4;
                                plan[day].exercises[muscleKey] = availableExercises.slice(0, exerciseCount);
                            });
                            dayIndex++;
                        }
                    }

                    // Mostrar mensaje final
                    this.chatMessages.push({
                        sender: 'ia',
                        text: `¡Perfecto! 🎯 He generado tu plan semanal. Puedes verlo y empezar a entrenar.`
                    });

                    // Guardar el plan en el estado
                    this.aiWorkoutPlan = { week1: plan };
                    this.currentWeek = plan;
                    this.trainingDays = Object.keys(plan);
                    this.trainingGoal = goal.toLowerCase();
                    this.userLevel = level.toLowerCase();

                    // Redirigir después de un pequeño retraso
                    setTimeout(() => {
                        this.isChatActive = false;
                    }, 2000);
                },

                getMuscleKeyFromLabel(label) {
                    const mapping = {
                        "Pecho": "chest",
                        "Espalda": "back",
                        "Piernas": "legs",
                        "Hombros": "shoulders",
                        "Bíceps": "biceps",
                        "Tríceps": "triceps",
                        "Abdominales": "abs",
                        "Trapecio": "traps"
                    };
                    return mapping[label] || "chest";
                },

                // Función para volver al historial correcto
                goBackToHistory() {
                    if (this.viewedWorkout.mode === 'ai') {
                        this.currentScreen = 'history-ia';
                    } else {
                        this.currentScreen = 'history-manual';
                    }
                },


                // En la sección de estadísticas del historial vacío, actualizar los cálculos:
                getHistoryStats() {
                    const workoutsInRoutines = new Set();
                    this.workoutGroups.forEach(group => {
                        if (group.workouts && Array.isArray(group.workouts)) {
                            group.workouts.forEach(index => {
                                if (index >= 0 && index < this.workoutHistory.length) {
                                    workoutsInRoutines.add(index);
                                }
                            });
                        }
                    });
                    
                    const soloWorkouts = this.workoutHistory.filter((w, idx) => 
                        !workoutsInRoutines.has(idx)
                    );
                    
                    return {
                        total: this.workoutHistory.length,
                        inRoutines: workoutsInRoutines.size,
                        solo: soloWorkouts.length,
                        routineGroups: this.workoutGroups.length
                    };
                },
                
                // AÑADIR o REEMPLAZAR esta función
                getGroupedManualWorkouts() {
                    console.log('=== OBTENIENDO WORKOUTS MANUALES AGRUPADOS ===');
                    
                    // 1. Obtener índices de workouts que están en rutinas
                    const workoutsInRoutines = new Set();
                    this.workoutGroups.forEach(group => {
                        if (group.workouts && Array.isArray(group.workouts)) {
                            group.workouts.forEach(index => {
                                if (index >= 0 && index < this.workoutHistory.length) {
                                    workoutsInRoutines.add(index);
                                }
                            });
                        }
                    });

                    console.log('Workouts en rutinas:', Array.from(workoutsInRoutines));

                    // 2. Obtener workouts manuales que NO están en rutinas
                    const soloWorkouts = this.workoutHistory
                        .map((w, idx) => ({ ...w, originalIndex: idx }))
                        .filter(w => !workoutsInRoutines.has(w.originalIndex) && w.mode === 'manual');

                    console.log('Workouts sueltos manuales:', soloWorkouts.length);

                    // 3. Agrupar por routineKey
                    const groups = {};
                    soloWorkouts.forEach(workout => {
                        const key = workout.routineKey || 'unknown';
                        if (!groups[key]) {
                            groups[key] = {
                                routineKey: key,
                                representative: workout,
                                allWorkouts: [workout],
                                workoutIndices: [workout.originalIndex],
                                count: 1,
                                latestDate: workout.date,
                                latestExercises: workout.exercises,
                                latestSets: workout.sets,
                                latestVolume: workout.totalVolume,
                                exercisesList: this.getExercisesListFromWorkout(workout)
                            };
                        } else {
                            groups[key].allWorkouts.push(workout);
                            groups[key].workoutIndices.push(workout.originalIndex);
                            groups[key].count++;
                            // Mantener el más reciente
                            if (new Date(workout.date) > new Date(groups[key].latestDate)) {
                                groups[key].representative = workout;
                                groups[key].latestDate = workout.date;
                                groups[key].latestExercises = workout.exercises;
                                groups[key].latestSets = workout.sets;
                                groups[key].latestVolume = workout.totalVolume;
                                groups[key].exercisesList = this.getExercisesListFromWorkout(workout);
                            }
                        }
                    });

                    const result = Object.values(groups);
                    console.log('Grupos formados para rutinas:', result.length);
                    return result;
                },
            };
        }
    </script>
</body>
</html>
